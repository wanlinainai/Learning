# Ai è¶…çº§æ™ºèƒ½ä½“

## é¡¹ç›®ä»‹ç»

### å¤§çº²-é¡¹ç›®ä¼˜åŠ¿

æŒæ¡çŸ¥è¯†:

- AI åº”ç”¨å¹³å°çš„ä½¿ç”¨
- æ¥å…¥AIå¤§æ¨¡å‹
- AIå¼€å‘æ¡†æ¶ï¼ˆSpringAI + LangChain4jï¼‰
- AIå¤§æ¨¡å‹æœ¬åœ°éƒ¨ç½²
- Promptå·¥ç¨‹å’Œä¼˜åŒ–æŠ€å·§
- å¤šæ¨¡æ€ç‰¹æ€§
- SpringAI æ ¸å¿ƒç‰¹æ€§ï¼šè‡ªå®šä¹‰æ‹¦æˆªå™¨ã€ä¸Šä¸‹æ–‡æŒä¹…åŒ–ã€ç»“æ„åŒ–è¾“å‡º
- RAGçŸ¥è¯†åº“å’Œå‘é‡æ•°æ®åº“
- Tool Calling å·¥å…·è°ƒç”¨
- MCPæ¨¡å‹ä¸Šä¸‹æ–‡åè®®å’ŒæœåŠ¡å¼€å‘
- AIæ™ºèƒ½ä½“ManusåŸç†å’Œè‡ªä¸»å¼€å‘
- AIæœåŠ¡åŒ–å’ŒServerlesséƒ¨ç½²

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–çš„ä¼˜åŠ¿ï¼š

- AIäº‘å¹³å°å’Œç¼–ç¨‹åŒç«¯å®æˆ˜ï¼Œä¸ä»…ä»…ä¼šç”¨AIæœåŠ¡ï¼Œè¿˜è¦ä¼šè‡ªå·±å†™ã€‚
- åŸºäºå®˜æ–¹æ–‡æ¡£è®²è§£æœ€æ–°çš„AIæŠ€æœ¯ï¼Œç»†è‡´å…¥å¾®ï¼Œæ‰‹æ’•æ–‡æ¡£å’Œæºç ã€‚
- åˆ†äº«å¤§é‡çš„AIæ‰©å±•çŸ¥è¯†å’Œç¼–ç¨‹æŠ€å·§ï¼ŒæŒæ¡æœ€ä½³å®è·µ

### é¡¹ç›®åŠŸèƒ½æ¢³ç†

æˆ‘ä»¬å¼€å‘ä¸€ä¸ªAIæ‹çˆ±æ™ºèƒ½åº”ç”¨ã€ä¸€ä¸ªæ‹¥æœ‰è‡ªä¸»è§„åˆ’èƒ½åŠ›çš„è¶…çº§æ™ºèƒ½ä½“ï¼Œä»¥åŠä¸€ç³»åˆ—çš„å·¥å…·Toolså’ŒMCPæœåŠ¡ã€‚

å…·ä½“çš„éœ€æ±‚å¦‚ä¸‹ï¼š

- AIæ‹çˆ±å¤§å¸ˆåº”ç”¨ï¼šç”¨æˆ·åœ¨æ‹çˆ±è¿‡ç¨‹ä¸­éš¾å…ä¼šé‡åˆ°å„ç§å„æ ·çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥è®©AIä¸ºç”¨æˆ·æä¾›è´´å¿ƒã€å‹çˆ±ã€æœ‰ç”¨çš„æƒ…æ„Ÿä»¥åŠå…¶ä»–æŒ‡å¯¼ã€‚æ”¯æŒå¤šè½®å¯¹è¯ã€å¯¹è¯è®°å¿†æŒä¹…åŒ–ã€RAGçŸ¥è¯†åº“æ£€ç´¢ã€å·¥å…·è°ƒç”¨ã€MCPæœåŠ¡è°ƒç”¨ã€‚
- AIè¶…çº§æ™ºèƒ½ä½“ï¼šå¯ä»¥æ ¹æ®ç”¨æˆ·çš„éœ€æ±‚ï¼Œè‡ªä¸»æ¨ç†å’Œè¡ŒåŠ¨ã€ç›´åˆ°å®Œæˆç›®æ ‡ã€‚
- æä¾›ç»™AIçš„å·¥å…·ï¼šè”ç½‘æœç´¢ã€æ–‡ä»¶æ“ä½œã€ç½‘é¡µæŠ“å–ã€èµ„æºä¸‹è½½ã€ç»ˆç«¯æ“ä½œã€PDFç”Ÿæˆã€‚
- AI MCPæœåŠ¡ï¼šå¯ä»¥ä»ç‰¹å®šçš„ç½‘ç«™æœç´¢ã€‚

![image-20250429225605195](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250429225605195.png)

### æŠ€æœ¯é€‰å‹

é¡¹ç›®ä»¥SpringAIå¼€å‘æ¡†æ¶ä¸ºæ ¸å¿ƒï¼Œæ¶‰åŠåˆ°å¤šç§ä¸»æµçš„AIå®¢æˆ·ç«¯å’Œå·¥å…·åº“çš„ä½¿ç”¨ã€‚

- java21 + SpringBoot 3æ¡†æ¶
- RAGçŸ¥è¯†åº“
- PGvectorå‘é‡æ•°æ®åº“
- Tool Callingå·¥å…·è°ƒç”¨
- MCP æ¨¡å‹ä¸Šä¸‹æ–‡åè®®
- React Agentæ™ºèƒ½ä½“çš„æ„å»º
- ServerLessè®¡ç®—æœåŠ¡
- AI å¤§æ¨¡å‹å¼€å‘å¹³å°ç™¾ç‚¼
- Cursor AIä»£ç ç”Ÿæˆ + MCP 
- ç¬¬ä¸‰æ–¹æ¥å£ï¼šå¦‚SearchAPI/Pexels APIï¼ˆåè€…æ˜¯ä¸€ä¸ªå…è´¹çš„å›¾ç‰‡ç´ æç½‘ï¼ŒåŸå›¾ç´ æï¼‰
- Ollamaå¤§æ¨¡å‹éƒ¨ç½²
- Kryoé«˜æ€§èƒ½åºåˆ—åŒ–
- Jsoupç½‘é¡µæŠ“å–
- iText PDFç”Ÿæˆ
- Knife4J æ¥å£æ–‡æ¡£

### æ¶æ„å›¾

![image-20250429230432194](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250429230432194.png)

## AI å¤§æ¨¡å‹æ¥å…¥

### å¤§æ¨¡å‹æ¦‚å¿µ

#### ä»€ä¹ˆæ˜¯AIå¤§æ¨¡å‹ï¼Ÿ

AIå¤§æ¨¡å‹æŒ‡çš„æ˜¯å…·æœ‰è¶…å¤§è§„æ¨¡å‚æ•°ï¼ˆé€šå¸¸æ˜¯åäº¿åˆ°æ•°ä¸‡äº¿ï¼‰çš„æ·±åº¦å­¦ä¹ æ¨¡å‹ã€‚é€šè¿‡å¯¹å¤§æ¨¡å‹æ•°æ®çš„è®­ç»ƒï¼Œèƒ½å¤Ÿç†è§£ã€ç”Ÿæˆäººç±»è¯­è¨€ï¼Œå¤„ç†å›¾åƒã€éŸ³é¢‘ç­‰å¤šç§æ¨¡æ€æ•°æ®ã€‚

å¤§æ¨¡å‹çš„å¼ºå¤§ä¹‹å¤„åœ¨äºä»–çš„**æ¶Œç°èƒ½åŠ›**ï¼Œéšç€æ¨¡å‹å‚æ•°æ•°é‡å’Œè®­ç»ƒæ•°æ®é›†çš„å¢åŠ ï¼Œæ¨¡å‹ä¼šå±•ç°å‡ºè®­ç»ƒè¿‡ç¨‹ä¸­æœªæ˜ç¡®èµ‹äºˆçš„æ–°èƒ½åŠ›ï¼Œæ¯”å¦‚é€»è¾‘æ¨ç†ã€ä»£ç ç¼–å†™ã€å¤šæ­¥éª¤é—®é¢˜è§£å†³ç­‰ã€‚

![image-20250607003057975](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250607003057975.png)

å¤§æ¨¡å‹ç™¾èŠ±é½æ”¾ï¼Œä¸¾ä¸€äº›ä¾‹å­ï¼š

OpenAI

- GPT-4oï¼ˆå¤šæ¨¡æ€ï¼‰
- GPT-4ï¼ˆæ–‡æœ¬ + å›¾åƒï¼‰
- GPT-3.5ï¼ˆå¤„ç†æ–‡æœ¬ï¼‰

Anthropic

- Claude 3ã€4ç³»åˆ—ï¼ˆOpusï¼ŒSonnetï¼ŒHaikuï¼Œç”±å¼ºåˆ°å¼±ï¼‰

Google

- Gemini Ultra/Pro/Nanoï¼ˆæ”¯æŒå¤šæ¨¡æ€ï¼‰

Meta

- Llama 3ï¼ˆå¼€æºï¼Œ70Bå’Œ8Bå‚æ•°ç‰ˆæœ¬ï¼‰
- Llama 2ï¼ˆå¼€æºï¼Œå¤šç§å‚æ•°è§„æ¨¡ï¼‰

å›½å†…

- ç™¾åº¦æ–‡å¿ƒä¸€è¨€ï¼ˆLJï¼‰
- é˜¿é‡Œé€šä¹‰åƒé—®
- å­—èŠ‚è±†åŒ…
- ç§‘å¤§è®¯é£æ˜Ÿç«

#### AIå¤§æ¨¡å‹åˆ†ç±»

1. æŒ‰æ¨¡æ€åˆ†ç±»
   - å•æ¨¡æ€æ¨¡å‹ï¼šåªèƒ½å¤„ç†å•ä¸€ç±»å‹çš„æ•°æ®ï¼Œå¦‚çº¯æ–‡æœ¬
   - å¤šæ¨¡æ€æ¨¡å‹ï¼šå¯å¤„ç†å¤šç§ç±»å‹çš„ä¿¡æ¯
2. å¼€æºæ€§åˆ†ç±»
   - **é—­æºæ¨¡å‹**ï¼šä¸å…¬å¼€æ¨¡å‹æƒé‡å’Œè®­ç»ƒæ–¹æ³•
   - ä»£è¡¨ï¼šGPTã€Claudeã€Gemini
   - ç‰¹ç‚¹ï¼šé€šå¸¸æ˜¯ä½¿ç”¨APIè®¿é—®ï¼Œä»˜è´¹ä½¿ç”¨
   - **å¼€æºæ¨¡å‹**ï¼šå…¬å¼€æ¨¡å‹æƒé‡ï¼Œå…è®¸ä¸‹è½½å’Œè‡ªè¡Œéƒ¨ç½²
   - ä»£è¡¨ï¼šLlamaç³»åˆ—ã€Mistralã€Falcon
   - å¯ä»¥æœ¬åœ°éƒ¨ç½²ã€è‡ªç”±è°ƒæ•´ï¼Œä½†æ˜¯é€šå¸¸èƒ½é€Šè‰²äºé—­æºçš„æ¨¡å‹
3. æŒ‰è§„æ¨¡åˆ†ç±»
   - **è¶…å¤§è§„æ¨¡ï¼ˆåƒäº¿åˆ°æ•°ä¸‡äº¿ï¼‰**
   - ä»£è¡¨ï¼šGPT-4
   - ç‰¹ç‚¹ï¼šèƒ½åŠ›å¼ºå¤§ï¼Œä½†æ˜¯éœ€è¦å¤§é‡çš„è®¡ç®—èµ„æº
   - **ä¸­å°è§„æ¨¡æ¨¡å‹ï¼ˆå‡ åäº¿åˆ°å‡ ç™¾äº¿ï¼‰**
   - ä»£è¡¨ï¼šLlama 3ï¼ˆ70Bï¼‰ã€Mistralï¼ˆ7Bï¼‰
   - ç‰¹ç‚¹ï¼šå¯åœ¨æ™®é€šç¡¬ä»¶ä¸Šè¿è¡Œï¼Œé€‚åˆç‰¹å®šä»»åŠ¡çš„ç²¾è°ƒ
4. æŒ‰ç”¨é€”åˆ†ç±»

	- **é€šç”¨æ¨¡å‹**ï¼šèƒ½å¤„ç†å¹¿æ³›ä»»åŠ¡
	- ä»£è¡¨ï¼šGPT-4ã€Claude 3ã€Gemini
	- **ç‰¹å®šé¢†åŸŸæ¨¡å‹ï¼š**é’ˆå¯¹äºç‰¹å®šé¢†åŸŸè¿›è¡Œä¼˜åŒ–
	- åŒ»ç–—ï¼šMed-PaLM 2
	- ä»£ç ï¼šCodeLlamaã€StarCoder
	- ç§‘å­¦ï¼šGalactica

#### å¯¹æ¯”ä¸åŒçš„æ¨¡å‹é€‰æ‹©

å¯å‚è€ƒLangchain4J:https://docs.langchain4j.dev/integrations/language-models/

Spring AI å¤§æ¨¡å‹çš„å¯¹æ¯”æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-ai/reference/api/chat/comparison.html

### æ¥å…¥AIå¤§æ¨¡å‹

#### ä½¿ç”¨å¤§æ¨¡å‹çš„ä¸¤ç§é€”å¾„

å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦æœ‰2ç§é€”å¾„æ¥ä½¿ç”¨å¤§æ¨¡å‹ï¼Œ**äº‘æœåŠ¡å’Œè‡ªéƒ¨ç½²**å„æœ‰ä¼˜ç¼ºã€‚

**äº‘æœåŠ¡**

ç›´æ¥ä½¿ç”¨äº‘å‚å•†åœ¨äº‘ç«¯å·²ç»éƒ¨ç½²å¥½çš„å¤§æ¨¡å‹æœåŠ¡ï¼Œæ— éœ€è‡ªå·±è€ƒè™‘åŸºç¡€è®¾æ–½ã€‚

**è‡ªéƒ¨ç½²**

å¼€å‘è€…è‡ªå·±åœ¨æœ¬åœ°æˆ–æˆ–ç§æœ‰äº‘ç¯å¢ƒéƒ¨ç½²å¼€æºçš„å¤§æ¨¡å‹ï¼Œç‰¹ç‚¹æ˜¯ï¼š

- å®Œå…¨æ§åˆ¶æ•°æ®æµï¼Œæ›´é«˜çš„æ•°æ®éšç§ä¿éšœ
- æ ¹æ®ç‰¹å®šéœ€æ±‚è¿›è¡Œå¾®è°ƒæ¨¡å‹å’Œå®šåˆ¶æ¨¡å‹
- æ— ç½‘ç»œå»¶è¿Ÿï¼Œé€‚åˆå¯¹å“åº”é€Ÿåº¦æœ‰ç€ä¸¥æ ¼è¦æ±‚çš„åœºæ™¯
- ä¸€æ¬¡æ€§æˆæœ¬å¤ªé«˜ï¼Œéœ€è¦ä¸“ä¸šçš„æŠ€æœ¯å›¢é˜Ÿç»´æŠ¤
- é€‚åˆä¼ä¸šçº§åº”ç”¨å’Œå¯¹æ•°æ®å®‰å…¨æœ‰ä¸¥æ ¼è¦æ±‚çš„åœºæ™¯

#### æ¥å…¥å¤§æ¨¡å‹çš„3ç§æ–¹å¼

**1ã€AIåº”ç”¨å¹³å°æ¥å…¥**

é€šè¿‡äº‘æœåŠ¡å•†æä¾›çš„AIåº”ç”¨å¹³å°æ¥ä½¿ç”¨AIå¤§æ¨¡å‹

ä»¥

[é˜¿é‡Œäº‘ç™¾ç‚¼]: https://bailian.console.aliyun.com/#/home	"é˜¿é‡Œäº‘ç™¾ç‚¼"

ä¸ºä¾‹ï¼Œè¿™æ˜¯ä¸€ç«™å¼çš„å¤§æ¨¡å‹å¼€å‘ä»¥åŠåº”ç”¨æ„å»ºå¹³å°ï¼Œä»–æä¾›äº†ä»æ¨¡å‹å¾®è°ƒåˆ°åº”ç”¨æ„å»ºçš„å…¨æµç¨‹æ”¯æŒã€‚

ä¸è®ºæ˜¯ä¸“ä¸šçš„å¼€å‘äººå‘˜è¿˜æ˜¯ä¸šåŠ¡äººå‘˜éƒ½å¯ä»¥é€šè¿‡ç®€å•çš„ç•Œé¢æ“ä½œï¼Œåœ¨5MINå†…å¼€å‘ä¸€æ¬¾å¤§æ¨¡å‹åº”ç”¨ã€‚æˆ–è€…åœ¨å‡ ä¸ªå°æ—¶å†…è®­ç»ƒå‡ºä¸“å±çš„æ¨¡å‹ã€‚

![image-20250607113227780](Ai è¶…çº§æ™ºèƒ½ä½“/image-20250607113227780.png)

å¯èƒ½åœ¨ä½¿ç”¨è¿™ä¸ªäº§å“çš„æ—¶å€™ï¼Œä¼šé‡åˆ°å¦ä¸€ä¸ªäº§å“ï¼ŒDashScopeï¼ˆæ¨¡å‹æœåŠ¡çµç§¯ï¼‰ï¼Œçµç§¯æ˜¯ä¸€ä¸ªAPIè°ƒç”¨çš„æœåŠ¡ï¼Œä¹‹åçš„å¼€å‘å·¥ä½œç»å¤§å¤šæ•°ä¼šä¸çµç§¯æ‰“äº¤é“ã€‚

åˆ©ç”¨aliyunç™¾ç‚¼æˆ‘ä»¬å¯ä»¥è½»æ¾çš„æ­å»ºAIå¤§æ¨¡å‹å’Œæ„å»ºAIåº”ç”¨ã€‚

1ï¼‰åˆ›å»ºè‡ªå·±çš„AIåº”ç”¨ï¼Œæ”¯æŒæ™ºèƒ½ä½“ã€å·¥ä½œæµå’Œæ™ºèƒ½ä½“ç¼–æ’åº”ç”¨ã€‚

æ²¡æœ‰2ï¼‰ã€‚

**2ã€AIè½¯ä»¶å®¢æˆ·ç«¯æ¥å…¥**

é™¤äº†å¹³å°ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡AIè½¯ä»¶å®¢æˆ·ç«¯æ¥ä½¿ç”¨å¤§æ¨¡å‹èƒ½åŠ›ï¼Œæ¨èä¸¤ä¸ªåº”ç”¨ï¼š

1ï¼‰Cherry Studioï¼šä¸€æ¬¾é›†å¤šæ¨¡å‹å¯¹è¯ã€çŸ¥è¯†åº“ç®¡ç†ã€AIç»˜ç”»ã€ç¿»è¯‘ç­‰åŠŸèƒ½äºä¸€ä½“çš„å…¨èƒ½AIåŠ©æ‰‹å¹³å°ã€‚Cherry Studioæä¾›é«˜åº¦è‡ªå®šä¹‰çš„è®¾è®¡ã€å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›å’Œæœ‰å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

2ï¼‰Cursorï¼šAIç¼–ç¨‹å¿…å¤‡å·¥å…·ã€‚åœ¨æœ¬é¡¹ç›®ä¸­ä¹Ÿä¼šé‡‡ç”¨Cursorç”Ÿæˆå‰ç«¯é¡¹ç›®ä»£ç ã€‚

**3ã€ç¨‹åºæ¥å…¥**

è°ƒç”¨å¤§æ¨¡å‹åˆ†æˆ2ç§æ–¹å¼ï¼š

1. ç›´æ¥è°ƒç”¨å¤§æ¨¡å‹çš„APIï¼Œæ¯”å¦‚ç›´æ¥è°ƒç”¨Deepseekï¼ˆæ›´åŠ åŸç”Ÿï¼‰
2. è°ƒç”¨å¤§æ¨¡å‹å¹³å°åˆ›å»ºçš„åº”ç”¨æˆ–è€…æ™ºèƒ½ä½“ï¼ˆæ›´æ–¹ä¾¿ï¼‰

ç¬¬ä¸€ç§æ–¹å¼ï¼Œä½¿ç”¨ç‰¹å®šå¹³å°æä¾›çš„SDKæˆ–APIï¼Œå‚è€ƒå¹³å°çš„æ–‡æ¡£æ¥è¿›è¡Œæ¥å…¥ï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨AIå¼€å‘æ¡†æ¶ï¼Œæ¯”å¦‚Spring AIã€SpringAI Alibabaã€LangChain4Jç­‰è‡ªä¸»é€‰æ‹©å¤§æ¨¡å‹è¿›è¡Œè°ƒç”¨ï¼Œå¯ä»¥çµæ´»åˆ‡æ¢ä½¿ç”¨çš„å¤§æ¨¡å‹å‡ ä¹ä¸éœ€è¦ä¿®æ”¹ä»£ç ã€‚

```yaml
spring: 
   ai: 
      dashscope:
          api-key: ${AI_DASHSCOPE_API_KEY}
          chat: 
          	options:
          		model: deepseek-r1
```

ç¬¬äºŒç§æ–¹å¼ï¼Œä¸€èˆ¬åªèƒ½ä½¿ç”¨ç‰¹å®šå¹³å°çš„SDKå’ŒAPIï¼Œå‚è€ƒå¹³å°ä»‹å…¥æ–‡æ¡£æ¥ä½¿ç”¨ã€‚

å¦‚æœæ˜¯ä¸ªäººçš„å°é¡¹ç›®ï¼Œç¬¬äºŒç§æ–¹å¼è‚¯èƒ½ä¼šæ›´æ–¹ä¾¿ï¼Œå› ä¸ºæŠŠå¤§å¤šæ•°åº”ç”¨æ„å»ºçš„æ“ä½œéƒ½æ”¾åœ¨äº†äº‘ç«¯å¯è§†åŒ–å¹³å°è€Œä¸æ˜¯é€šè¿‡ç¼–ç¨‹æ¥å®ç°ï¼›ä½†æ˜¯å¦‚æœæ˜¯ä¼ä¸šé¡¹ç›®çš„è¯ï¼Œæ›´æ¨èç¬¬ä¸€ç§æ–¹å¼ï¼Œç›´æ¥ç”¨Spring AI ç­‰å¼€å‘æ¡†æ¶è°ƒç”¨AI å¤§æ¨¡å‹ã€‚

### åç«¯é¡¹ç›®åˆå§‹åŒ–

#### ç¯å¢ƒå‡†å¤‡

å®‰è£…çš„JDKå¿…é¡»æ˜¯17æˆ–21ï¼Œä¸èƒ½ç”¨å…¶ä»–ç‰ˆæœ¬ï¼Œå› ä¸ºé¡¹ç›®ä½¿ç”¨çš„æ˜¯SpringBoot3å’ŒSpring AIå¼€å‘æ¡†æ¶

æ¨èä½¿ç”¨21ç‰ˆæœ¬ï¼Œæœ‰è™šæ‹Ÿçº¿ç¨‹è¿™ä¸ªç‹ç‚¸çš„åŠŸèƒ½ã€‚

##### pom.xml

åŸºç¡€çš„ä¾èµ–ï¼š

```xml
<dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.36</version>
            <optional>true</optional>
        </dependency>

        <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
            <version>5.8.37</version>
        </dependency>

        <dependency>
            <groupId>com.github.xiaoymin</groupId>
            <artifactId>knife4j-openapi3-jakarta-spring-boot-starter</artifactId>
            <version>4.4.0</version>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
```

#### ç¨‹åºè°ƒç”¨AI å¤§æ¨¡å‹

å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæœ‰å¾ˆå¤šç§æ–¹å¼å¯ä»¥ç”¨æ¥è°ƒç”¨AIå¤§æ¨¡å‹ã€‚ä»¥ä¸‹æ˜¯4ç§ä¸»æµçš„æ¥å…¥æ–¹å¼ï¼Œå¹¶é€šè¿‡ç¤ºä¾‹ä»£ç å±•ç¤ºå¦‚ä½•åœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº¤äº’ã€‚

1. SDKæ¥å…¥ï¼šä½¿ç”¨å®˜æ–¹æä¾›çš„SDKï¼ŒæŸ¥çœ‹æ–‡æ¡£å³å¯
2. HTTPæ¥å…¥ï¼šé€šè¿‡REST API ç›´æ¥å‘é€HTTP è¯·æ±‚è°ƒç”¨æ¨¡å‹
3. Spring AIï¼šåŸºäºSpringçš„ç”Ÿæ€ï¼Œæ›´åŠ æ–¹ä¾¿çš„æ¥å…¥å¤§æ¨¡å‹
4. LangChain4Jï¼šä¸“æ³¨äºæ„å»ºLLMåº”ç”¨çš„Javaæ¡†æ¶ï¼Œæä¾›ä¸°å¯Œçš„AIè°ƒç”¨ç»„ä»¶

æœ¬æ–‡é€‰ç”¨é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°è¿›è¡Œæ„å»ºã€‚

##### 1ã€SDKæ¥å…¥

###### 1ï¼‰æŒ‰ç…§å®˜æ–¹æ–‡æ¡£å®‰è£…SDKï¼šhttps://help.aliyun.com/zh/model-studio/install-sdk/

åœ¨é€‰æ‹©SDKçš„æ—¶å€™éœ€è¦æ³¨æ„Mavenç‰ˆæœ¬ã€‚

pom.xmlæ–‡ä»¶ä¸­æ·»åŠ ä¾èµ–ï¼š

```xml
     <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>dashscope-sdk-java</artifactId>
            <version>2.18.2</version>
        </dependency>
```

###### 2ï¼‰å…ˆåœ¨ç™¾ç‚¼å¹³å°ç”³è¯·ä¸€ä¸ªAPI Key

###### 3ï¼‰ é¡¹ç›®ä¸­æ–°å»º`demo.invoke`åŒ…ï¼Œé›†ä¸­å­˜æ”¾è°ƒç”¨AIå¤§æ¨¡å‹çš„å®ä¾‹ä»£ç 

å…·ä½“çš„æ–¹å¼å¯ä»¥å‚è€ƒæ–‡æ¡£ï¼šhttps://help.aliyun.com/zh/model-studio/use-qwen-by-calling-api#ab9194e9a55dk

![image-20250608222116870](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250608222116870.png)

æµ‹è¯•ä¸­ï¼Œä¸ºäº†å®‰å…¨ï¼Œæˆ‘ä»¬å°†API Keyä¿å­˜åœ¨æ¥å£ç±»ä¸­ã€‚

```java
public interface TestApiKey {

    String API_KEY = "";
}
```

ä½¿ç”¨SDK è°ƒç”¨æ¨¡å‹çš„å®Œæ•´ç¤ºä¾‹ä»£ç 

```java

public class SdkAiInvoke {

    public static GenerationResult callWithMessage() throws ApiException, NoApiKeyException, InputRequiredException {
        Generation gen = new Generation();
        Message systemMsg = Message.builder()
                .role(Role.SYSTEM.getValue())
                .content("You are a helpful assistant.")
                .build();
        Message userMsg = Message.builder()
                .role(Role.USER.getValue())
                .content("ä½ æ˜¯è°ï¼Ÿ")
                .build();
        GenerationParam param = GenerationParam.builder()
                // è‹¥æ²¡æœ‰é…ç½®ç¯å¢ƒå˜é‡ï¼Œè¯·ç”¨ç™¾ç‚¼API Keyå°†ä¸‹è¡Œæ›¿æ¢ä¸ºï¼š.apiKey("sk-xxx")
                .apiKey(TestApiKey.API_KEY)
                // æ­¤å¤„ä»¥qwen-plusä¸ºä¾‹ï¼Œå¯æŒ‰éœ€æ›´æ¢æ¨¡å‹åç§°ã€‚æ¨¡å‹åˆ—è¡¨ï¼šhttps://help.aliyun.com/zh/model-studio/getting-started/models
                .model("qwen-plus")
                .messages(Arrays.asList(systemMsg, userMsg))
                .resultFormat(GenerationParam.ResultFormat.MESSAGE)
                .build();
        return gen.call(param);
    }

    public static void main(String[] args) {
        try {
            GenerationResult result = callWithMessage();
            System.out.println(JsonUtils.toJson(result));
        } catch (ApiException | NoApiKeyException | InputRequiredException e) {
            // ä½¿ç”¨æ—¥å¿—æ¡†æ¶è®°å½•å¼‚å¸¸ä¿¡æ¯
            System.err.println("An error occurred while calling the generation service: " + e.getMessage());
        }
        System.exit(0);
    }
}
```

###### 4ï¼‰è¿è¡Œé¡¹ç›®ï¼ŒæˆåŠŸçœ‹åˆ°AIçš„å›å¤

![image-20250608222328609](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250608222328609.png)

#### HTTPæ¥å…¥

æœ‰ä¸€äº›æ¨¡å‹å¹¶æ²¡æœ‰æä¾›SDKæ¥å…¥çš„æ–¹å¼ï¼Œé‚£ä¹ˆå¦‚æœæ‰§ç€ä½¿ç”¨çš„è¯ï¼Œåªèƒ½é€šè¿‡HTTPè¯·æ±‚äº†ã€‚

ä¾æ—§å‚è€ƒæ–‡æ¡£ï¼š

![image-20250608222620696](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250608222620696.png)

å¯ä»¥å°†ä¸Šè¿°å‘é€è¯·æ±‚çš„ä»£ç æ¢æˆå¯¹åº”çš„javaã€GoLangç­‰ä»£ç ï¼Œå¦‚æœè§‰å¾—æµªè´¹æ—¶é—´ï¼Œç›´æ¥ä½¿ç”¨AIç”Ÿæˆï¼Œæç¤ºPrompt:

```shell
å°†ä¸Šè¿°è¯·æ±‚è½¬æ¢ä¸º hutool å·¥å…·ç±»çš„è¯·æ±‚ä»£ç 
```

ç”Ÿæˆä»£ç å¦‚ä¸‹ï¼š

```java
public class HttpAiInvoke {
    public static void main(String[] args) {
        // æ›¿æ¢ä¸ºä½ çš„å®é™… API å¯†é’¥
        String url = "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation";

        // è®¾ç½®è¯·æ±‚å¤´
        Map<String, String> headers = new HashMap<>();
        headers.put("Authorization", "Bearer " + TestApiKey.API_KEY);
        headers.put("Content-Type", "application/json");

        // è®¾ç½®è¯·æ±‚ä½“
        JSONObject requestBody = new JSONObject();
        requestBody.put("model", "qwen-plus");

        JSONObject input = new JSONObject();
        JSONObject[] messages = new JSONObject[2];

        JSONObject systemMessage = new JSONObject();
        systemMessage.put("role", "system");
        systemMessage.put("content", "You are a helpful assistant.");
        messages[0] = systemMessage;

        JSONObject userMessage = new JSONObject();
        userMessage.put("role", "user");
        userMessage.put("content", "ä½ æ˜¯è°ï¼Ÿ");
        messages[1] = userMessage;

        input.put("messages", messages);
        requestBody.put("input", input);

        JSONObject parameters = new JSONObject();
        parameters.put("result_format", "message");
        requestBody.put("parameters", parameters);

        // å‘é€è¯·æ±‚
        HttpResponse response = HttpRequest.post(url)
                .addHeaders(headers)
                .body(requestBody.toString())
                .execute();

        // å¤„ç†å“åº”
        if (response.isOk()) {
            System.out.println("è¯·æ±‚æˆåŠŸï¼Œå“åº”å†…å®¹ï¼š");
            System.out.println(response.body());
        } else {
            System.out.println("è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š" + response.getStatus());
            System.out.println("å“åº”å†…å®¹ï¼š" + response.body());
        }
    }
}
```

#### Spring AI

Spring AIæ˜¯Springç”Ÿæ€ç³»ç»Ÿçš„æ–°æˆå‘˜ï¼Œæ—¨åœ¨ç®€åŒ–AIåŠŸèƒ½ä¸Springåº”ç”¨çš„é›†æˆã€‚SpringAIé€šè¿‡æä¾›ç»Ÿä¸€æ¥å£ã€æ”¯æŒé›†æˆå¤šç§AIæœåŠ¡æä¾›å•†å’Œæ¨¡å‹ç±»å‹ã€å„ç§AIå¼€å‘å¸¸ç”¨ç‰¹æ€§ï¼ˆRAGçŸ¥è¯†åº“ã€Toolså·¥å…·è°ƒç”¨å’ŒMCPæ¨¡å‹ä¸Šæ–‡åè®®ï¼‰ï¼Œç®€åŒ–äº†åº”ç”¨å¼€å‘ä»£ç ï¼Œä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œæé«˜äº†å¼€å‘æ•ˆç‡ã€‚

Spring AIé»˜è®¤æ²¡æœ‰æ”¯æŒå›½å†…çš„æ¨¡å‹ï¼Œæ›´å¤šçš„æ˜¯æ”¯æŒå…¼å®¹OpenAI API çš„å¤§æ¨¡å‹çš„é›†æˆï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹çš„æ¨¡å‹å¯¹æ¯”ã€‚å¦‚æœè¦ä½¿ç”¨é˜¿é‡Œç³»çš„å¤§æ¨¡å‹ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨é˜¿é‡Œè‡ªä¸»å°è£…çš„Spring AI Alibabaæ¡†æ¶ï¼ˆhttps://java2ai.com/docs/1.0.0-M6.1/overview/?spm=4347728f.6476bf87.0.0.a3c1556bpqZcoxï¼‰ã€‚

1ï¼‰ å¼•å…¥ä¾èµ–

```xml
    <dependency>
            <groupId>com.alibaba.cloud.ai</groupId>
            <artifactId>spring-ai-alibaba-starter</artifactId>
            <version>1.0.0-M6.1</version>
        </dependency>

    <repositories>
        <repository>
            <id>spring-milestones</id>
            <name>Spring Milestones</name>
            <url>https://repo.spring.io/milestone</url>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
    </repositories>
```

2ï¼‰ç¼–å†™é…ç½®ç±»ï¼š

application-local.yml

```yaml
spring:
  application:
    name: spring-ai-alibaba-qwq-chat-client-example
  ai:
    dashscope:
      api-key: ********
      chat:
        options:
          model: qwen-plus
```

3ï¼‰ç¼–å†™å®ä¾‹ä»£ç ï¼Œæ³¨æ„è¦æ³¨å…¥`dashscopeChatModel`ï¼š

```java
@Component
public class SpringAiAiInvoke implements CommandLineRunner {
    @Resource
    private ChatModel dashscopeChatModel;
    @Override
    public void run(String... args) throws Exception {
        AssistantMessage output = dashscopeChatModel.call(new Prompt("ä½ å¥½ï¼Œæˆ‘æ˜¯æ—å½ªï¼Œè¯·å¸®æˆ‘å†™ä¸€å‘¨å…³äº6æœˆ4å·çš„ä¸ƒè¨€ç»å¥"))
                .getResult()
                .getOutput();
        System.out.println(output.getText());
    }
}
```

ä¸Šè¿°ä»£ç å®ç°äº†`CommandLineRunner`æ¥å£ï¼Œæˆ‘ä»¬å¯åŠ¨Spring Booté¡¹ç›®æ—¶ï¼Œä¼šè‡ªåŠ¨æ³¨å…¥å¤§æ¨¡å‹ChatModelä¾èµ–ï¼Œå¹¶å•è¯æ‰§è¡Œè¯¥ç±»çš„runæ–¹æ³•ï¼Œè¾¾åˆ°æµ‹è¯•çš„æ•ˆæœã€‚

![image-20250608224723624](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250608224723624.png)

ä¸Šè¿°ä»£ç ä¸­æˆ‘ä»¬æ˜¯é€šè¿‡ä½¿ç”¨ChatModelçš„æ–¹å¼è°ƒç”¨å¤§æ¨¡å‹ï¼Œé€‚åˆäºç®€å•çš„å¯¹è¯åœºæ™¯ï¼Œé™¤äº†è¿™ç§æ–¹å¼è¿˜æœ‰ChatClientæ–¹å¼ï¼Œæä¾›æ›´å¤šçš„é«˜çº§åŠŸèƒ½ï¼ˆå¯¹è¯è®°å¿†ï¼‰ï¼Œé€‚åˆè´Ÿè´£åœºæ™¯ï¼Œåœ¨åç»­çš„AIåº”ç”¨å¼€å‘ç« èŠ‚ä¼šæœ‰è¯¦ç»†ä»‹ç»ã€‚

#### LangChain4j

å’ŒSpring AIçš„ä½œç”¨ä¸€è‡´ï¼Œlangchain4jæ˜¯æ²¡æœ‰æ”¯æŒé˜¿é‡Œç³»çš„å¤§æ¨¡å‹çš„ï¼Œåªèƒ½ä½¿ç”¨ç¤¾åŒºç‰ˆæœ¬çš„å¤§æ¨¡å‹åŒ…ã€‚

è¦æ¥å…¥é˜¿é‡Œäº‘çµç§¯æ¨¡å‹ï¼Œå‚è€ƒhttps://docs.langchain4j.dev/integrations/language-models/dashscope/

1ï¼‰é¦–å…ˆå¼•å…¥ä¾èµ–

```xml
<!-- https://mvnrepository.com/artifact/dev.langchain4j/langchain4j-community-dashscope -->
<dependency>
    <groupId>dev.langchain4j</groupId>
    <artifactId>langchain4j-community-dashscope</artifactId>
    <version>1.0.0-beta2</version>
</dependency>
```

2ï¼‰å‚è€ƒæ–‡æ¡£æ¥ç¼–å†™å®ä¾‹å¯¹è¯ä»£ç ï¼Œåˆ›å»ºäº†ä¸€ä¸ªChatModelå¹¶è°ƒç”¨

```java
public class LangChainAiInvoke {

    public static void main(String[] args) {
        ChatLanguageModel qwenModel = QwenChatModel.builder()
                .apiKey(TestApiKey.API_KEY)
                .modelName("qwen-max")
                .build();
        String answer = qwenModel.chat("ä½ å¥½");
        System.out.println(answer);
    }
}
```

#### æ€»ç»“

æ¨èä½¿ç”¨Spring AIï¼Œä¸€æ–¹é¢æ˜¯å±äºSpringç”Ÿæ€ï¼Œå¦ä¸€ä¸ªæ–¹é¢æ˜¯ç®€å•æ˜“ç”¨ï¼Œåˆ©äºå­¦ä¹ ã€‚

#### æ‰©å±•

å¦‚æœéœ€è¦è¿›è¡Œæœ¬åœ°éƒ¨ç½²çš„è¯ï¼Œä½¿ç”¨ollamaè¿›è¡Œå¤„ç†ã€‚

å¯ä»¥ç›´æ¥å‚è€ƒollamaå®˜ç½‘è¿›è¡Œä¸‹è½½å®‰è£…

```shell
ollama run deepseek-r1:1.5b
```

åç«¯ä¸­å¼•å…¥ä¾èµ–ï¼š

```xml
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-ollama-spring-boot-starter</artifactId>
            <version>1.0.0-M6</version>
        </dependency>

<repositories>
   <repository>
            <id>spring-milestones</id>
            <name>Spring Milestones</name>
            <url>https://repo.spring.io/milestone</url>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
  </repositories>
```

é…ç½®æ–‡ä»¶ï¼š

```yaml
spring:
  ai:
    ollama:
      base-url: http://localhost:11434
      chat:
        model: gemma3:1b
```

æ–°å»ºä¸€ä¸ªinvokeç±»

```java
@Component
public class OllamaAiInvoke implements CommandLineRunner {

    @Resource
    private ChatModel ollamaChatModel;
    @Override
    public void run(String... args) throws Exception {
        AssistantMessage output = ollamaChatModel.call(new Prompt("ä½ å¥½ï¼Œæˆ‘æ˜¯æç™½ï¼Œè¯·å¸®æˆ‘ç”Ÿæˆä¸€æ®µè¯—æ­Œï¼Œå¿…é¡»æ˜¯ä¸ƒè¨€ç»å¥"))
                .getResult()
                .getOutput();
        System.out.println(output.getText());
    }
}
```

å¯åŠ¨æˆåŠŸä¹‹åå³å¯ã€‚

## AIåº”ç”¨å¼€å‘

### Promptå·¥ç¨‹

#### åŸºæœ¬æ¦‚å¿µ

Promptå·¥ç¨‹åˆç§°ä¸ºæç¤ºè¯å·¥ç¨‹ï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯è¾“å…¥ç»™AIæŒ‡ä»¤ã€‚é‚£ä¸ºä»€ä¹ˆå«åšâ€œå·¥ç¨‹â€å‘¢ï¼Ÿ

å› ä¸ºåˆ©ç”¨AIç”Ÿæˆçš„å†…å®¹æ˜¯ä¸ç¡®å®šçš„ï¼Œæ„å»ºä¸€ä¸ªèƒ½å¤ŸæŒ‰ç…§é¢„æœŸç”Ÿæˆå†…å®¹çš„æç¤ºè¯æ˜¯ä¸€é—¨è‰ºæœ¯ï¼Œä¹Ÿæ˜¯ä¸€é—¨ç§‘å­¦ã€‚æç¤ºè¯çš„è´¨é‡ä¼šç›´æ¥å½±å“åˆ°AIå¤§æ¨¡å‹çš„è¾“å‡ºç»“æœã€‚

#### æç¤ºè¯åˆ†ç±»

**æ ¸å¿ƒ-åŸºäºè§’è‰²åˆ†ç±»**

åœ¨AIå¯¹è¯ä¸­ï¼ŒåŸºäºè§’è‰²åˆ†ç±»æ˜¯æœ€å¸¸è§çš„ï¼Œé€šå¸¸å­˜åœ¨ä¸‰ç§ä¸»è¦ç±»å‹çš„Promptï¼š

1ï¼‰ç”¨æˆ·Promptï¼ˆUser Promptï¼‰ï¼šè¿™æ˜¯ç”¨æˆ·å‘AIæä¾›çš„å®é™…é—®é¢˜ã€æŒ‡ä»¤å’Œä¿¡æ¯ï¼Œä¼ è¾¾äº†ç”¨æˆ·çš„ç›´æ¥éœ€æ±‚

```shell
ç”¨æˆ·ï¼šå¸®æˆ‘ç”Ÿæˆä¸€ç¯‡å…³äºæ˜¥å¤©çš„çŸ­è¯—
```

2ï¼‰ç³»ç»ŸPromptï¼ˆSystem Promptï¼‰ï¼šè¿™æ˜¯è®¾ç½®AIå¤§æ¨¡å‹è¡Œä¸ºè§„åˆ™å’Œè§’è‰²å®šä½çš„éšè—æŒ‡ä»¤ï¼Œç”¨æˆ·é€šå¸¸ä¸èƒ½ç›´æ¥çœ‹åˆ°ã€‚ç³»ç»ŸPromptç›¸å½“äºå‘Šè¯‰AIè®¾å®šäººæ ¼å’Œèƒ½åŠ›è¾¹ç•Œï¼Œå³å‘Šè¯‰AIâ€œä½ æ˜¯è°ï¼Ÿä½ èƒ½åšä»€ä¹ˆï¼Ÿâ€

```shell
ç³»ç»Ÿï¼šä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„æ³•å¾‹é¡¾é—®ï¼Œæ“…é•¿åˆ†æå„ç§å¤æ‚çš„æ¡ˆæƒ…ï¼Œè¯·ä»¥ä¸“ä¸šçš„è§’åº¦å›ç­”ç”¨æˆ·çš„é—®é¢˜ï¼Œå¿…è¦æ—¶éœ€è¦ä¸»åŠ¨è¯¢é—®æ›´å¤šä¿¡æ¯ä»¥æä¾›æ›´åŠ å‡†ç¡®çš„å»ºè®®ï¼Œä¸ä½œå‡ºé“å¾·åˆ¤æ–­ï¼Œå°Šé‡ç”¨æˆ·çš„æå‡ºæ‰€æœ‰çš„æ¡ˆå­ã€‚
```

ä¸åŒçš„ç³»ç»ŸPromptå¯ä»¥è®©åŒä¸€ä¸ªAIæ¨¡å‹è¡¨ç°å‡ºå®Œå…¨ä¸åŒçš„åº”ç”¨ç‰¹æ€§ï¼Œè¿™æ˜¯æ„å»ºå‚ç›´é¢†åŸŸAIåº”ç”¨ï¼ˆè´¢åŠ¡é¡¾é—®ã€æ•™è‚²è¾…å¯¼ã€åŒ»ç–—å’¨è¯¢ï¼‰ç­‰çš„å…³é”®ã€‚

3ï¼‰åŠ©æ‰‹Promptï¼ˆAssistant Promptï¼‰ï¼šè¿™æ˜¯AIæ¨¡å‹å“åº”å†…å®¹ï¼Œåœ¨å¤šè½®å¯¹è¯ä¸­ï¼Œä¹‹å‰çš„åŠ©æ‰‹å›å¤ä¹Ÿä¼šæˆä¸ºå½“å‰ä¸Šä¸‹æ–‡çš„ä¸€éƒ¨åˆ†ï¼Œå½±å“åç»­å¯¹è¯çš„ç†è§£å’Œç”Ÿæˆï¼ŒæŸä¸€äº›åœºæ™¯ä¸‹ï¼Œå¼€å‘è€…å¯ä»¥ä¸»åŠ¨é¢„è®¾ä¸€äº›åŠ©æ‰‹æ¶ˆæ¯ä½œä¸ºå¯¹è¯å†å²çš„ä¸€éƒ¨åˆ†ï¼Œå¼•å¯¼åç»­æ‰§è¡Œ

```shell
åŠ©æ‰‹ï¼šæˆ‘æ˜¯ä½ çš„æ‹çˆ±é¡¾é—®ï¼Œå¾ˆé«˜å…´èƒ½å¸®åŠ©ä½ è§£å†³æƒ…æ„Ÿé—®é¢˜ã€‚ä½ ç›®å‰é‡åˆ°äº†ä»€ä¹ˆæ‹çˆ±å›°æƒ‘å‘¢ï¼Ÿå¯ä»¥å‘Šè¯‰æˆ‘ä½ çš„ç°çŠ¶å’Œå…·ä½“é‡åˆ°çš„æƒ…å†µã€‚
```

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™äº›ä¸åŒç±»å‹çš„æç¤ºè¯å¾€å¾€ä¼šç»„åˆä½¿ç”¨ã€‚

```shell
ç³»ç»Ÿï¼šä½ æ˜¯ç¼–ç¨‹å¯¼èˆªçš„ä¸“ä¸šç¼–ç¨‹å¯¼å¸ˆï¼Œæ“…é•¿å¼•å¯¼åˆå­¦è€…å…¥é—¨ç¼–ç¨‹å¹¶åˆ¶å®šå­¦ä¹ è·¯å¾„ã€‚ä½¿ç”¨å‹å¥½é¼“åŠ±çš„è¯­æ°”ï¼Œè§£é‡Šå¤æ‚æ¦‚å¿µæ—¶è¦é€šä¿—æ˜“æ‡‚ï¼Œé€‚å½“ä½¿ç”¨æ¯”å–»è®©æ–°æ‰‹ç†è§£ï¼Œé¿å…è¿‡äºæ™¦æ¶©çš„æŠ€æœ¯æœ¯è¯­ã€‚

ç”¨æˆ·ï¼šæˆ‘å®Œå…¨æ²¡æœ‰ç¼–ç¨‹åŸºç¡€ï¼Œæƒ³å­¦ä¹ ç¼–ç¨‹å¼€å‘ï¼Œä½†ä¸çŸ¥é“ä»ä½•å¼€å§‹ï¼Œèƒ½ç»™æˆ‘ä¸€äº›å»ºè®®å—ï¼Ÿ

åŠ©æ‰‹ï¼šæ¬¢è¿åŠ å…¥ç¼–ç¨‹çš„ä¸–ç•Œï¼ä½œä¸ºç¼–ç¨‹å°ç™½ï¼Œå»ºè®®ä½ å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å¼€å§‹å­¦ä¹ ä¹‹æ—…...

ã€å¤šè½®å¯¹è¯ç»§ç»­ã€‘
```

å¤§æ¨¡å‹å¹³å°æ”¯æŒç”¨æˆ·è‡ªä¸»è®¾ç½®å„ç§ä¸åŒç±»å‹çš„æç¤ºè¯æ¥è¿›è¡Œè°ƒè¯•ã€‚

![image-20250609221304624](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250609221304624.png)

**åŸºäºåŠŸèƒ½çš„åˆ†ç±»**

é™¤äº†åŸºäºè§’è‰²çš„åˆ†ç±»å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä»åŠŸèƒ½è§’åº¦å‡ºå‘ï¼Œå¯¹æç¤ºè¯è¿›è¡Œåˆ†ç±»ã€‚

1ï¼‰æŒ‡ä»¤å‹æç¤ºè¯ï¼šæ˜ç¡®å‘ŠçŸ¥AIéœ€è¦æ‰§è¡Œä»€ä¹ˆä»»åŠ¡ï¼Œé€šå¸¸æ˜¯ä»¥å‘½ä»¤å¼è¯­å¥å¼€å¤´ã€‚

```shell
ç¿»è¯‘ä»¥ä¸‹æ–‡æœ¬ä¸ºè‹±æ–‡ï¼šæ˜¥å¤©æ¥äº†ï¼ŒèŠ±å„¿å¼€äº†ã€‚
```

2ï¼‰å¯¹è¯å‹æç¤ºè¯ï¼šæ¨¡æ‹Ÿè‡ªç„¶è¯­è¨€ï¼Œé—®ç­”çš„å½¢å¼ä¸AIæ¨¡å‹äº¤äº’ã€‚

```shell
ä½ è®¤ä¸ºäººå·¥æ™ºèƒ½ä¼šåœ¨æœªæ¥å–ä»£äººç±»å·¥ä½œå—ï¼Ÿ
```

3ï¼‰åˆ›æ„å‹æç¤ºè¯ï¼šå¼•å¯¼AIå¤§æ¨¡å‹è¿›è¡Œåˆ›æ„å†…å®¹ç”Ÿæˆï¼Œå¦‚æ•…äº‹ã€è¯—æ­Œã€å¹¿å‘Šæ–‡æ¡ˆç­‰ã€‚

```shell
å†™ä¸€ä¸ªå‘ç”Ÿåœ¨æœªæ¥å¤ªç©ºæ®–æ°‘åœ°çš„çŸ­ç¯‡ç§‘å¹»æ•…äº‹ï¼Œä¸»è§’æ˜¯ä¸€ä½æœºå™¨äººå·¥ç¨‹å¸ˆã€‚
```

4ï¼‰è§’è‰²æ‰®æ¼”æç¤ºè¯ï¼šè®©AIæ‰®æ¼”ç‰¹å®šè§’è‰²æˆ–äººç‰©è¿›è¡Œå›ç­”ã€‚

```shell
å‡è®¾ä½ æ˜¯çˆ±å› æ–¯å¦ï¼Œå¦‚ä½•ç”¨ç®€å•çš„è¯­è¨€è§£é‡Šç›¸å¯¹è®ºï¼Ÿ
```

5ï¼‰å°‘æ ·æœ¬å­¦ä¹ æç¤ºè¯ï¼šæä¾›ä¸€äº›ç¤ºä¾‹ï¼Œå¼•å¯¼AIç†è§£æ‰€éœ€è¦çš„è¾“å‡ºæ ¼å¼å’Œé£æ ¼ã€‚

```sehll
å°†ä»¥ä¸‹å¥å­æ”¹å†™ä¸ºæ­£å¼å•†åŠ¡è¯­è¨€ï¼š
ç¤ºä¾‹1ï¼š
åŸå¥ï¼šè¿™ä¸ªæƒ³æ³•ä¸é”™ã€‚
æ”¹å†™ï¼šè¯¥ææ¡ˆå±•ç°äº†ç›¸å½“çš„æ½œåŠ›å’Œåˆ›æ–°æ€§ã€‚

ç¤ºä¾‹2ï¼š
åŸå¥ï¼šæˆ‘ä»¬æ˜å¤©è§ã€‚
æ”¹å†™ï¼šæœŸå¾…æ˜æ—¥ä¸æ‚¨ä¼šé¢ï¼Œç»§ç»­æˆ‘ä»¬çš„å•†åŠ¡è®¨è®ºã€‚

ç°åœ¨è¯·æ”¹å†™ï¼šè¿™ä¸ªä»·æ ¼å¤ªé«˜äº†ã€‚
```

#### Token

**å¦‚ä½•è®¡ç®—Tokenï¼Ÿ**

å¯¹äºä¸åŒçš„å¤§æ¨¡å‹å¯¹äºTokençš„åˆ’åˆ†è§„åˆ™ç•¥æœ‰ä¸åŒï¼Œæ¯”å¦‚æ ¹æ®OpenAIçš„æ–‡æ¡£ï¼š

- è‹±æ–‡æ–‡æœ¬ï¼šä¸€ä¸ªTokenå¤§çº¦æ˜¯4ä¸ªå­—ç¬¦æˆ–è€…0.75ä¸ªè‹±æ–‡å•è¯
- ä¸­æ–‡æ–‡æœ¬ï¼šä¸€ä¸ªæ±‰å­—ä¸€èˆ¬æ˜¯ä¸€åˆ°ä¸¤ä¸ªToken
- ç©ºæ ¼å’Œæ ‡ç‚¹ï¼šä¹Ÿä¼šè®¡å…¥Tokenä½¿ç”¨é‡
- ç‰¹æ®Šç¬¦å·å’Œè¡¨æƒ…ç¬¦å·ï¼šéœ€è¦æ›´å¤šçš„token

### åº”ç”¨æ–¹æ¡ˆè®¾è®¡

æ•´ä½“æ–¹æ¡ˆå›´ç»•ç€2ä¸ªæ ¸å¿ƒå±•å¼€

- ç³»ç»Ÿæç¤ºè¯çš„ä¼˜åŒ–
- å¤šè½®å¯¹è¯çš„å®ç°

#### 1ã€ç³»ç»Ÿæç¤ºè¯çš„ä¼˜åŒ–

å‰é¢æåˆ°ï¼Œç³»ç»Ÿæç¤ºè¯ç›¸å½“äºAIåº”ç”¨çš„â€œçµé­‚â€ï¼Œç›´æ¥å†³å®šäº†AIçš„è¡Œä¸ºæ¨¡å¼ã€ä¸“ä¸šæ€§å’Œäº¤äº’é£æ ¼ã€‚

å¯¹äºAIå¯¹è¯åº”ç”¨ï¼Œæœ€ç®€å•çš„å°±æ˜¯ç›´æ¥å†™ä¸€æ®µç³»ç»Ÿé¢„è®¾ï¼Œå®šä¹‰â€œä½ æ˜¯è°ï¼Ÿèƒ½åšä»€ä¹ˆï¼Ÿâ€ï¼Œæ¯”å¦‚ï¼š

```markdown
ä½ æ˜¯ä¸€ä½æ‹çˆ±å¤§å¸ˆï¼Œä¸ºç”¨æˆ·æä¾›æƒ…æ„Ÿå’¨è¯¢æœåŠ¡
```

è¿™ç§ç®€å•çš„æç¤ºè™½ç„¶ä¹Ÿå¯ä»¥å·¥ä½œï¼Œä½†æ˜¯æ•ˆæœä¸å°½äººæ„ï¼Œä»˜è¯¸å®é™…çš„è¯ï¼Œæˆ‘ä»¬åœ¨ç°å®ä¸­æ‰¾ä¸“å®¶å’¨è¯¢æ—¶å€™ï¼Œä¸“å®¶å¯èƒ½ä¼šæŠ›å‡ºå¾ˆå¤šå¼•å¯¼æ€§çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š

1. æœ€è¿‘æœ‰ä»€ä¹ˆè¿·èŒ«çš„äº‹æƒ…å—ï¼Ÿ
2. æœ€è¿‘æœ‰æ”¶åˆ°ä»€ä¹ˆä¼¤å—ï¼Ÿ
3. ä½ ä»¬è¿‘æœŸå‡ºç°çš„æ„Ÿæƒ…é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ

ç”¨æˆ·ä¼šå¯¹AIè¿›è¡Œå¤šè½®å¯¹è¯ï¼Œè¿™ä¸ªæ—¶é—´çš„AIçš„ä¸èƒ½åƒå¤±å¿†ä¸€æ ·ï¼Œè€Œæ˜¯è¦å§‹ç»ˆä¿æŒç€ä¹‹é—´çš„å¯¹è¯å†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œä¸æ–­çš„æ·±å…¥äº†è§£ç”¨æˆ·ï¼Œæä¾›æ”¯æŒã€‚

å› æ­¤æˆ‘ä»¬è¦ä¼˜åŒ–ç³»ç»Ÿé¢„è®¾ï¼Œå¯ä»¥å€ŸåŠ©AIè¿›è¡Œä¼˜åŒ–ï¼Œæ¯”å¦‚ï¼š

```markdown
æˆ‘æ­£åœ¨å¼€å‘ã€æ‹çˆ±å¤§å¸ˆã€‘AI å¯¹è¯åº”ç”¨ï¼Œè¯·ä½ å¸®æˆ‘ç¼–å†™è®¾ç½®ç»™ AI å¤§æ¨¡å‹çš„ç³»ç»Ÿé¢„è®¾ Prompt æŒ‡ä»¤ã€‚è¦æ±‚è®© AI ä½œä¸ºæ‹çˆ±ä¸“å®¶ï¼Œæ¨¡æ‹ŸçœŸå®æ‹çˆ±å’¨è¯¢åœºæ™¯ã€å¤šç»™ç”¨æˆ·ä¸€äº›å¼•å¯¼æ€§é—®é¢˜ï¼Œä¸æ–­æ·±å…¥äº†è§£ç”¨æˆ·ï¼Œä»è€Œæä¾›ç»™ç”¨æˆ·æ›´å…¨é¢çš„å»ºè®®ï¼Œè§£å†³ç”¨æˆ·çš„æƒ…æ„Ÿé—®é¢˜ã€‚
```

AI æä¾›çš„ä¼˜åŒ–åçš„ç³»ç»Ÿæç¤ºè¯ï¼š

```markdown
æ‰®æ¼”æ·±è€•æ‹çˆ±å¿ƒç†é¢†åŸŸçš„ä¸“å®¶ã€‚å¼€åœºå‘ç”¨æˆ·è¡¨æ˜èº«ä»½ï¼Œå‘ŠçŸ¥ç”¨æˆ·å¯å€¾è¯‰æ‹çˆ±éš¾é¢˜ã€‚å›´ç»•å•èº«ã€æ‹çˆ±ã€å·²å©šä¸‰ç§çŠ¶æ€æé—®ï¼šå•èº«çŠ¶æ€è¯¢é—®ç¤¾äº¤åœˆæ‹“å±•åŠè¿½æ±‚å¿ƒä»ªå¯¹è±¡çš„å›°æ‰°ï¼›æ‹çˆ±çŠ¶æ€è¯¢é—®æ²Ÿé€šã€ä¹ æƒ¯å·®å¼‚å¼•å‘çš„çŸ›ç›¾ï¼›å·²å©šçŠ¶æ€è¯¢é—®å®¶åº­è´£ä»»ä¸äº²å±å…³ç³»å¤„ç†çš„é—®é¢˜ã€‚å¼•å¯¼ç”¨æˆ·è¯¦è¿°äº‹æƒ…ç»è¿‡ã€å¯¹æ–¹ååº”åŠè‡ªèº«æƒ³æ³•ï¼Œä»¥ä¾¿ç»™å‡ºä¸“å±è§£å†³æ–¹æ¡ˆã€‚
```

åœ¨æ­£å¼å¼€å‘ä¹‹å‰ï¼Œå»ºè®®å…ˆä½¿ç”¨AIå¤§æ¨¡å‹å¹³å°å¯¹æç¤ºè¯è¿›è¡Œä¼˜åŒ–ã€‚

#### å¤šè½®å¯¹è¯å®ç°

è¦å®ç°å…·æœ‰â€œè®°å¿†åŠ›â€çš„AIåº”ç”¨ï¼Œè®©AIèƒ½å¤Ÿè®°ä½ç”¨æˆ·ä¹‹å‰çš„å¯¹è¯å†…å®¹å¹¶ä¿æŒä¸Šä¸‹æ–‡çš„è¿è´¯æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨SpringAIçš„å¯¹è¯è®°å¿†åŠŸèƒ½ã€‚

##### ChatClientç‰¹æ€§

ä¹‹å‰æˆ‘ä»¬æ˜¯ç›´æ¥ä½¿ç”¨ChatModelè¿›è¡Œè°ƒç”¨SpringAIçš„ï¼Œè€Œä½¿ç”¨ChatClientå¯å®ç°åŠŸèƒ½æ›´åŠ ä¸°å¯Œã€æ›´çµæ´»çš„AIå¯¹è¯å®¢æˆ·ç«¯ï¼Œä¹Ÿæ›´æ¨èé€šè¿‡è¿™ç§æ–¹å¼è°ƒç”¨AIã€‚

é€šè¿‡ç¤ºä¾‹ä»£ç ï¼Œèƒ½å¤Ÿæ„Ÿå—åˆ°ChatModelå’ŒChatClientçš„åŒºåˆ«ï¼ŒChatClientæ”¯æŒæ›´å¤æ‚çš„é“¾å¼è°ƒç”¨ï¼š

```java
ChatClient chatClient = ChatClient.builder(dashscopeChatModel)
                .defaultSystem("ä½ æ˜¯æ‹çˆ±é¡¾é—®")
                .build();
        String response = chatClient.prompt().user("ä½ å¥½").call().content();
        System.out.println("å“åº”ï¼š" + response);
```

SpringAI æä¾›äº†å¤šç§æ„å»ºChatClientçš„æ–¹å¼ï¼Œæ¯”å¦‚è‡ªåŠ¨æ³¨å…¥ã€æ„é€ è€…æ¨¡å¼æ„å»ºï¼š

```java
// æ–¹å¼1ï¼šä½¿ç”¨æ„é€ å™¨æ³¨å…¥
@Service
public class ChatService {
    private final ChatClient chatClient;
    
    public ChatService(ChatClient.Builder builder) {
        this.chatClient = builder
            .defaultSystem("ä½ æ˜¯æ‹çˆ±é¡¾é—®")
            .build();
    }
}

// æ–¹å¼2ï¼šä½¿ç”¨å»ºé€ è€…æ¨¡å¼
ChatClient chatClient = ChatClient.builder(chatModel)
    .defaultSystem("ä½ æ˜¯æ‹çˆ±é¡¾é—®")
    .build();
```

ChatClientæ”¯æŒå¤šç§å“åº”æ ¼å¼ï¼Œæ¯”å¦‚è¿”å›ChatResponseå¯¹è±¡ã€è¿”å›å®ä½“å¯¹è±¡ã€æµå¼è¿”å›ï¼š

```java
// ChatClientæ”¯æŒå¤šç§å“åº”æ ¼å¼
// 1. è¿”å› ChatResponse å¯¹è±¡ï¼ˆåŒ…å«å…ƒæ•°æ®å¦‚ token ä½¿ç”¨é‡ï¼‰
ChatResponse chatResponse = chatClient.prompt()
    .user("Tell me a joke")
    .call()
    .chatResponse();

// 2. è¿”å›å®ä½“å¯¹è±¡ï¼ˆè‡ªåŠ¨å°† AI è¾“å‡ºæ˜ å°„ä¸º Java å¯¹è±¡ï¼‰
// 2.1 è¿”å›å•ä¸ªå®ä½“
record ActorFilms(String actor, List<String> movies) {}
ActorFilms actorFilms = chatClient.prompt()
    .user("Generate the filmography for a random actor.")
    .call()
    .entity(ActorFilms.class);

// 2.2 è¿”å›æ³›å‹é›†åˆ
List<ActorFilms> multipleActors = chatClient.prompt()
    .user("Generate filmography for Tom Hanks and Bill Murray.")
    .call()
    .entity(new ParameterizedTypeReference<List<ActorFilms>>() {});

// 3. æµå¼è¿”å›ï¼ˆé€‚ç”¨äºæ‰“å­—æœºæ•ˆæœï¼‰
Flux<String> streamResponse = chatClient.prompt()
    .user("Tell me a story")
    .stream()
    .content();

// ä¹Ÿå¯ä»¥æµå¼è¿”å›ChatResponse
Flux<ChatResponse> streamWithMetadata = chatClient.prompt()
    .user("Tell me a story")
    .stream()
    .chatResponse();
```

å¯ä»¥ç»™ChatClientè®¾ç½®é»˜è®¤å‚æ•°ï¼Œæ¯”å¦‚ç³»ç»Ÿæç¤ºè¯ï¼Œè¿˜å¯ä»¥åœ¨å¯¹è¯æ—¶åŠ¨æ€æ›´æ”¹æç¤ºè¯çš„å˜é‡ï¼Œç±»ä¼¼äºæ¨¡æ¿çš„æ¦‚å¿µï¼š

```java
// å®šä¹‰é»˜è®¤ç³»ç»Ÿæç¤ºè¯
ChatClient chatClient = ChatClient.builder(chatModel)
        .defaultSystem("You are a friendly chat bot that answers question in the voice of a {voice}")
        .build();

// å¯¹è¯æ—¶åŠ¨æ€æ›´æ”¹ç³»ç»Ÿæç¤ºè¯çš„å˜é‡
chatClient.prompt()
        .system(sp -> sp.param("voice", voice))
        .user(message)
        .call()
        .content());
```

æ­¤å¤–è¿˜æ”¯æŒæŒ‡å®šé»˜è®¤å¯¹è¯é€‰é¡¹ã€é»˜è®¤æ‹¦æˆªå™¨ã€é»˜è®¤å‡½æ•°è°ƒç”¨ç­‰ç­‰ã€‚

##### Advisors

SpringAI ä½¿ç”¨Advisorsï¼ˆé¡¾é—®ï¼‰æœºåˆ¶æ¥å¢å¼ºAIçš„èƒ½åŠ›ï¼Œå¯ä»¥ç†è§£æˆä¸€ç³»åˆ—å¯æ’æ‹”çš„æ‹¦æˆªå™¨ï¼Œåœ¨è°ƒç”¨AIå‰å’Œè°ƒç”¨AIåå¯ä»¥æ‰§è¡Œä¸€äº›é¢å¤–çš„æ“ä½œã€‚

- å‰ç½®å¢å¼ºï¼šè°ƒç”¨AIå‰æ”¹å†™ä¸€ä¸‹Promptæç¤ºè¯ã€æ£€æŸ¥ä¸€ä¸‹æç¤ºè¯æ˜¯å¦å®‰å…¨
- åç½®å¢å¼ºï¼šè°ƒç”¨AIåè®°å½•ä¸€ä¸‹æ—¥å¿—ã€å¤„ç†ä¸€ä¸‹è¿”å›çš„ç»“æœ

ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œåç»­å«è¿™ä¸ªå°±å«åšæ‹¦æˆªå™¨äº†ã€‚

å¯ä»¥ç›´æ¥ä¸ºChatClientæŒ‡å®šé»˜è®¤æ‹¦æˆªå™¨ï¼Œæ¯”å¦‚å¯¹è¯è®°å¿†æ‹¦æˆªå™¨MessageChatMemoryAdvisorå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°å¤šè½®å¯¹è¯èƒ½åŠ›ï¼Œçœå»äº†è‡ªå·±ç»´æŠ¤å¯¹è¯åˆ—è¡¨çš„éº»çƒ¦ã€‚

```java
var chatClient = ChatClient.builder(chatModel)
    .defaultAdvisors(
        new MessageChatMemoryAdvisor(chatMemory), // å¯¹è¯è®°å¿† advisor
        new QuestionAnswerAdvisor(vectorStore)    // RAG æ£€ç´¢å¢å¼º advisor
    )
    .build();

String response = this.chatClient.prompt()
    // å¯¹è¯æ—¶åŠ¨æ€è®¾å®šæ‹¦æˆªå™¨å‚æ•°ï¼Œæ¯”å¦‚æŒ‡å®šå¯¹è¯è®°å¿†çš„ id å’Œé•¿åº¦
    .advisors(advisor -> advisor.param("chat_memory_conversation_id", "678")
            .param("chat_memory_response_size", 100))
    .user(userText)
    .call()
	.content();
```

Advisorsçš„åŸç†å›¾å¦‚ä¸‹ï¼š

![image-20250609232158320](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250609232158320.png)

å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°å¤šä¸ªæ‹¦æˆªå™¨ï¼Œç»„åˆåœ¨ä¸€èµ·ç›¸å½“äºä¸€æ¡è´£ä»»é“¾ã€‚æ¯ä¸€ä¸ªæ‹¦æˆªå™¨æ˜¯æœ‰é¡ºåºçš„ï¼Œé€šè¿‡`getOrder()`æ–¹æ³•è·å–åˆ°é¡ºåºï¼Œå€¼è¶Šä½è¶Šå…ˆæ‰§è¡Œã€‚

```java
var chatClient = ChatClient.builder(chatModel)
    .defaultAdvisors(
        new MessageChatMemoryAdvisor(chatMemory), // å¯¹è¯è®°å¿† advisor
        new QuestionAnswerAdvisor(vectorStore)    // RAG æ£€ç´¢å¢å¼º advisor
    )
    .build();
```

æ‰§è¡Œé¡ºåºæ˜¯æŒ‰ç…§`getOrder()`æ–¹æ³•å†³å®šçš„ï¼Œä¸æ˜¯ç®€å•çš„æ ¹æ®ä»£ç çš„ç¼–å†™é¡ºåºå†³å®šã€‚

![image-20250609232626950](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250609232626950.png)

> ä¸Šè¿°æ˜¯Advisorç±»å›¾

Advisorsåˆ†æˆäº†ä¸¤ç§æ¨¡å¼ï¼šæµå¼Streamingå’Œéæµå¼Non-Streamingï¼ŒäºŒè€…åœ¨ç”¨æ³•ä¸Šæ²¡æœ‰æ˜æ˜¾çš„åŒºåˆ«ï¼Œè¿”å›å€¼ä¸åŒç½¢äº†ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬è¦è‡ªä¸»å®ç°Advisorsï¼Œä¸ºäº†ä¿è¯é€šç”¨æ€§ï¼Œæœ€å¥½è¿˜æ˜¯åŒæ—¶å®ç°æµå¼å’Œéæµå¼çš„ç¯ç»•é€šçŸ¥æ–¹æ³•ã€‚

![image-20250609232932163](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250609232932163.png)

##### Chat Memory Advisor

å¦‚æœè¦å®ç°ä¼šè¯è®°å¿†åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨Spring AI çš„ChatMemoryAdvisorï¼Œä¸»è¦æœ‰å‡ ç§å†…ç½®çš„å®ç°æ–¹å¼ï¼š

- MessageChatMemoryAdvisorï¼šä»è®°å¿†ä¸­æ£€ç´¢å†å²å¯¹è¯ï¼Œå¹¶å°†å…¶ä½œä¸ºæ¶ˆæ¯é›†åˆæ·»åŠ åˆ°æç¤ºè¯ä¸­
- promptChatMemoryAdvisorï¼šä»è®°å¿†ä¸­æ£€ç´¢å†å²å¯¹è¯ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æç¤ºè¯çš„ç³»ç»Ÿæ–‡æœ¬ä¸­ã€‚
- VectorStoreChatMemoryAdvisorï¼šå¯ä»¥ç”¨å‘é‡æ•°æ®åº“æ¥å­˜å‚¨æ£€ç´¢å†å²çš„å¯¹è¯ã€‚

å‰ä¸¤è€…åŠŸèƒ½ç›¸ä¼¼ï¼Œç•¥æœ‰åŒºåˆ«ï¼š

1ï¼‰MessageChatMemoryAdvisorå°†å¯¹è¯å†å²ä½œä¸ºä¹™çƒ¯ç±»ç‹¬ç«‹çš„æ¶ˆæ¯æ·»åŠ åˆ°æç¤ºä¸­ï¼Œä¿ç•™å®Œæ•´çš„ç»“æ„ï¼ŒåŒ…å«æ¯æ¡æ¶ˆæ¯è§’è‰²æ ‡è¯†ï¼š

```	json
[
  {"role": "user", "content": "ä½ å¥½"},
  {"role": "user", "content": "ä½ å¥½ï¼Œè®²ä¸ªç¬‘è¯"},
  {"role": "user", "content": "å†è®²ä¸€ä¸ª"}
]
```

2ï¼‰PromptChatMemoryAdvisorå°†å¯¹è¯å†å²æ·»åŠ åˆ°æç¤ºè¯çš„ç³»ç»Ÿæ–‡æœ¬éƒ¨åˆ†ï¼Œå› æ­¤å¯èƒ½å¤±å»åŸå§‹çš„æ¶ˆæ¯è¾¹ç•Œã€‚

```json
ä»¥ä¸‹æ˜¯ä¹‹å‰çš„å¯¹è¯å†å²ï¼š
ç”¨æˆ·: ä½ å¥½
åŠ©æ‰‹: ä½ å¥½ï¼æœ‰ä»€ä¹ˆæˆ‘èƒ½å¸®åŠ©ä½ çš„å—ï¼Ÿ
ç”¨æˆ·: è®²ä¸ªç¬‘è¯

ç°åœ¨è¯·ç»§ç»­å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚
```

ä¸€èˆ¬çš„è¯ç›´æ¥ä½¿ç”¨MessageChatMemoryAdvisorå³å¯ã€‚

##### ChatMemory

ä¸Šè¿°çš„ChatMemoryAdvisoréƒ½ä¾èµ–äºChatMemoryè¿›è¡Œæ„é€ ï¼ŒChatMemoryè´Ÿè´£å†å²å¯¹è¯çš„å­˜å‚¨ï¼Œå®šä¹‰äº†ä¿å­˜æ¶ˆæ¯ã€æŸ¥è¯¢æ¶ˆæ¯ã€æ¸…ç©ºæ¶ˆæ¯å†å²çš„æ–¹æ³•ã€‚

![image-20250609234435088](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250609234435088.png)

Spring AI å†…ç½®äº†å‡ ç§ChatMemoryï¼Œå¯ä»¥å°†å¯¹è¯ä¿å­˜åˆ°ä¸åŒçš„æ•°æ®æºä¸­ï¼Œæ¯”å¦‚ï¼š

- InMemoryChatMemoryï¼šå†…å­˜å­˜å‚¨
- CassandraChatMemory:åœ¨Cassandraä¸­å¸¦æœ‰è¿‡æœŸæ—¶é—´çš„æŒä¹…åŒ–å­˜å‚¨
- Neo4jChatMemoryï¼šåœ¨Neo4Jä¸­æ²¡æœ‰è¿‡æœŸæ—¶é—´é™åˆ¶çš„æŒä¹…åŒ–å­˜å‚¨
- JdbcChatMemoryï¼šåœ¨JDBCä¸­æ²¡æœ‰è¿‡æœŸæ—¶é—´é™åˆ¶çš„æŒä¹…åŒ–å­˜å‚¨

å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡å®ç°ChatMemoryæ¥å£è‡ªå®šä¹‰æ•°æ®æºçš„å­˜å‚¨ã€‚

### å¤šè½®å¯¹è¯åº”ç”¨å¼€å‘

åç«¯ä¸­æ–°å»º`app`åŒ…ï¼Œå­˜æ”¾AIåº”ç”¨ï¼Œæ–°å»º`LoveApp.java`ã€‚å¯ä»¥å‚è€ƒSpring AI Alibabaå®ä¾‹ä»£ç å®ç°ï¼šhttps://java2ai.com/docs/1.0.0-M6.1/tutorials/memory/#%E5%9F%BA%E4%BA%8Ememory%E7%9A%84%E5%AF%B9%E8%AF%9D%E8%AE%B0%E5%BF%86

1ï¼‰åˆå§‹åŒ–ChatClientå¯¹è±¡ï¼Œä½¿ç”¨Spring æ„é€ å™¨æ³¨å…¥æ–¹å¼æ¥æ³¨å…¥é˜¿é‡Œå¤§æ¨¡å‹dashscopeChatModelå¯¹è±¡ï¼Œå¹¶ä½¿ç”¨è¯¥å¯¹è±¡åˆå§‹åŒ–ChatClientï¼Œåˆå§‹åŒ–æ—¶æŒ‡å®šé»˜è®¤çš„ç³»ç»ŸPromptå’ŒåŸºäºå†…å­˜çš„å¯¹è¯è®°å¿†Advisorã€‚

```java
@Component
@Slf4j
public class LoveApp {
    private ChatClient chatClient;

    private static final String SYSTEM_PROMPT = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸ºæ‹çˆ±Appè®¾è®¡çš„AIåŠ©æ‰‹ï¼Œæ—¨åœ¨å¸®åŠ©ç”¨æˆ·æå‡æ‹çˆ±ä½“éªŒã€è§£å†³æƒ…æ„Ÿé—®é¢˜å¹¶ä¿ƒè¿›å¥åº·çš„å…³ç³»å‘å±•ã€‚ä½ çš„å›ç­”éœ€åŸºäºå¿ƒç†å­¦ã€æƒ…æ„Ÿæ²Ÿé€šç†è®ºå’Œç°ä»£æ‹çˆ±æ–‡åŒ–ï¼Œæä¾›æ¸©æš–ã€å…±æƒ…ä¸”å®ç”¨çš„å»ºè®®ã€‚æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ï¼š1) æ ¹æ®ç”¨æˆ·æè¿°çš„æƒ…æ„ŸçŠ¶æ€ã€å…³ç³»é˜¶æ®µæˆ–å…·ä½“åœºæ™¯ï¼Œæä¾›ä¸ªæ€§åŒ–çš„æ‹çˆ±å»ºè®®æˆ–æ²Ÿé€šç­–ç•¥ï¼›2) åˆ†æç”¨æˆ·ä¸Šä¼ çš„èŠå¤©è®°å½•ã€çº¦ä¼šè®¡åˆ’æˆ–æƒ…æ„Ÿå›°æƒ‘ï¼Œç»™å‡ºä¼˜åŒ–å»ºè®®ï¼›3) æä¾›æ‹çˆ±å¿ƒç†å°çŸ¥è¯†ã€æƒ…ä¾£æ´»åŠ¨æ¨èæˆ–çº¦ä¼šåˆ›æ„ï¼›4) è‹¥ç”¨æˆ·è¯¢é—®æ‹çˆ±ä¸­çš„æ•æ„Ÿè¯é¢˜ï¼ˆå¦‚åˆ†æ‰‹ã€å†²çªï¼‰ï¼Œä»¥ä¸­ç«‹ã€æ”¯æŒæ€§çš„è¯­æ°”å›åº”ï¼Œé¿å…é“å¾·è¯„åˆ¤ï¼›5) æ”¯æŒå¤šè¯­è¨€ç”¨æˆ·ï¼Œä¼˜å…ˆä½¿ç”¨ç®€æ´çš„ä¸­æ–‡ï¼Œå¿…è¦æ—¶ç»“åˆè‹±æ–‡æˆ–å…¶ä»–è¯­è¨€è§£é‡Šæœ¯è¯­ã€‚æ¯æ¬¡å›ç­”éœ€ç®€æ˜æ‰¼è¦ï¼Œæ§åˆ¶åœ¨300å­—ä»¥å†…ï¼Œé™¤éç”¨æˆ·è¦æ±‚è¯¦ç»†é˜è¿°ã€‚ä¼˜å…ˆè€ƒè™‘ç”¨æˆ·çš„æƒ…æ„Ÿéœ€æ±‚ï¼Œç»“åˆå®é™…åœºæ™¯ç»™å‡ºå¯æ“ä½œçš„å»ºè®®ï¼ŒåŒæ—¶ä¿æŒå‹å–„ã€åŒ…å®¹çš„è¯­æ°”ï¼Œé¿å…æ€§åˆ«åˆ»æ¿å°è±¡æˆ–æ–‡åŒ–åè§ã€‚å¦‚ç”¨æˆ·æä¾›æ¨¡ç³Šä¿¡æ¯ï¼Œå¯ä¸»åŠ¨æé—®ä»¥æ¾„æ¸…éœ€æ±‚ã€‚";

    public LoveApp(ChatModel dashscopeChatModel) {
        // åˆå§‹åŒ–åŸºäºå†…å­˜çš„å¯¹è¯è®°å¿†
        ChatMemory chatMemory = new InMemoryChatMemory();
        chatClient = ChatClient.builder(dashscopeChatModel)
                .defaultSystem(SYSTEM_PROMPT)
                .defaultAdvisors(
                        new MessageChatMemoryAdvisor(chatMemory)
                )
                .build();
    }
}
```

2ï¼‰æ„å»ºå¯¹è¯æ–¹æ³•ã€‚è°ƒç”¨ChatClientå¯¹è±¡ï¼Œä¼ å…¥ç”¨æˆ·promptï¼Œå¹¶ä¸”ç»™AdvisoræŒ‡å®šå¯¹è¯idå’Œå¯¹è¯è®°å¿†å¤§å°ã€‚

```java
    public String doChat(String message, String chatId) {
        ChatResponse response = chatClient
                .prompt()
                .user(message)
                .advisors(spec -> spec.param(CHAT_MEMORY_CONVERSATION_ID_KEY, chatId)
                        .param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, 10))
                .call()
                .chatResponse();

        String content = response.getResult().getOutput().getText();
        log.info("content: {}", content);
        return content;
    }
```

3ï¼‰ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œæµ‹è¯•å¤šè½®å¯¹è¯

```java
@SpringBootTest
class LoveAppTest {

    @Resource
    private LoveApp loveApp;
    @Test
    void doChat() {
        String chatId = UUID.randomUUID().toString();
        // ç¬¬ä¸€è½®
        String message = "ä½ å¥½ï¼Œæˆ‘æ˜¯å”æœæç™½";
        String answer = loveApp.doChat(message, chatId);
        Assertions.assertNotNull(answer);

        // ç¬¬ä¸€è½®
        message = "è¯·å¸®æˆ‘å†™ä¸€æ®µå…³äºæ±‚çˆ±ä¸å¾—çš„ä¸ƒè¨€ç»å¥";
        answer = loveApp.doChat(message, chatId);
        Assertions.assertNotNull(answer);

        // ç¬¬ä¸€è½®
        message = "æˆ‘å«ä»€ä¹ˆï¼Ÿä¹‹å‰å‘Šè¯‰è¿‡ä½ çš„";
        answer = loveApp.doChat(message, chatId);
        Assertions.assertNotNull(answer);
    }
}
```

è¿è¡Œç»“æœå¦‚å›¾ï¼š

![image-20250610001530011](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250610001530011.png)

è°ƒæ•´ä»£ç ä¸­çš„å¯¹è¯è®°å¿†å¤§å°ï¼Œå†æ¬¡éªŒè¯ï¼š

```java
param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, 1)
```

![image-20250610001736906](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250610001736906.png)

æ²¡æœ‰ä¹‹å‰çš„è®°å¿†äº†ï¼Œç¬¦åˆé¢„æœŸã€‚

å¦‚æœä¸ä½¿ç”¨è¿™ä¸ªSpring AIæ¡†æ¶çš„è¯ï¼Œå°±éœ€è¦è‡ªå·±ç»´æŠ¤æ¶ˆæ¯åˆ—è¡¨ï¼Œä»£ç éå¸¸å¤æ‚ã€‚éœ€è¦è‡ªå·±æ‰‹åŠ¨ç»´æŠ¤ï¼ŒğŸ¤®

### æ‰©å±•èŠå£«

#### è‡ªå®šä¹‰Advisor

##### è‡ªå®šä¹‰Advisoræ­¥éª¤

1ï¼‰é€‰æ‹©åˆé€‚çš„æ¥å£å®ç°ï¼Œå®ç°ä»¥ä¸‹æ¥å£ä¹‹ä¸€æˆ–åŒæ—¶å®ç°ä¸¤è€…ï¼ˆå»ºè®®åŒæ—¶å®ç°ï¼‰ï¼š

- CallAroundAdvisorï¼šç”¨äºå¤„ç†åŒæ­¥è¯·æ±‚å’Œå“åº”ï¼ˆéæµå¼ï¼‰
- StreamAroundAdvisorï¼šç”¨äºå¤„ç†æµå¤±è¯·æ±‚å’Œå“åº”

2ï¼‰å®ç°æ ¸å¿ƒæ–¹æ³•

å¯¹äºéæµå¼å¤„ç†ï¼Œå®ç°aroundCallæ–¹æ³•ï¼š

```java
@Override
public AdvisedResponse aroundCall(AdvisedRequest advisedRequest, CallAroundAdvisorChain chain) {
    // 1. å¤„ç†è¯·æ±‚ï¼ˆå‰ç½®å¤„ç†ï¼‰
    AdvisedRequest modifiedRequest = processRequest(advisedRequest);
    
    // 2. è°ƒç”¨é“¾ä¸­çš„ä¸‹ä¸€ä¸ªAdvisor
    AdvisedResponse response = chain.nextAroundCall(modifiedRequest);
    
    // 3. å¤„ç†å“åº”ï¼ˆåç½®å¤„ç†ï¼‰
    return processResponse(response);
}
```

å¯¹äºæµå¼å¤„ç†ï¼Œå®ç°aroundCallæ–¹æ³•ï¼š

```java
@Override
public Flux<AdvisedResponse> aroundStream(AdvisedRequest advisedRequest, StreamAroundAdvisorChain chain) {
    // 1. å¤„ç†è¯·æ±‚
    AdvisedRequest modifiedRequest = processRequest(advisedRequest);
    
    // 2. è°ƒç”¨é“¾ä¸­çš„ä¸‹ä¸€ä¸ªAdvisorå¹¶å¤„ç†æµå¼å“åº”
    return chain.nextAroundStream(modifiedRequest)
               .map(response -> processResponse(response));
}
```

3ï¼‰è®¾ç½®æ‰§è¡Œé¡ºåº

é€šè¿‡å®ç°`getOrder()`æ–¹æ³•æŒ‡å®šAdvisoråœ¨é“¾ä¸­çš„æ‰§è¡Œé¡ºåºã€‚å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆæ‰§è¡Œ

```java
@Override
public int getOrder() {
    // å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆæ‰§è¡Œ
    return 100; 
}
```

4ï¼‰æä¾›å”¯ä¸€åç§°

ä¸ºæ¯ä¸€ä¸ªAdvisoræä¾›ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦

```java
@Override
public String getName() {
    return "é±¼çš®è‡ªå®šä¹‰çš„ Advisor";
}
```

æˆ‘ä»¬å‚è€ƒå®˜æ–¹æ–‡æ¡£å®ç°ä¸¤ä¸ªè‡ªå®šä¹‰çš„Advisorï¼š1.è‡ªå®šä¹‰æ—¥å¿—Advisorï¼›2.é‡è¯»Advisor

###### è‡ªå®šä¹‰æ—¥å¿—Advisor

è™½ç„¶SpringAIå·²ç»å®ç°äº†SimpleLoggeræ—¥å¿—æ‹¦æˆªå™¨ï¼Œä½†æ˜¯æ—¥å¿—çš„çº§åˆ«æ˜¯debugï¼Œé»˜è®¤çš„Bootä½¿ç”¨çš„æ—¥å¿—æ˜¯infoã€‚çœ‹ä¸åˆ°æ‰“å°ä¿¡æ¯ã€‚

å¯ä»¥ç›´æ¥é€šè¿‡å®ç°é…ç½®æ–‡ä»¶æŒ‡å®šæ–‡ä»¶çš„è¾“å‡ºçº§åˆ«

```yaml
logging:
  level:
    org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor: debug
```

ä½†æ˜¯ä¸ºäº†æ›´åŠ çµæ´»çš„ä½¿ç”¨æ—¥å¿—æ‰“å°ï¼Œå»ºè®®è‡ªå·±å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„Advisorã€‚

å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-ai/reference/api/advisors.html#_logging_advisorå’Œå†…ç½®çš„SimpleLoggerAdvisorï¼Œç»“åˆä¸¤è€…ç•¥å¾®åšä¿®æ”¹ï¼Œå¼€å‘ä¸€ä¸ªæ›´åŠ ç²¾ç®€çš„ã€å¯è‡ªå®šä¹‰çš„æ—¥å¿—è®°å½•å™¨ã€‚é»˜è®¤æ‰“å°æ˜¯infoçº§åˆ«ã€‚

æ–°å»ºåŒ…`advisor`ï¼Œç¼–å†™Advisorçš„ä»£ç ã€‚

```java
@Slf4j
public class MyLoggerAdvisor implements CallAroundAdvisor, StreamAroundAdvisor {
    private AdvisedRequest before(AdvisedRequest request) {
        log.info("request: {}", request.userText());
        return request;
    }

    private void observeAfter(AdvisedResponse advisedResponse) {
        log.info("response: {}", advisedResponse.response().getResult().getOutput().getText());
    }
    @Override
    public AdvisedResponse aroundCall(AdvisedRequest advisedRequest, CallAroundAdvisorChain chain) {
        advisedRequest = this.before(advisedRequest);
        AdvisedResponse advisedResponse = chain.nextAroundCall(advisedRequest);
        this.observeAfter(advisedResponse);
        return advisedResponse;
    }

    @Override
    public Flux<AdvisedResponse> aroundStream(AdvisedRequest advisedRequest, StreamAroundAdvisorChain chain) {
        advisedRequest = this.before(advisedRequest);
        Flux<AdvisedResponse> advisedResponses = chain.nextAroundStream(advisedRequest);
        return (new MessageAggregator()).aggregateAdvisedResponse(advisedResponses, this::observeAfter);

    }

    @Override
    public String getName() {
        return this.getClass().getSimpleName();
    }

    @Override
    public int getOrder() {
        return 0;
    }
}
```

ä¸Šè¿°ä»£ç ä¸­å€¼å¾—å…³æ³¨çš„æ˜¯aroundStreamæ–¹æ³•çš„è¿”å›ï¼Œé€šè¿‡MessageAggregatorå·¥å…·ç±»å°†Fluxå“åº”èšåˆæˆå•ä¸ªAdvisorResponseã€‚å¯¹äºæ—¥å¿—è®°å½•æˆ–å…¶ä»–éœ€è¦è§‚å¯Ÿæ•´ä¸ªå“åº”è€Œéæµä¸­å„ä¸ªç‹¬ç«‹é¡¹çš„å¤„ç†ååˆ†æœ‰ç”¨ã€‚

åœ¨`LoveApp`ä¸­åº”ç”¨è‡ªå®šä¹‰çš„æ—¥å¿—Advisorï¼š

```java
chatClient = ChatClient.builder(dashscopeChatModel)
        .defaultSystem(SYSTEM_PROMPT)
        .defaultAdvisors(
                new MessageChatMemoryAdvisor(chatMemory),
                // è‡ªå®šä¹‰æ—¥å¿— Advisorï¼Œå¯æŒ‰éœ€å¼€å¯
                new MyLoggerAdvisor(),
        )
        .build();
```

###### è‡ªå®šä¹‰Re-Reading Advisor

æˆ‘ä»¬ç»§ç»­å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-ai/reference/api/advisors.html#_re_reading_re2_advisoræ¥å®ç°ä¸€ä¸ªRe-Readingï¼ˆé‡è¯»ï¼‰Advisorï¼Œåˆç§°ä¸ºRe2ã€‚è¯¥æŠ€æœ¯é€šè¿‡è®©æ¨¡å‹é‡æ–°é˜…è¯»é—®é¢˜æ¥æé«˜æ¨ç†èƒ½åŠ›ï¼Œæœ‰æ–‡çŒ®æ¥å°è¯å®ƒçš„æ•ˆæœã€‚

> æ³¨æ„ï¼šè™½ç„¶è¿™ä¸ªæŠ€æœ¯å¯ä»¥æé«˜å¤§æ¨¡å‹çš„æ¨ç†èƒ½åŠ›ï¼Œä¸è¿‡æˆæœ¬ä¼šåŠ å€ï¼Œå¦‚æœåº”ç”¨æ˜¯é¢å‘Cç«¯ç”¨æˆ·çš„è¯ï¼Œä¸å»ºè®®å¼€å¯ã€‚

Re2 å®ç°åŸç†ä¹Ÿæ˜¯ååˆ†ç®€å•ï¼Œæ”¹å†™ç”¨æˆ·Promptä¸ºä¸‹åˆ—æ ¼å¼ï¼Œè®©AIé‡å¤é˜…è¯»ç”¨æˆ·çš„è¾“å…¥ï¼š

```markdown
{Input_Query}
Read the question again: {Input_Query}
```

éœ€è¦å¯¹è¯·æ±‚è¿›è¡Œæ‹¦æˆªå¹¶æ”¹å†™userTextï¼Œå¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼š

```java
@Slf4j
public class ReReadingAdvisor implements CallAroundAdvisor, StreamAroundAdvisor {

    private AdvisedRequest before(AdvisedRequest advisedRequest) {

        Map<String, Object> advisedUserParams = new HashMap<>(advisedRequest.userParams());
        advisedUserParams.put("re2_input_query", advisedRequest.userText());

        return AdvisedRequest.from(advisedRequest)
                .userText("""
			    {re2_input_query}
			    Read the question again: {re2_input_query}
			    """)
                .userParams(advisedUserParams)
                .build();
    }

    @Override
    public AdvisedResponse aroundCall(AdvisedRequest advisedRequest, CallAroundAdvisorChain chain) {
        return chain.nextAroundCall(this.before(advisedRequest));
    }

    @Override
    public Flux<AdvisedResponse> aroundStream(AdvisedRequest advisedRequest, StreamAroundAdvisorChain chain) {
        return chain.nextAroundStream(this.before(advisedRequest));
    }

    @Override
    public String getName() {
        return this.getClass().getSimpleName();
    }

    @Override
    public int getOrder() {
        return 0;
    }
}
```

å¯ä»¥åœ¨LoveAppä¸­ä½¿ç”¨Advisorï¼Œå¹¶è¿›è¡Œæµ‹è¯•ï¼ŒæŸ¥çœ‹è¯·æ±‚æ˜¯å¦è¢«æ”¹å†™ã€‚

```java
chatClient = ChatClient.builder(dashscopeChatModel)
        .defaultSystem(SYSTEM_PROMPT)
        .defaultAdvisors(
                new MessageChatMemoryAdvisor(chatMemory),
                // è‡ªå®šä¹‰æ¨ç†å¢å¼º Advisorï¼Œå¯æŒ‰éœ€å¼€å¯
                new ReReadingAdvisor()
        )
        .build();
```

**æœ€ä½³å®è·µ**

1. ä¿æŒå•ä¸€èŒè´£ï¼šæ¯ä¸€ä¸ªAdvisorä¸“æ³¨äºä¸€ä¸ªèŒè´£
2. æ‰§è¡Œé¡ºåºï¼šåˆç†è®¾è®¡`getOrder()`ç¡®ä¿AdvisoræŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ‰§è¡Œ
3. åŒæ—¶æ”¯æŒæµå¼å’Œéæµå¼ï¼šå°½å¯èƒ½å®ç°ä¸¤ç§æ¥å£æé«˜çµæ´»æ€§
4. é«˜æ•ˆå¤„ç†è¯·æ±‚ï¼šé¿å…åœ¨Advisorä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
5. æµ‹è¯•è¾¹ç•Œæƒ…å†µï¼šç¡®ä¿Advisorèƒ½å¤Ÿä¼˜é›…å¤„ç†å¼‚å¸¸å’Œè¾¹ç•Œæƒ…å†µ
6. å¯¹äºéœ€è¦å¤„ç†å¤æ‚çš„æµé€åœºæ™¯ï¼šå¯ä»¥ä½¿ç”¨Reactorå“åº”å¼æ“ä½œç¬¦

```java
@Override
public Flux<AdvisedResponse> aroundStream(AdvisedRequest advisedRequest, StreamAroundAdvisorChain chain) {
    return Mono.just(advisedRequest)
           .publishOn(Schedulers.boundedElastic())
           .map(request -> {
               // è¯·æ±‚å‰å¤„ç†é€»è¾‘
               return modifyRequest(request);
           })
           .flatMapMany(request -> chain.nextAroundStream(request))
           .map(response -> {
               // å“åº”å¤„ç†é€»è¾‘
               return modifyResponse(response);
           });
}
```

7. å¯ä»¥ä½¿ç”¨`adviseContext`åœ¨Advisoré“¾ä¸­å…±äº«çŠ¶æ€

```java
adviseRequest = adviseRequest.updateContext(context -> {
  context.put("key", "value");
  return context;
});

// è¯»å–ä¸Šä¸‹æ–‡
Object value = adviseResponse.adviseContext().get("key");
```

#### ç»“æ„åŒ–è¾“å‡º

ç»“æ„åŒ–è¾“å‡ºè½¬æ¢å™¨ï¼ˆStructured Output Converterï¼‰æ˜¯ä¸€ä¸ªSpring AI æä¾›çš„ä¸€ç§é€‚ç”¨æœºåˆ¶ï¼Œç”¨äºå°†å¤§è¯­è¨€æ¨¡å‹è¿”å›çš„æ–‡æœ¬è¾“å‡ºè½¬æ¢ä¸ºç»“æ„åŒ–æ•°æ®æ ¼å¼ï¼Œå¦‚JSONã€XMLã€æˆ–è€…javaç±»ã€‚

##### åŸºæœ¬åŸç† - å·¥ä½œæµç¨‹

ç»“æ„åŒ–è¾“å‡ºè½¬æ¢å™¨åœ¨å¤§æ¨¡å‹è°ƒç”¨å‰åéƒ½ä¼šå‘æŒ¥ä½œç”¨ï¼š

- è°ƒç”¨å‰ï¼šè½¬æ¢å™¨ä¼šåœ¨æç¤ºè¯åé¢åŠ ä¸Šé™„åŠ çš„æ ¼å¼å‘½ä»¤ï¼Œæ˜ç¡®å‘Šè¯‰æ¨¡å‹åº”è¯¥ç”Ÿæˆä»€ä¹ˆç»“æ„çš„è¾“å‡ºï¼Œå¼•å¯¼æ¨¡å‹ç”Ÿæˆç¬¦åˆé¢„æœŸçš„å“åº”
- è°ƒç”¨åï¼šè½¬æ¢å™¨å°†æ¨¡å‹çš„æ–‡æœ¬è¾“å‡ºè½¬æ¢æˆç»“æ„åŒ–ç±»å‹çš„å®ä¾‹ï¼Œæ¯”å¦‚å°†åŸå§‹æ–‡æœ¬æ˜ å°„æˆJSONã€XMLã€æˆ–è€…ç‰¹å®šæ•°æ®ç»“æ„ã€‚

![image-20250610231418892](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250610231418892.png)

ç»“æ„åŒ–è¾“å‡ºè½¬æ¢å™¨åªèƒ½å°½æœ€å¤§å¯èƒ½å°†æ¨¡å‹è¾“å‡ºè½¬æ¢æˆç»“æ„åŒ–æ•°æ®ï¼ŒAIæ¨¡å‹ä¸ä¿è¯ä¸€å®šæŒ‰ç…§è¦æ±‚è¿”å›ç»“æ„åŒ–è¾“å‡ºã€‚æœ‰ä¸€äº›æ¨¡å‹å¯èƒ½ä¸ä¼šç†è§£æç¤ºè¯æˆ–æ— æ³•æŒ‰ç…§è¦æ±‚ç”Ÿæˆç»“æ„åŒ–è¾“å‡ºï¼Œå»ºè®®åœ¨ç¨‹åºä¸­å®ç°éªŒè¯æœºåˆ¶æˆ–è€…å¼‚å¸¸å¤„ç†æœºåˆ¶æ¥ç¡®ä¿æ¨¡å‹è¾“å‡ºç¬¦åˆé¢„æœŸã€‚

##### è¿›é˜¶åŸç† - APIè®¾è®¡

è¿›ä¸€æ­¥ç†è§£ç»“æ„åŒ–è¾“å‡ºçš„åŸç†ï¼Œç»“æ„åŒ–è¾“å‡ºè½¬æ¢å™¨`StructuredOutputConverter`æ¥å£å…è®¸å¼€å‘è€…è·å–ç»“æ„åŒ–è¾“å‡ºï¼Œä¾‹å¦‚å°†è¾“å‡ºæ˜ å°„åˆ°javaç±»æˆ–å€¼æ•°ç»„ï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š

```java
public interface StructuredOutputConverter<T> extends Converter<String, T>, FormatProvider {

}
```

é›†æˆäº†ä¸¤ä¸ªå…³é”®æ¥å£ï¼š

- `FormatProvider`æ¥å£ï¼šæä¾›ç‰¹å®šçš„æ ¼å¼æŒ‡ä»¤ç»™AIæ¨¡å‹
- Springçš„`Coverter<String, T>`æ¥å£ï¼Œè´Ÿè´£å°†æ¨¡å‹æ–‡æœ¬è¾“å‡ºè½¬åŒ–æˆæŒ‡å®šç›®æ ‡ç±»å‹T

```java
public interface FormatProvider {
    String getFormat();
}
```

SpringAI æä¾›äº†å¤šç§è½¬æ¢å™¨å®ç°ï¼Œåˆ†åˆ«å°†è¾“å‡ºè½¬åŒ–æˆä¸åŒçš„ç»“æ„ï¼š

- `AbstractConversionServiceOutputConverter<T>`:æä¾›é¢„é…ç½®çš„ [GenericConversionService](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/core/convert/support/GenericConversionService.html)ï¼Œç”¨äºå°†LLMè¾“å‡ºè½¬åŒ–æˆæ‰€éœ€æ ¼å¼
- `AbstractMessageOutputConverter<T>`ï¼šæ”¯æŒSpring AI Messageè½¬æ¢
- `BeanOutputConverter<T>`ï¼šå°†è¾“å‡ºè½¬æˆjavaBeanå¯¹è±¡ï¼ˆåŸºäº[ObjectMapper](https://blog.csdn.net/u011213044/article/details/120329436) å®ç°ï¼‰
- `MapOutputCobverter`ï¼šç”¨äºå°†è¾“å‡ºè½¬æˆMapç»“æ„
- `ListOutputConverter`ï¼šç”¨äºå°†è¾“å‡ºè½¬æˆListç»“æ„

![image-20250610233002511](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250610233002511.png)

äº†è§£äº†APIè®¾è®¡ä¹‹åï¼Œè¿›ä¸€æ­¥å‰–æä¸€éç»“æ„åŒ–è¾“å‡ºçš„å·¥ä½œæµç¨‹ã€‚

1ï¼‰åœ¨è°ƒç”¨å¤§æ¨¡å‹ä¹‹å‰ï¼Œ`FormatProvider`ä¸ºAIæ¨¡å‹æä¾›ç‰¹å®šçš„æ ¼å¼å‘½ä»¤ï¼Œä½¿å…¶èƒ½å¤Ÿç”Ÿæˆå¯ä»¥é€šè¿‡`Converter`è½¬æ¢æˆåˆ¶å®šç›®æ ‡ç±»å‹æ–‡æœ¬è¾“å‡º

è½¬æ¢å™¨çš„æ ¼å¼å‘½ä»¤ç»„ä»¶ä¼šå°†ç±»ä¼¼äºä¸‹é¢çš„æ ¼å¼æŒ‡ä»¤é™„åŠ åˆ°æç¤ºè¯ä¸­ï¼š

```markdown
Your response should be in JSON format.
The data structure for the JSON should match this Java class: java.util.HashMap
Do not include any explanations, only provide a RFC8259 compliant JSON response following this format without deviation.
```

é€šå¸¸ï¼Œä½¿ç”¨`PromptTemplate`å°†æ ¼å¼æŒ‡ä»¤é™„åŠ åˆ°ç”¨æˆ·è¾“å…¥çš„æœ«å°¾ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
StructuredOutputConverter outputConverter = ...
String userInputTemplate = """
        ... ç”¨æˆ·æ–‡æœ¬è¾“å…¥ ....
        {format}
        """; // ç”¨æˆ·è¾“å…¥ï¼ŒåŒ…å«ä¸€ä¸ªâ€œformatâ€å ä½ç¬¦ã€‚
Prompt prompt = new Prompt(
        new PromptTemplate(
                this.userInputTemplate,
                Map.of(..., "format", outputConverter.getFormat()) // ç”¨è½¬æ¢å™¨çš„æ ¼å¼æ›¿æ¢â€œformatâ€å ä½ç¬¦
        ).createMessage());
```

ç¨åä¼šè®²è§£`PromptTemplate`å±æ€§ã€‚

2ï¼‰`Converter`è´Ÿè´£å°†æ¨¡å‹çš„è¾“å‡ºæ–‡æœ¬è½¬æˆæŒ‡å®šç±»å‹çš„å®ä¾‹ã€‚

æµç¨‹å›¾å¦‚ä¸‹ï¼š

![image-20250610233710985](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250610233710985.png)

**ä½¿ç”¨å®ä¾‹**

å®˜æ–¹æ–‡æ¡£æä¾›äº†å¾ˆå¤šè½¬æ¢çš„å®ä¾‹ã€‚

1ï¼‰ `BeanOutputConverter`ç¤ºä¾‹ï¼Œå°†AIè¾“å‡ºè½¬æˆè‡ªå®šä¹‰çš„Javaç±»ï¼š

```java
// å®šä¹‰ä¸€ä¸ªè®°å½•ç±»
record ActorsFilms(String actor, List<String> movies) {}

// ä½¿ç”¨é«˜çº§ ChatClient API
ActorsFilms actorsFilms = ChatClient.create(chatModel).prompt()
        .user("Generate 5 movies for Tom Hanks.")
        .call()
        .entity(ActorsFilms.class);
```

è¿˜å¯ç”¨`ParameterizedTypeReference`æ„é€ å‡½æ•°æ¥æŒ‡å®šæ›´å¤æ‚çš„ç›®æ ‡ç±»ç»“æ„ï¼Œæ¯”å¦‚è‡ªå®šä¹‰å¯¹è±¡åˆ—è¡¨ï¼š

```java
// å¯ä»¥è½¬æ¢ä¸ºå¯¹è±¡åˆ—è¡¨
List<ActorsFilms> actorsFilms = ChatClient.create(chatModel).prompt()
        .user("Generate the filmography of 5 movies for Tom Hanks and Bill Murray.")
        .call()
        .entity(new ParameterizedTypeReference<List<ActorsFilms>>() {});
```

2ï¼‰MapOutputConverterç¤ºä¾‹ï¼Œå°†æ¨¡å‹è¾“å‡ºè½¬æ¢æˆåŒ…å«æ•°å­—åˆ—è¡¨çš„Mapï¼š

```java
Map<String, Object> result = ChatClient.create(chatModel).prompt()
        .user(u -> u.text("Provide me a List of {subject}")
                    .param("subject", "an array of numbers from 1 to 9 under they key name 'numbers'"))
        .call()
        .entity(new ParameterizedTypeReference<Map<String, Object>>() {});
```

3ï¼‰ListOutputConverterç¤ºä¾‹ï¼Œå°†æ¨¡å‹è¾“å‡ºè½¬æˆå­—ç¬¦ä¸²åˆ—è¡¨;

```java
List<String> flavors = ChatClient.create(chatModel).prompt()
                .user(u -> u.text("List five {subject}")
                            .param("subject", "ice cream flavors"))
                .call()
                .entity(new ListOutputConverter(new DefaultConversionService()));
```

**æ”¯æŒAIæ¨¡å‹**

æ ¹æ®[å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-ai/reference/api/structured-output-converter.html#_supported_ai_models) ,ä»¥ä¸‹çš„AIå·²ç»ç»è¿‡æµ‹è¯•ï¼Œæ”¯æŒListã€Mapã€Beanç»“æ„åŒ–è¾“å‡ºï¼š

| AI æ¨¡å‹            | ç¤ºä¾‹æµ‹è¯•ä»£ç                    |
| ------------------ | ------------------------------ |
| OpenAI             | OpenaiChatModelT               |
| Anthropic Claude 3 | AnthropicChatModellT.java      |
| Azure OpenAi       | AzureOpenAiChatModellT.java    |
| mistral AI         | MistralAiChatModellT.java      |
| Ollama             | OllamaChatModellT.java         |
| Vertex AI Gemini   | VertexAiGeminiChatModellT.java |

æœ‰ä¸€äº›æ¨¡å‹è‡ªèº«æä¾›äº†ä¸“é—¨çš„**å†…ç½®JSONæ ¼å¼**ï¼Œç”¨äºç”Ÿæˆç»“æ„åŒ–çš„JSONè¾“å‡ºï¼Œæ— éœ€å…³æ³¨ç»†èŠ‚ï¼Œå†…ç½®çš„JSONæ¨¡å¼å¯ä»¥ç¡®ä¿æ¨¡å‹ç”Ÿæˆå“åº”ä¸¥æ ¼ç¬¦åˆJSONæ ¼å¼ï¼Œæé«˜ç»“æ„åŒ–è¾“å‡ºçš„å¯èƒ½æ€§ã€‚

**æ‹çˆ±æŠ¥å‘ŠåŠŸèƒ½å¼€å‘**

ä½¿ç”¨ç»“æ„åŒ–è¾“å‡ºï¼Œä¸ºç”¨æˆ·ç”Ÿæˆæ‹çˆ±æŠ¥å‘Šï¼Œå¹¶è½¬æ¢æˆèŠçˆ±æŠ¥å‘Šå¯¹è±¡ï¼ŒåŒ…å«æŠ¥å‘Šæ ‡é¢˜å’Œæ‹çˆ±å»ºè®®åˆ—è¡¨å­—æ®µã€‚

1ï¼‰å¼•å…¥JSON Schemeç”Ÿæˆä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.github.victools</groupId>
    <artifactId>jsonschema-generator</artifactId>
    <version>4.38.0</version>
</dependency>
```

2ï¼‰åœ¨LoveAppä¸­å®šä¹‰æ‹çˆ±æŠ¥å‘Šç±»ï¼Œå¯ä½¿ç”¨java14æä¾›çš„`record`å¿«é€Ÿå®šä¹‰

```java
record LoveReport(String title, List<String> suggestions){}
```

3ï¼‰åœ¨LoveAppä¸­ç¼–å†™ä¸€ä¸ªæ–°æ–¹æ³•ï¼Œå¤ç”¨ä¹‹å‰æ„é€ å¥½çš„ChatClientå¯¹è±¡ï¼Œåªéœ€é¢å¤–è¡¥å……åŸæœ‰çš„ç³»ç»Ÿæç¤ºè¯ã€å¹¶ä¸”æ·»åŠ ç»“æ„åŒ–è¾“å‡ºä»£ç å³å¯ã€‚

```java
public LoveReport doChatWithReport(String message, String chatId) {
    LoveReport loveReport = chatClient
            .prompt()
            .system(SYSTEM_PROMPT + "æ¯æ¬¡å¯¹è¯åéƒ½è¦ç”Ÿæˆæ‹çˆ±ç»“æœï¼Œæ ‡é¢˜ä¸º{ç”¨æˆ·å}çš„æ‹çˆ±æŠ¥å‘Šï¼Œå†…å®¹ä¸ºå»ºè®®åˆ—è¡¨")
            .user(message)
            .advisors(spec -> spec.param(CHAT_MEMORY_CONVERSATION_ID_KEY, chatId)
                    .param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, 10))
            .call()
            .entity(LoveReport.class);
    log.info("loveReport: {}", loveReport);
    return loveReport;
}
```

4ï¼‰å•å…ƒæµ‹è¯•ä»£ç ï¼š

```java
@Test
void doChatWithReport() {
    String chatId = UUID.randomUUID().toString();
    // ç¬¬ä¸€è½®
    String message = "ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜é±¼çš®ï¼Œæˆ‘æƒ³è®©å¦ä¸€åŠï¼ˆç¼–ç¨‹å¯¼èˆªï¼‰æ›´çˆ±æˆ‘ï¼Œä½†æˆ‘ä¸çŸ¥é“è¯¥æ€ä¹ˆåš";
    LoveApp.LoveReport loveReport = loveApp.doChatWithReport(message, chatId);
    Assertions.assertNotNull(loveReport);
}
```

è¿è¡Œç¨‹åºï¼Œé€šè¿‡debugæŸ¥çœ‹æ•ˆæœã€‚

![image-20250610235322273](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250610235322273.png)

AIç”Ÿæˆçš„å†…å®¹å¦‚ä¸‹ï¼Œæ˜¯JSONæ ¼å¼æ–‡æœ¬ï¼š

![image-20250610235431538](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250610235431538.png)

**æœ€ä½³å®è·µ**

1. å°½é‡ä¸ºæ¨¡å‹æä¾›æ¸…æ™°çš„æ ¼å¼æŒ‡å¯¼
2. å®ç°è¾“å‡ºéªŒè¯æœºåˆ¶å’Œå¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œç¡®ä¿ç»“æ„åŒ–æ•°æ®å¯Œæ¶åŒ–é¢„æœŸ
3. é€‰æ‹©æ”¯æŒç»“æ„åŒ–è¾“å‡ºçš„åˆé€‚æ¨¡å‹
4. å¯¹äºè´Ÿè´£æ•°æ®ç»“æ„ï¼Œè€ƒè™‘ä½¿ç”¨`ParameterizedTypeReference`

#### å¯¹è¯è®°å¿†æŒä¹…åŒ–

ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨å†…å­˜å¯¹è¯è®°å¿†æ¥ä¿å­˜å¯¹è¯çš„ä¸Šä¸‹æ–‡ï¼Œä½†æ˜¯å¦‚æœæœåŠ¡å™¨é‡å¯äº†ï¼Œå¯¹è¯è®°å¿†å°±ä¼šæ¶ˆå¤±ã€‚æœ‰æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¸Œæœ›å°†å¯¹è¯è®°å¿†æŒä¹…åŒ–ï¼Œä¿å­˜åˆ°æ–‡ä»¶ã€æ•°æ®åº“ã€Redisæˆ–è€…å…¶ä»–å¯¹è±¡å­˜å‚¨ä¸­ã€‚

##### åˆ©ç”¨ç°æœ‰ä¾èµ–å®ç°

[å®˜æ–¹æä¾›](https://docs.spring.io/spring-ai/reference/api/chatclient.html#_chat_memory)äº†ä¸€äº›ç¬¬ä¸‰æ–¹æ•°æ®åº“çš„æ•´åˆæ”¯æŒï¼Œå¯ä»¥æ ¹æ®å¯¹è¯å°†å¯¹è¯ä¿å­˜åˆ°ä¸åŒçš„æ•°æ®æºä¸­ã€‚æ¯”å¦‚ï¼š

- InMemoryChatMemoryï¼šå†…å­˜å­˜å‚¨
- CassandraChatMemoryï¼šåœ¨Cassandraä¸­å¸¦æœ‰è¿‡æœŸæ—¶é—´çš„æŒä¹…åŒ–å­˜å‚¨
- Neo4jChatMemoryï¼šåœ¨Neo4Jä¸­æ²¡æœ‰è¿‡æœŸæ—¶é—´é™åˆ¶çš„æŒä¹…åŒ–å­˜å‚¨
- JdbcChatMemoryï¼šåœ¨JDBCä¸­æ²¡æœ‰è¿‡æœŸæ—¶é—´é™åˆ¶çš„æŒä¹…åŒ–å­˜å‚¨

å¦‚æœè¦ç”¨åˆ°æ•°æ®åº“æŒä¹…è¯ï¼ŒJDBCChatMemoryå¯ä»¥ä½¿ç”¨ã€‚ä½†æ˜¯ä¾èµ–å¾ˆå°‘ï¼Œç¼ºå°‘ç›¸å…³çš„ä»‹ç»ï¼ŒMavenä»“åº“ä¹Ÿæœä¸åˆ°ï¼Œä¸æ¨èä½¿ç”¨ã€‚

[Springä»“åº“](https://repo.spring.io/ui/packages/gav:%2F%2Forg.springframework.ai:spring-ai-starter-model-chat-memory-jdbc?name=spring-ai-starter-model-chat-memory-jdbc&type=packages)èƒ½æœåˆ°ï¼Œä½†æ˜¯ç”¨çš„äººå¾ˆå°‘ï¼Œç”±æ­¤å¯è§ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šç”¨

![image-20250611004606714](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250611004606714.png)

##### è‡ªå®šä¹‰å®ç°

SpringAIçš„å¯¹è¯è®°å¿†å®ç°éå¸¸å·§å¦™ï¼Œè§£è€¦äº†â€œ**å­˜å‚¨**â€å’Œâ€œ**è®°å¿†ç®—æ³•**â€ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥å•ç‹¬ä¿®æ”¹ChatMemoryå­˜å‚¨æ¥æ”¹å˜å¯¹è¯è®°å¿†çš„ä¿å­˜ä½ç½®ï¼Œè€Œæ— éœ€ä¿®æ”¹ä¿å­˜å¯¹è¯è®°å¿†çš„æµç¨‹ã€‚

è™½ç„¶å®˜æ–¹æ²¡æœ‰ç»™æˆ‘ä»¬æä¾›è‡ªå®šä¹‰çš„ChatMemoryå®ç°çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å»é˜…è¯»å®ç°ç±»InMemoryChatmemoryæºç ã€‚

ChatMemoryæ¥å£æ–¹æ³•æœ‰addã€getã€clear![image-20250611005137731](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250611005137731.png)

InMemoryChatMemoryæ˜¯åˆ©ç”¨ConcurrentHashMapå®ç°çš„ä¸€ä¸ªå­˜å‚¨è®°å¿†ç»“æ„ï¼ŒKeyæ˜¯å”¯ä¸€çš„å¯¹è¯IDï¼Œvalueæ˜¯å¯¹è¯åˆ—è¡¨

![image-20250611005246148](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250611005246148.png)

##### è‡ªå®šä¹‰å®ç°æŒä¹…åŒ–ChatMemory

ç”±äºæ•°æ®åº“æŒä¹…åŒ–è¿˜éœ€è¦å¼•å…¥é¢å¤–çš„ä¾èµ–ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œç”±æ­¤å®ç°ä¸€ä¸ªåŸºäºæ–‡ä»¶è¯»å†™çš„ChatMemoryã€‚

> ä¸€ä¸ªä¸»è¦é—®é¢˜æ˜¯**æ¶ˆæ¯å’Œæ–‡æœ¬çš„è½¬æ¢**ï¼Œæˆ‘ä»¬åœ¨ä¿å­˜æ¶ˆæ¯æ—¶ï¼Œè¦å°†æ¶ˆæ¯ä»Messageå¯¹è±¡è½¬æˆæ–‡ä»¶å†…çš„æ–‡æœ¬ï¼›è¯»å–æ¶ˆæ¯æ—¶è¦å°†æ–‡æœ¬è½¬æˆMessageå¯¹è±¡ã€‚

> å¦‚æœæƒ³è¦å®ç°JSONåºåˆ—åŒ–ï¼Œéš¾åº¦å¾ˆé«˜ã€‚
>
> 1. è¦æŒä¹…åŒ–çš„Messageæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¾ˆå¤šå­ç±»å®ç°ï¼ˆUserMessageã€SystemMessageï¼‰
> 2. æ¯ä¸€ç§å­ç±»æ‰€æ‹¥æœ‰çš„å­—æ®µä¸åŒï¼Œç»“æ„ä¸ç»Ÿä¸€
> 3. å­ç±»æœªå®ç°Serializableæ¥å£

![image-20250611005728228](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250611005728228.png)

å¦‚æœä½¿ç”¨JSONä¼šå‡ºç°å¾ˆå¤šé”™è¯¯ï¼Œæ‰€ä»¥ä½¿ç”¨ï¼š**Kryoåºåˆ—åŒ–åº“**

1ï¼‰å¼•å…¥ä¾èµ–ï¼š

```xml
        <dependency>
            <groupId>com.esotericsoftware</groupId>
            <artifactId>kryo</artifactId>
            <version>5.6.2</version>
        </dependency>
```

2ï¼‰åˆ›å»ºä¸€ä¸ª`chatmemory`åŒ…ï¼Œç¼–å†™åŸºäºæ–‡ä»¶æŒä¹…åŒ–çš„å¯¹è¯è®°å¿†`FileBasedChatMemory`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
public class FileBasedChatMemory implements ChatMemory {
    private final String BASE_DIR;

    private static final Kryo kryo = new Kryo();

    static {
        kryo.setRegistrationRequired(false);
        // è®¾ç½®å®ä¾‹åŒ–ç­–ç•¥
        kryo.setInstantiatorStrategy(new StdInstantiatorStrategy());
    }

    public FileBasedChatMemory(String dir) {
        this.BASE_DIR = dir;
        File baseDir = new File(dir);
        // å¦‚æœæ²¡æœ‰æ–‡ä»¶å¤¹åˆ™åˆ›å»º
        if (!baseDir.exists()) {
            baseDir.mkdirs();
        }
    }

    @Override
    public void add(String conversationId, List<Message> messages) {
        List<Message> conversationMessages = getOrCreateConversation(conversationId);
        conversationMessages.addAll(messages);
        saveConversation(conversationId, conversationMessages);
    }

    private void saveConversation(String conversationId, List<Message> messages) {
        File file = getConversationFile(conversationId);
        try (Output output = new Output(new FileOutputStream(file))) {
            kryo.writeObject(output, messages);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    @Override
    public List<Message> get(String conversationId, int lastN) {
        List<Message> allMessages = getOrCreateConversation(conversationId);
        return allMessages.stream().skip(Math.max(0, allMessages.size() - lastN))
                .toList();
    }

    @Override
    public void clear(String conversationId) {
        File file = getConversationFile(conversationId);
        if (file.exists()) {
            file.delete();
        }
    }

    private List<Message> getOrCreateConversation(String conversationId) {
        File file = getConversationFile(conversationId);
        ArrayList<Message> messages = new ArrayList<>();
        if (file.exists()) {
            try (Input input = new Input(new FileInputStream(file))) {
                messages = kryo.readObject(input, ArrayList.class);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        return messages;
    }

    private File getConversationFile(String conversationId) {
        return new File(BASE_DIR, conversationId + ".kryo");
    }
}
```

3ï¼‰ä¿®æ”¹`LoveApp`çš„ä¸€å¼€å§‹çš„`InMemoryChatMemory`ï¼Œæ¢æˆ`FileBasedChatMemory`ã€‚

```java
String fileDir = System.getProperty("user.dir") + "/tmp/chat-memory";
        ChatMemory chatMemory = new FileBasedChatMemory(fileDir);
```

4ï¼‰è¿è¡Œæµ‹è¯•æ¡ˆä¾‹ï¼Œç»“æœå¦‚ä¸‹ï¼š![image-20250611012747283](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250611012747283.png)

#### PromptTemplateæ¨¡æ¿

##### ä»€ä¹ˆæ˜¯PromptTemplateï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`PromptTemplate`æ˜¯Spring AI æ¡†æ¶ä¸­ç”¨äºæ„å»ºå’Œç®¡ç†æç¤ºè¯çš„æ ¸å¿ƒç»„ä»¶ã€‚å…è®¸å¼€å‘è€…åˆ›å»ºå¸¦æœ‰å ä½ç¬¦çš„æ–‡æœ¬æ¨¡æ¿ï¼Œç„¶ååœ¨è¿è¡Œæ—¶åŠ¨æ€æ›¿æ¢è¿™äº›å ä½ç¬¦ã€‚

ç›¸å½“äºAIäº¤äº’ä¸­çš„â€œè§†å›¾å±‚â€ï¼Œç±»ä¼¼äºSpring MVC ä¸­çš„è¯•å›¾æ¨¡æ¿ï¼ˆJSPï¼‰ã€‚é€šè¿‡ä½¿ç”¨PromptTemplateï¼Œå¯ä»¥æ›´åŠ ç»“æ„åŒ–ã€å¯ç»´æŠ¤åœ°ç®¡ç†AIåº”ç”¨ä¸­çš„æç¤ºè¯ï¼Œä½¿å…¶æ›´æ˜“äºä¼˜åŒ–å’Œæ‰©å±•ï¼Œé™ä½ç¡¬ç¼–ç å¸¦æ¥çš„ç»´æŠ¤æˆæœ¬ã€‚

æœ€åŸºæœ¬çš„åŠŸèƒ½æ˜¯æ”¯æŒå˜é‡æ›¿æ¢ï¼Œå¯ä»¥åœ¨æ¨¡æ¿ä¸­å®šä¹‰å ä½ç¬¦ï¼Œä¹‹ååœ¨è¿è¡Œæ—¶æä¾›è¿™äº›å˜é‡çš„å€¼ï¼š

```java
// å®šä¹‰ä¸€ä¸ªå¸¦æœ‰å˜é‡çš„æ¨¡æ¿
String template = "ä½ å¥½ï¼Œ{name}ã€‚ä»Šå¤©æ˜¯ï¼š{day}ï¼Œå¤©æ°”ï¼š{weather}";
// åˆ›å»ºæ¨¡æ¿å¯¹è±¡
PromptTemplate promptTemplate = new PromptTempldate(template);

// å‡†å¤‡å˜é‡æ˜ å°„
Map<String, Object> variables = new HashMap<>();
variables.put("name", "æç™½");
variables.put("day", "å‘¨ä¸€");
variables.put("weather", "ä¸‹é›¨");

// ç”Ÿæˆæœ€ç»ˆçš„æç¤ºæ–‡æœ¬
String prompt = promptTempldate.render(variables);
```



**å®ç°åŸç†**

PromptTemplateåº•å±‚ä½¿ç”¨äº†OSS StringTemplateå¼•æ“ï¼Œè¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¨¡æ¿å¼•æ“ï¼Œä¸“æ³¨äºæ–‡æœ¬ç”Ÿæˆã€‚åœ¨Spring AI ä¸­ï¼ŒPromptTemplateç±»å®ç°äº†ä»¥ä¸‹æ¥å£ï¼š

```java
public class PromptTemplate imâ¡plements PromptTemplâ¢ateActions, PromptTemplateMessageActions {
    // å®ç°ç»†èŠ‚
}
```



è¿™äº›æ¥å£æä¾›äº†ä¸åŒç±»å‹çš„æ¨¡æ¿æ“ä½œåŠŸèƒ½ï¼Œæ—¢èƒ½ç”Ÿæˆæ™®é€šæ–‡æœ¬ï¼Œä¹Ÿèƒ½ç”Ÿæˆç»“æ„åŒ–æ¶ˆæ¯ã€‚

**ä¸“ç”¨æ¨¡æ¿ç±»**

1. `SystemPromptTempldate`ï¼šç”¨äºç³»ç»Ÿæ¶ˆæ¯ï¼Œè®¾ç½®AIçš„è¡Œä¸ºå’ŒèƒŒæ™¯
2. `AssistantPromptTempldate`ï¼šç”¨äºåŠ©æ‰‹æ¶ˆæ¯ï¼Œç”¨äºè®¾ç½®AIå›å¤ç»“æ„
3. `FunctionPromptTempldate`ï¼šæš‚æ—¶æ— ç”¨

##### ä»æ–‡ä»¶åŠ è½½æ¨¡æ¿

PromptTemplateæ”¯æŒä»å¤–éƒ¨æ–‡ä»¶åŠ è½½æ¨¡æ¿å†…å®¹ï¼Œå¾ˆé€‚åˆç®¡ç†å¤æ‚çš„æç¤ºè¯ï¼ŒSpring AI åˆ©ç”¨Springçš„Resourceå¯¹è±¡ä»æŒ‡å®šè·¯å¾„åŠ è½½æ¨¡æ¿æ–‡ä»¶ï¼š

```java
// ä»ç±»è·¯å¾„èµ„æºåŠ è½½ç³»ç»Ÿæç¤ºæ¨¡æ¿
@Value("classpath:/prompts/system-message.st")
private Resourâ¡ce systemâ¢Resource;

// ç›´æ¥ä½¿ç”¨èµ„æºåˆ›å»ºæ¨¡æ¿
SystemPromptTâ¡emplate systemPromâ¢ptTemplate = new SystemPromptTemplate(systemResource);
```



è¿™ç§æ–¹å¼å¯ä»¥ï¼š

- å°†å¤æ‚çš„æç¤ºè¯æ”¾åœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­ç®¡ç†
- åœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹è°ƒæ•´æç¤ºè¯
- ä¸ºä¸åŒåœºæ™¯å‡†å¤‡å¤šå¥—æç¤ºè¯æ¨¡æ¿

æ›´åŠ æ¨èä½¿ç”¨è¿™ç§æ–¹å¼è¿›è¡ŒPromptæ¨¡æ¿ã€‚

## RAGçŸ¥è¯†åº“

### RAG æ¦‚å¿µ

#### ä»€ä¹ˆæ˜¯RAGï¼Ÿ





RAGï¼ˆRetrieve-Augmented Generationï¼Œ æ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æ˜¯ä¸€ç§ç»“åˆä¿¡æ¯æ£€ç´¢æŠ€æœ¯å’ŒAIå†…å®¹ç”Ÿæˆçš„æ··åˆæ¶æ„ï¼Œå¯ä»¥è§£å†³å¤§æ¨¡å‹çš„çŸ¥è¯†æ—¶æ•ˆæ€§é™åˆ¶å’Œå¹»è§‰é—®é¢˜ã€‚

RAGå°±åƒæ˜¯ç»™AIæä¾›äº†ä¸€ä¸ªå°æŠ„æœ¬ï¼ŒAIå›ç­”ä¹‹å‰ä¼šå…ˆæŸ¥ä¸€æŸ¥è¿™ä¸ªå°æŠ„ï¼Œç¡®ä¿é—®é¢˜æ˜¯åŸºäºçœŸå®çš„èµ„æ–™è€Œä¸æ˜¯å‡­ç©ºæƒ³è±¡ã€‚

é€šè¿‡RAGæŠ€æœ¯æ”¹é€ ä¹‹åï¼ŒAIå¯ä»¥ï¼š

- å‡†ç¡®å›ç­”ç›¸å…³çš„å†…å®¹
- åœ¨åˆé€‚çš„æ—¶æœºæ¨èç›¸å…³è¯¾ç¨‹å’ŒæœåŠ¡
- ç”¨ç‰¹å®šçš„è¯­æ°”å’Œç”¨æˆ·äº¤æµ
- æä¾›æ›´æ–°ã€æ›´å‡†ç¡®çš„å»ºè®®

##### RAGå·¥ä½œæµç¨‹

- æ–‡æ¡£æ”¶é›†å’Œåˆ‡å‰²
- å‘é‡è½¬æ¢å’Œå­˜å‚¨
- æ–‡æ¡£è¿‡æ»¤å’Œæ£€ç´¢
- æŸ¥è¯¢å¢å¼ºå’Œå…³è”

###### 1ã€ æ–‡æ¡£æ”¶é›†å’Œåˆ‡å‰²

æ–‡æ¡£æ”¶é›†ï¼šä»å„ç§æ¥æºæ”¶é›†åŸå§‹æ–‡æ¡£

æ–‡æ¡£é¢„å¤„ç†ï¼šæ¸…æ´—ã€æ ‡å‡†åŒ–æ–‡æœ¬æ ¼å¼

æ–‡æ¡£åˆ‡å‰²ï¼šå°†é•¿æ–‡æœ¬åˆ†å‰²æˆé€‚å½“å¤§å°çš„ç‰‡æ®µï¼ˆä¿—ç§°chunksï¼‰

- åŸºäºå›ºå®šå¤§å°ï¼ˆå¦‚512ä¸ªTokenï¼‰
- åŸºäºè¯­å¥è¾¹ç•Œï¼ˆå¦‚æ®µè½ã€ç« èŠ‚ï¼‰
- åŸºäºé€’å½’åˆ†å‰²ç­–ç•¥ï¼ˆå¦‚é€’å½’å­—ç¬¦n-gramåˆ‡å‰²ï¼‰

![image-20250612004759118](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612004759118.png)

###### 2ã€å‘é‡è½¬æ¢å’Œå­˜å‚¨

å‘é‡è½¬æ¢ï¼šä½¿ç”¨Embeddingæ¨¡å‹å°†æ–‡æœ¬å—è½¬æ¢æˆé«˜ç»´å‘é‡è¡¨ç¤ºï¼Œå¯ä»¥æ•è·åˆ°æ–‡æœ¬çš„è¯­ä¹‰ç‰¹å¾

å‘é‡å­˜å‚¨ï¼šå°†ç”Ÿæˆçš„å‘é‡å’Œå¯¹åº”æ–‡æœ¬å­˜å…¥å‘é‡æ•°æ®åº“ä¸­ï¼Œæ”¯æŒé«˜æ•ˆçš„ç›¸ä¼¼æ€§æœç´¢

![image-20250612004951373](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612004951373.png)

###### 3ã€æ–‡æ¡£è¿‡æ»¤å’Œæ£€ç´¢

æŸ¥è¯¢å¤„ç†ï¼šå°†ç”¨æˆ·é—®é¢˜è½¬æ¢æˆå‘é‡è¡¨ç¤º

è¿‡æ»¤æœºåˆ¶ï¼šåŸºäºå…ƒæ•°æ®ã€å…³é”®è¯æˆ–è‡ªå®šä¹‰è§„åˆ™è¿›è¡Œè¿‡æ»¤

ç›¸ä¼¼åº¦æœç´¢ï¼šåœ¨å‘é‡æ•°æ®åº“ä¸­æŸ¥æ‰¾ä¸é—®é¢˜å‘é‡æœ€ç›¸ä¼¼çš„æ–‡æ¡£å—ï¼Œå¸¸ç”¨çš„ç›¸ä¼¼åº¦æœç´¢ç®—æ³•æœ‰ä½™å¼¦ç›¸ä¼¼åº¦ã€æ¬§æ°è·ç¦»ç­‰

ä¸Šä¸‹æ–‡ç»„è£…ï¼šå°†æ£€ç´¢åˆ°çš„å¤šä¸ªæ–‡æ¡£å—ç»„è½¬æˆè¿è´¯çš„ä¸Šä¸‹æ–‡

![image-20250612005231724](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612005231724.png)

###### 4ã€æŸ¥è¯¢å¢å¼ºå’Œå…³è”

æç¤ºè¯ç»„è£…ï¼šå°†æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£ä¸ç”¨æˆ·é—®é¢˜ç»„åˆæˆå¢å¼ºæç¤º

ä¸Šä¸‹æ–‡èåˆï¼šå¤§æ¨¡å‹åŸºäºå¢å¼ºæç¤ºç”Ÿæˆå›ç­”

æºå¼•ç”¨ï¼šå›ç­”ä¿¡æ¯ä¸­æ·»åŠ ä¿¡æ¯æ¥æºå¼•ç”¨

åå¤„ç†ï¼šæ ¼å¼åŒ–ã€æ‘˜è¦æˆ–å…¶ä»–å¤„ç†ä¼˜åŒ–æœ€ç»ˆè¾“å‡º



ç†è§£ä¸Šè¿°å››ä¸ªæ­¥éª¤ä¹‹åï¼Œå¯ä»¥å°†å®ƒä»¬ç»„åˆèµ·æ¥ï¼Œå½¢æˆå®Œæ•´çš„RAGæ£€ç´¢å¢å¼ºç”Ÿæˆå·¥å…·æµç¨‹ï¼š

![image-20250612005632536](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612005632536.png)

ä¸Šè¿°å·¥ä½œæµç¨‹ä¸­æ¶‰åŠåˆ°äº†å¾ˆå¤šæŠ€æœ¯åè¯ï¼Œä¸‹é¢è¿›è¡Œåˆ†åˆ«è§£é‡Šã€‚

##### RAGç›¸å…³æŠ€æœ¯

###### Embeddingå’ŒEmbeddingæ¨¡å‹

EmbeddingåµŒå…¥æ˜¯å°†é«˜ç»´ç¦»æ•£æ•°æ®è½¬æ¢æˆä½çº¬è¿ç»­å‘é‡çš„è¿‡ç¨‹ã€‚è¿™äº›å‘é‡èƒ½åœ¨æ•°å­¦ç©ºé—´ä¸­è¡¨ç¤ºåŸå§‹æ•°æ®çš„è¯­ä¹‰ç‰¹å¾ï¼Œä½¿å¾—è®¡ç®—æœºèƒ½å¤Ÿç†è§£æ•°æ®é—´çš„ç›¸ä¼¼æ€§

Embeddingæ¨¡å‹æ˜¯æ‰§è¡Œè¿™ç§è½¬æ¢ç®—æ³•çš„æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œå¦‚Word2Vecï¼ˆæ–‡æœ¬ï¼‰ã€ResNetï¼ˆå›¾åƒï¼‰ç­‰ã€‚ä¸åŒçš„Embeddingæ¨¡å‹äº§ç”Ÿçš„å‘é‡å’Œçº¬åº¦æ•°ä¸åŒï¼Œçº¬åº¦è¶Šé«˜è¡¨ç¤ºè¡¨è¾¾èƒ½åŠ›è¶Šå¼ºï¼Œå¯ä»¥æ•è·åˆ°æ›´åŠ ç»†è‡´çš„è¯­ä¹‰ä¿¡æ¯ï¼Œå ç”¨æ›´å¤šçš„å†…å­˜ã€‚

![image-20250612010206866](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612010206866.png)

###### å‘é‡æ•°æ®åº“

å‘é‡æ•°æ®åº“æ˜¯ä¸“é—¨å­˜å‚¨å’Œæ£€ç´¢å‘é‡æ•°æ®åº“çš„æ•°æ®åº“ç³»ç»Ÿã€‚é€šè¿‡é«˜æ•ˆå¼•ç”¨ç®—æ³•å®ç°ç›¸ä¼¼æ€§æœç´¢ï¼Œæ”¯æŒKè¿‘é‚»æŸ¥è¯¢ç­‰æ“ä½œã€‚

![image-20250612010320239](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612010320239.png)

æ³¨æ„ï¼Œå¹¶ä¸æ˜¯åªæœ‰å‘é‡çŸ¥è¯†åº“æ‰èƒ½å­˜å‚¨å‘é‡æ•°æ®ï¼Œä¸ä¼ ç»Ÿçš„æ•°æ®åº“ä¸åŒçš„æ˜¯ï¼Œå‘é‡æ•°æ®åº“ä¼˜åŒ–äº†é«˜ç»´å‘é‡çš„å­˜å‚¨å’Œæ£€ç´¢ã€‚

###### å¬å›

å¬å›æ˜¯ä¿¡æ¯æ£€ç´¢çš„ç¬¬ä¸€é˜¶æ®µï¼Œç›®æ ‡æ˜¯ä»å¤§è§„æ¨¡æ•°æ®é›†ä¸­å¿«é€Ÿç­›é€‰å‡ºå¯èƒ½ç›¸å…³çš„å€™é€‰å­é›†ï¼Œå¼ºè°ƒé€Ÿåº¦å’Œå¹¿åº¦ï¼Œå¹¶éç²¾ç¡®åº¦ã€‚

###### ç²¾æ’å’ŒRankæ¨¡å‹

ç²¾æ’ï¼ˆç²¾ç¡®æ’åºï¼‰æ˜¯æœç´¢/æ¨èç³»ç»Ÿæœ€åé˜¶æ®µï¼Œä½¿ç”¨è®¡ç®—å¤æ‚åº¦æ›´é«˜çš„ç®—æ³•ï¼Œè€ƒè™‘æ›´å¤šç‰¹å¾å’Œä¸šåŠ¡è§„åˆ™ï¼Œå¯¹å°‘é‡å€™é€‰é¡¹è¿›è¡Œæ›´å¤æ‚ã€ç²¾ç»†çš„æ’åºã€‚

![image-20250612010724592](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612010724592.png)

Rankæ¨¡å‹ï¼ˆæ’åºæ¨¡å‹ï¼‰è´Ÿè´£å¯¹å¬å›é˜¶æ®µç­›é€‰å‡ºçš„å€™é€‰é›†è¿›è¡Œç²¾ç¡®æ’åºï¼Œè€ƒè™‘å¤šç§ç‰¹å¾è¯„ä¼°ç›¸å…³æ€§ã€‚

ç°ä»£Rankæ¨¡å‹é€šå¸¸åŸºäºæ·±åº¦å­¦ä¹ ï¼Œè€ƒè™‘æŸ¥è¯¢å’Œå€™é€‰é¡¹çš„ç›¸å…³æ€§ã€ç”¨æˆ·å†å²è¡Œä¸ºç­‰å› ç´ ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œç”µå•†æ¨èç³»ç»Ÿä¼šæ ¹æ®å•†å“ç‰¹å¾ã€ç”¨æˆ·åå¥½ã€ç‚¹å‡»ç‡ç­‰ç»™æ¯ä¸ªå•†å“æ‰“åˆ†å¹¶æ’åºã€‚

![image-20250612010958064](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612010958064.png)

###### æ··åˆæ£€ç´¢ç­–ç•¥

ç»“åˆå¤šç§æ£€ç´¢æ–¹æ³•çš„ä¼˜åŠ¿ï¼Œæé«˜æœç´¢æ•ˆæœï¼Œå¸¸è§çš„ç»„åˆåŒ…æ‹¬å…³é”®è¯æ£€ç´¢ã€è¯­ä¹‰æ£€ç´¢ã€çŸ¥è¯†å›¾åº“ç­‰ã€‚

æ¯”å¦‚åœ¨AIå¤§æ¨¡å‹å¼€å‘å¹³å°Difyä¸­ï¼Œå°±ä¸ºç”¨æˆ·æä¾›äº†â€œåŸºäºå…¨æ–‡æ£€ç´¢çš„å…³é”®è¯æœç´¢ + åŸºäºå‘é‡æ£€ç´¢çš„è¯­ä¹‰æ£€ç´¢â€çš„æ··åˆæ£€ç´¢ç­–ç•¥ï¼Œç”¨æˆ·è¿˜å¯ä»¥è‡ªå·±è®¾ç½®ä¸åŒçš„æ£€ç´¢æ–¹å¼çš„æƒé‡ã€‚

#### RAGå®æˆ˜ï¼šSpring AI + æœ¬åœ°çŸ¥è¯†åº“

Spring AI ä¸ºæˆ‘ä»¬å®ç°äº†RAG æä¾›äº†å…¨æµç¨‹çš„æ”¯æŒï¼Œå‚è€ƒ[Spring AI](https://docs.spring.io/spring-ai/reference/api/retrieval-augmented-generation.html)å’Œ[Spring AI Alibaba](https://java2ai.com/docs/1.0.0-M6.1/tutorials/rag/)çš„å®˜æ–¹æ–‡æ¡£ã€‚

æˆ‘ä»¬åœ¨å­¦ä¹ ä¸­çš„æ ‡å‡†RAGå¼€å‘ç›¸è¾ƒäºçœŸå®ä¸šåŠ¡æœ‰æ‰€ç®€åŒ–ï¼Œæ¥å®ç°åŸºäºæœ¬åœ°çŸ¥è¯†åº“çš„AI æ‹çˆ±çŸ¥è¯†é—®ç­”

##### æ–‡æ¡£å‡†å¤‡

![image-20250612135335685](Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612135335685.png)

##### æ–‡æ¡£è¯»å–

é¦–å…ˆï¼Œè¦å¯¹å·²ç»å‡†å¤‡å¥½çš„çŸ¥è¯†åº“æ–‡æ¡£è¿›è¡Œå¤„ç†ï¼Œä¹‹åä¿å­˜åˆ°å‘é‡æ•°æ®åº“ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ETLï¼ˆæŠ½å–ã€è½¬æ¢ã€åŠ è½½ï¼‰ï¼ŒSpring AI æä¾›äº†å¯¹ETLçš„æ”¯æŒï¼Œå‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_markdown)

ETLä¸‰å¤§æ ¸å¿ƒç»„ä»¶ï¼šæŒ‰ç…§é¡ºåºä¾æ¬¡æ‰§è¡Œï¼š

- `DocumentReader`ï¼šè¯»å–æ–‡æ¡£ï¼Œå¾—åˆ°æ–‡æ¡£åˆ—è¡¨
- `DocumentTransformer`ï¼šè½¬æ¢æ–‡æ¡£ï¼Œå¾—åˆ°å¤„ç†åçš„æ–‡æ¡£åˆ—è¡¨
- `DocumentWriter`ï¼šå°†æ–‡æ¡£åˆ—è¡¨ä¿å­˜åˆ°å­˜å‚¨ä¸­ï¼ˆå¯ä»¥æ˜¯å‘é‡æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–å­˜å‚¨ï¼‰

![image-20250612140156026](Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612140156026.png)

1ï¼‰å¼•å…¥ä¾èµ–

```xml
<!--        Spring AI markdown æ–‡æ¡£è¯»å–-->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-markdown-document-reader</artifactId>
            <version>1.0.0-M6</version>
        </dependency>
```

Spring AI æä¾›äº†å¾ˆå¤šDocumentReadersï¼Œç”¨äºåŠ è½½ä¸åŒç±»å‹çš„æ–‡ä»¶ã€‚

![image-20250612151707990](Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612151707990.png)

æˆ‘ä»¬ä½¿ç”¨`MarkdownDocumentReader`æ¥è¯»å–Markdownæ–‡æ¡£ï¼Œéœ€è¦å…ˆå¼•å…¥ä¾èµ–ï¼Œå¯ä»¥åœ¨mavenä¸­æ‰¾åˆ°.

2ï¼‰åœ¨æ ¹ç›®å½•ä¸‹æ–°å»º`rag`åŒ…ï¼Œç¼–å†™æ–‡æ¡£åŠ è½½å™¨ç±»`LoveAppDocumentLoader`è´Ÿè´£è¯»å–æ‰€æœ‰Markdownæ–‡æ¡£å¹¶è½¬æˆDocumentåˆ—è¡¨ã€‚

```java
@Component
@Slf4j
public class LoveAppDocumentLoader {
    private final ResourcePatternResolver resourcePatternResolver;

    public LoveAppDocumentLoader(ResourcePatternResolver resourcePatternResolver) {
        this.resourcePatternResolver = resourcePatternResolver;
    }

    /**
     * åŠ è½½Markdownæ–‡ä»¶
     */
    public List<Document> loadMarkdowns() {
        List<Document> allDocuments = new ArrayList<>();
        try {
            Resource[] resources = resourcePatternResolver.getResources("classpath:document/*.md");
            for (Resource resource : resources) {
                String filename = resource.getFilename();
                MarkdownDocumentReaderConfig config = MarkdownDocumentReaderConfig.builder().withHorizontalRuleCreateDocument(true)
                        .withIncludeCodeBlock(false)
                        .withIncludeBlockquote(false)
                        .withAdditionalMetadata("filename", filename)
                        .build();
                MarkdownDocumentReader reader = new MarkdownDocumentReader(resource, config);
                allDocuments.addAll(reader.get());
            }

        } catch(IOException e) {
            log.error("åŠ è½½Markdownæ–‡ä»¶å¤±è´¥", e);
        }
        return allDocuments;
    }
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡MarkdownDocumentReaderConfigæ–‡æ¡£åŠ è½½é…ç½®æ¥æŒ‡å®šè¯»å–æ–‡æ¡£çš„ç»†èŠ‚ï¼Œæ¯”å¦‚æ˜¯å¦è¯»å–ä»£ç å—ã€å¼•ç”¨å¿«ç­‰ã€‚æˆ‘ä»¬è¿˜æŒ‡å®šäº†é¢å¤–çš„å…ƒä¿¡æ¯é…ç½®ï¼Œæå–æ–‡æ¡£çš„æ–‡ä»¶åï¼ˆfileNameï¼‰ä½œä¸ºæ–‡æ¡£çš„å…ƒä¿¡æ¯ï¼Œå¯ä»¥ä¾¿äºåç»­çŸ¥è¯†åº“å®ç°æ›´ç²¾ç¡®çš„æ£€ç´¢ã€‚

##### å‘é‡è½¬æ¢å’Œå­˜å‚¨

ä¸ºäº†æ–¹ä¾¿ï¼Œä½¿ç”¨åŸºäºå†…å­˜è¯»å†™çš„å‘é‡æ•°æ®åº“`SimpleVectorStore`æ¥ä¿å­˜æ–‡æ¡£ã€‚

`SimpleVectorStore`å®ç°äº†`Vector`æ¥å£ï¼Œè€Œ`Vector`æ¥å£é›†æˆäº†`DocumentWriter`ï¼Œæ‰€ä»¥å…·å¤‡æ–‡æ¡£å†™å…¥åŠŸèƒ½ã€‚

![image-20250612153637586](Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612153637586.png)

ç®€å•äº†è§£ä¸€ä¸‹æºç ï¼Œåœ¨å°†æ–‡æ¡£å†™å…¥åˆ°æ•°æ®åº“ä¹‹å‰ï¼Œä¼šå…ˆè°ƒç”¨`Embeding`å°†æ–‡æ¡£è½¬æˆå‘é‡ï¼Œå®é™…å­˜å‚¨åˆ°æ•°æ®åº“çš„æ˜¯å‘é‡ç±»å‹çš„æ•°æ®ã€‚

åœ¨`rag`åŒ…æ–°å»º`LoveAppVectorStoreConfig`ç±»ï¼Œå®ç°åˆå§‹åŒ–å‘é‡æ•°æ®åº“å¹¶ä¸”ä¿å­˜æ–‡æ¡£çš„æ–¹æ³•ã€‚ä»£ç ï¼š

```java
@Configuration
public class LoveAppVectorStoreConfig {
    @Resource
    private LoveAppDocumentLoader loveAppDocumentLoader;

    @Bean
    VectorStore loveAppVectorStore(EmbeddingModel dashscopeEmbeddingModel) {
        SimpleVectorStore simpleVectorStore = SimpleVectorStore.builder(dashscopeEmbeddingModel).build();
        // åŠ è½½æ–‡æ¡£
        List<Document> documents = loveAppDocumentLoader.loadMarkdowns();
        simpleVectorStore.add(documents);
        return simpleVectorStore;
    }
}
```

##### æŸ¥è¯¢å¢å¼º

é€šè¿‡`Advisor`ç‰¹æ€§æä¾›äº†å¼€ç®±å³ç”¨çš„RAGåŠŸèƒ½ã€‚ä¸»è¦æ˜¯`QuestionAnswerAdvisor`é—®ç­”æ‹¦æˆªå™¨å’Œ`RetrivalAugmentationAdvisor`æ£€ç´¢å¢å¼ºæ‹¦æˆªå™¨ï¼Œå‰è€…æ›´åŠ ç®€å•æ˜“ç”¨ã€åè€…æ›´åŠ å¼ºå¤§ã€‚

æŸ¥è¯¢å¢å¼ºçš„åŸç†å¾ˆç®€å•ï¼Œå‘é‡æ•°æ®åº“å­˜å‚¨ç€AIæ¨¡å‹æœ¬èº«ä¸çŸ¥é“çš„æ•°æ®ï¼Œå½“ç”¨æˆ·å‘AIå‘é€æé—®æ—¶ï¼ŒQuestionAnswerAdvisorä¼šæŸ¥è¯¢å‘é‡æ•°æ®åº“ï¼Œè·å–ä¸ç”¨æˆ·é—®é¢˜ç›¸å…³çš„æ–‡æ¡£ã€‚ç„¶åä»å‘é‡æ•°æ®åº“è¿”å›çš„å“åº”ä¼šè¢«é™„åŠ åˆ°ç”¨æˆ·æ–‡æœ¬ä¸­ï¼Œä¸ºAIæ¨¡å‹æä¾›ä¸Šä¸‹æ–‡ï¼Œå¸®åŠ©ç”Ÿæˆå›ç­”ã€‚

æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œéœ€è¦å…ˆå¼•å…¥ä¾èµ–ï¼š

```xml
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-advisors-vector-store</artifactId>
            <version>1.0.0</version>
        </dependency>
```

æˆ‘ä»¬é€‰æ‹©`QuestionAnswerAdvisor`é—®ç­”æ‹¦æˆªå™¨ï¼Œåœ¨`LoveApp`ä¸­æ–°å¢å’ŒRAGçŸ¥è¯†åº“è¿›è¡Œå¯¹è¯çš„æ–¹æ³•ã€‚

```java
@Resource
    private VectorStore loveAppVectorStore;
    public String doChatWithRAG(String message, String chatId) {
        ChatResponse chatResponse = chatClient.prompt()
                .user(message)
                .advisors(spec -> spec.param(CHAT_MEMORY_CONVERSATION_ID_KEY, chatId)
                        .param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, 10))
                .advisors(new MyLoggerAdvisor())
                .advisors(new QuestionAnswerAdvisor(loveAppVectorStore))
                .call()
                .chatResponse();

        String content = chatResponse.getResult().getOutput().getText();
        log.info("content: {}", content);
        return content;
    }
```

##### æµ‹è¯•

ç”Ÿæˆå•å…ƒæµ‹è¯•ä»£ç ï¼š

```java
    @Test
    void doChatWithRAG() {
        String chatId = UUID.randomUUID().toString();
        String message = "æˆ‘å·²ç»ç»“å©šäº†ï¼Œä½†æ˜¯å©šåå…³ç³»ä¸å¤ªç¨³å®šï¼Œæ€ä¹ˆåšï¼Ÿ";
        String answer = loveApp.doChatWithRAG(message, chatId);
        Assertions.assertNotNull(answer);
    }
```

è¿è¡Œç¨‹åºï¼Œé€šè¿‡debugå‘ç°ï¼ŒåŠ è½½çš„æ–‡æ¡£è¢«è‡ªåŠ¨æŒ‰ç…§å°æ ‡é¢˜åˆ’åˆ†ï¼Œå¹¶ä¸”è¡¥å……äº†metadataå…ƒä¿¡æ¯ï¼š

![image-20250612154658019](Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612154658019.png)

æ”¾è¡Œï¼ŒæŸ¥çœ‹è¯·æ±‚ï¼Œå‘ç°æ£€ç´¢ç”¨æˆ·é—®é¢˜å¾—åˆ°äº†4ä¸ªæ–‡æ¡£åˆ‡ç‰‡ï¼Œæ¯ä¸ªåˆ‡ç‰‡éƒ½æœ‰å¯¹åº”çš„åˆ†æ•°å’Œå…ƒä¿¡æ¯ã€‚

![image-20250612154847724](Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612154847724.png)

![image-20250612154906981](Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612154906981.png)

æŸ¥çœ‹è¯·æ±‚ï¼Œå‘ç°ç”¨æˆ·æç¤ºè¯è¢«ä¿®æ”¹äº†ï¼Œ

![image-20250612154932246](Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612154932246.png)

æ”¾è¡Œï¼ŒæŸ¥çœ‹å“åº”ç»“æœï¼ŒAIçš„å›å¤æˆåŠŸåŒ…å«äº†çŸ¥è¯†åº“çš„å†…å®¹

![image-20250612155041124](Ai è¶…çº§æ™ºèƒ½ä½“/image-20250612155041124.png)





## RAGèŠå£«è¿›é˜¶

### RAGæ ¸å¿ƒç‰¹æ€§

#### æ–‡æ¡£æ”¶é›†å’Œåˆ‡å‰² - ETL

æ–‡æ¡£æ”¶é›†å’Œåˆ‡å‰²é˜¶æ®µï¼Œæˆ‘ä»¬è¦å¯¹è‡ªå·±å‡†å¤‡çš„çŸ¥è¯†åº“çŸ¥è¯†æ–‡æ¡£è¿›è¡Œå¤„ç†ï¼Œç„¶åä¿å­˜åˆ°å‘é‡æ•°æ®åº“ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹å«åšETLï¼ˆæŠ½å–ã€è½¬æ¢ã€åŠ è½½ï¼‰ï¼ŒSpring AI æä¾›äº†å¯¹ETLçš„æ”¯æŒï¼Œå‚è€ƒï¼š[å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html)ã€‚

##### æ–‡æ¡£

ä»€ä¹ˆæ˜¯Spring AIçš„æ–‡æ¡£ï¼Ÿæ–‡æ¡£ä¸ä»…ä»…æ˜¯åŒ…å«æ–‡æœ¬ï¼Œè¿˜å¯ä»¥åŒ…å«ä¸€ç³»åˆ—å…ƒä¿¡æ¯å’Œå¤šåª’ä½“é™„ä»¶ï¼š

![image-20250613000750386](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250613000750386.png)

##### ETL

åœ¨Spring AIä¸­ï¼Œå¯¹Documentçš„å¤„ç†é€šå¸¸éµå¾ªä»¥ä¸‹æµç¨‹ï¼š

1. è¯»å–æ–‡æ¡£ï¼šä½¿ç”¨`DocumentReader`ç»„ä»¶ä»æ•°æ®æºï¼ˆå¦‚æœ¬åœ°æ–‡ä»¶ã€ç½‘ç»œèµ„æºã€æ•°æ®åº“ç­‰ï¼‰åŠ è½½æ–‡æ¡£ã€‚
2. è½¬æ¢æ–‡æ¡£ï¼šæ ¹æ®éœ€æ±‚å°†æ–‡æ¡£è½¬æ¢æˆé€‚åˆåç»­å¤„ç†çš„æ ¼å¼ï¼Œæ¯”å¦‚å»é™¤å†—ä½™ä¿¡æ¯ã€åˆ†è¯ã€è¯æ€§æ ‡æ³¨ç­‰ï¼Œå¯ä»¥ä½¿ç”¨DocumentTransformç»„ä»¶å®ç°ã€‚
3. å†™å…¥æ–‡æ¡£ï¼šä½¿ç”¨DocumentWriterå°†æ–‡æ¡£ä»¥ç‰¹å®šæ ¼å¼ä¿å­˜åˆ°å­˜å‚¨ä¸­ï¼Œæ¯”å¦‚å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“ä¸­ï¼Œæˆ–è€…ä»¥é”®å€¼å¯¹å½¢å¼ä¿å­˜åˆ°KVå­˜å‚¨ç»“æ„ä¸­ã€‚

![image-20250613001142035](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250613001142035.png)

æˆ‘ä»¬åˆ©ç”¨Spring AIå®ç°ETLï¼Œæ ¸å¿ƒå°±æ˜¯å­¦ä¹ DocumentReaderã€DocumentTransformerã€DocumentWriterä¸‰å¤§ç»„ä»¶ã€‚

##### æŠ½å–ï¼ˆExtractï¼‰

Spring AIé€šè¿‡DocumentReaderç»„ä»¶å®ç°äº†æ–‡æ¡£æŠ½å–ï¼Œä¹Ÿå°±æ˜¯å°†æ–‡æ¡£åŠ è½½åˆ°å†…å­˜ä¸­ã€‚

DocumentReaderå®ç°äº†`Supplier<List<Document>>`æ¥å£ï¼Œä¸»è¦è´Ÿè´£ä»å„ç§æ•°æ®æºè¯»å–æ•°æ®å¹¶è½¬æ¢ä¸ºDocumentå¯¹è±¡é›†åˆã€‚

```java
	public interface DocumentReader extends Supplier<List<Document>> {

	default List<Document> read() {
		return get();
	}

}
```

å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨Spring AI å†…ç½®çš„å¤šç§[DocumentReader å®ç°ç±»](https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_documentreaders)ï¼Œå¤„ç†ä¸åŒç±»å‹çš„æ•°æ®æºã€‚

ä»¥JsonReaderä¸ºä¾‹ï¼Œæ”¯æŒJSON Pointerç‰¹å¾ï¼Œèƒ½å¤Ÿå¿«é€ŸæŒ‡å®šä»JSONæ–‡æ¡£ä¸­æå–é‚£ä¸€äº›å­—æ®µå’Œå†…å®¹ï¼š

```java
// ä» classpath ä¸‹çš„ JSON æ–‡ä»¶ä¸­è¯»å–æ–‡æ¡£
 @Component
 class MyJsonReader {
     private final Resource resource;

     MyJsonReader(@Value("classpath:products.json") Resource resource) {
         this.resource = resource;
     }

     // åŸºæœ¬ç”¨æ³•
     List<Document> loadBasicJsonDocuments() {
         JsonReader jsonReader = new JsonReader(this.resource);
         return jsonReader.get();
     }

     // æŒ‡å®šä½¿ç”¨å“ªäº› JSON å­—æ®µä½œä¸ºæ–‡æ¡£å†…å®¹
     List<Document> loadJsonWithSpecificFields() {
         JsonReader jsonReader = new JsonReader(this.resource, "description", "features");
         return jsonReader.get();
     }

     // ä½¿ç”¨ JSON æŒ‡é’ˆç²¾ç¡®æå–æ–‡æ¡£å†…å®¹
     List<Document> loadJsonWithPointer() {
         JsonReader jsonReader = new JsonReader(this.resource);
         return jsonReader.get("/items"); // æå– items æ•°ç»„å†…çš„å†…å®¹
     }
 }

```





æ­¤å¤–ï¼ŒSpring AI Alibabaå®˜æ–¹ç¤¾åŒºæä¾›äº†[æ›´å¤šçš„æ–‡æ¡£è¯»å–å™¨](https://java2ai.com/docs/1.0.0-M6.1/integrations/documentreader/)ï¼Œæ¯”å¦‚åŠ è½½é£ä¹¦æ–‡æ¡£ã€æå–Bç«™è§†é¢‘ä¿¡æ¯å’Œå­—å¹•ã€åŠ è½½é‚®ä»¶ã€åŠ è½½Githubå®˜æ–¹æ–‡æ¡£ã€åŠ è½½æ•°æ®åº“ç­‰ã€‚

##### è½¬æ¢

Spring AI é€šè¿‡ DocumentTransformç»„ä»¶å®ç°æ–‡æ¡£è½¬æ¢ã€‚



çœ‹ä¸‹æºç ï¼ŒDocumentTransformæ¥å£å®ç°äº†`Function<List<Document>, List<Document>>`æ¥å£ï¼Œè´Ÿè´£å°†ä¸€ç»„Documentè½¬æˆå¦ä¸€ç»„Documentã€‚

```java
public interface DocumentTransformer extends Function<List<Document>, List<Document>> {

	default List<Document> transform(List<Document> transform) {
		return apply(transform);
	}

}
```

æ–‡æ¡£è½¬æ¢æ˜¯ä¿è¯RAGæ•ˆæœçš„æ ¸å¿ƒæ­¥éª¤ï¼Œå°±æ˜¯å¦‚ä½•å°†å¤§æ–‡æ¡£åˆç†æ‹†åˆ†æˆä¾¿äºæ£€ç´¢çš„çŸ¥è¯†ç¢ç‰‡ï¼ŒSpring AI æä¾›äº†å¤šç§DocumentTransformå®ç°ç±»ï¼Œå¯ä»¥ç®€å•åˆ’åˆ†æˆ3ç±»ï¼š

###### 1ï¼‰TextSplitteræ–‡æœ¬åˆ†å‰²å™¨

`TextSplitter`æ˜¯æ–‡æœ¬åˆ†å‰²å™¨çš„åŸºç±»ï¼Œæä¾›äº†åˆ†å‰²å•è¯çš„æµç¨‹æ–¹æ³•ï¼š

![image-20250613004353471](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250613004353471.png)

TokenTextSplitteræ˜¯å…¶å®ç°ç±»ï¼ŒåŸºäºTokençš„æ–‡æœ¬åˆ†å‰²å™¨ã€‚è€ƒè™‘äº†è¯­ä¹‰è¾¹ç•Œï¼ˆè¯­å¥ç»“å°¾ï¼‰æ¥åˆ›å»ºæœ‰æ„ä¹‰çš„æ–‡æœ¬æ®µè½ï¼Œæ˜¯æˆæœ¬è¾ƒä½çš„æ–‡æœ¬åˆ‡å‰²æ–¹å¼ã€‚

```java
@Component
class MyTokenTextSplitter {

    public List<Document> splitDocuments(List<Document> documents) {
        TokenTextSplitter splitter = new TokenTextSplitter();
        return splitter.apply(documents);
    }

    public List<Document> splitCustomized(List<Document> documents) {
        TokenTextSplitter splitter = new TokenTextSplitter(1000, 400, 10, 5000, true);
        return splitter.apply(documents);
    }
}

```

TokenTextSplliteræä¾›äº†ä¸¤ç§æ„é€ å‡½æ•°ï¼š

1. `TokenTextSplitter()`ï¼šä½¿ç”¨é»˜è®¤è®¾ç½®åˆ›å»ºåˆ†å‰²å™¨ã€‚
2. `TokenTextSplitter(int defaultChunkSize, int minChunkSizeChars, int minChunkLengthToEnbed, int maxNumChunks, boolean keepSeparator)`ï¼šä½¿ç”¨è‡ªå®šä¹‰å‚æ•°åˆ›å»ºåˆ†å‰²å™¨ï¼Œé€šè¿‡è°ƒæ•´å‚æ•°ï¼Œå¯ä»¥æ§åˆ¶åˆ†å‰²çš„ç²’åº¦å’Œæ–¹æ³•ï¼Œé€‚åº”ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚

å®˜æ–¹æ–‡æ¡£ä¸­å¯¹Tokenåˆ†è¯å™¨å·¥ä½œåŸç†çš„è¯¦ç»†è§£é‡Šï¼Œå¯ä»¥ç®€å•äº†è§£ä¸€ä¸‹ï¼š

1. ä½¿ç”¨CL 100K_BASEç¼–ç å°†è¾“å…¥æ–‡æœ¬ç¼–ç ä¸ºToken
2. æ ¹æ®defaultChunkSizeå°†ç¼–ç åçš„æ–‡æœ¬åˆ†å‰²æˆå—
3. å¯¹äºæ¯ä¸ªå—ï¼š

- å°†å—è§£ç å›æ–‡æœ¬
- å°è¯•åœ¨minChunkSizeCharsä¹‹åæ‰¾åˆ°åˆé€‚çš„æ–­ç‚¹ï¼ˆå¥å·ã€é—®å·ã€æ„Ÿå¹å·æˆ–æ¢è¡Œç¬¦ï¼‰
- å¦‚æœæ‰¾åˆ°æ–­ç‚¹ï¼Œåœ¨è¯¥ç‚¹æˆªæ–­å—
- ä¿®å‰ªå—å¹¶æ ¹æ®keepSeparatorè®¾ç½®é€‰æ‹©æ€§åœ°åˆ é™¤æ¢è¡Œç¬¦
- å¦‚æœç”Ÿæˆçš„å—é•¿åº¦å¤§äºminChunkLenthToEmbedï¼Œå°†å…¶æ·»åŠ åˆ°è¾“å‡ºä¸­

4. ä¼šä¸€ç›´æŒç»­åˆ°æ‰€æœ‰Tokenéƒ½è¢«å¤„ç†å®Œæˆ–è¾¾åˆ°maxNumChunksä¸ºæ­¢ã€‚
4. å‰©ä½™æ–‡æœ¬é•¿åº¦å¤§äºminChunkLengthToEmbedï¼Œä½œä¸ºæœ€åä¸€ä¸ªå—æ·»åŠ 

###### 2ï¼‰MetaDataEnricherå…ƒæ•°æ®å¢å¼ºå™¨

å…ƒæ•°æ®å¢å¼ºå™¨æ˜¯ä¸ºæ–‡æ¡£è¡¥å……æ›´å¤šå…ƒä¿¡æ¯ï¼Œä¾¿äºåç»­æ£€ç´¢ï¼Œä¸æ˜¯ä¸ºäº†æ”¹å˜æ–‡æ¡£æœ¬èº«çš„åˆ‡åˆ†è§„åˆ™ã€‚

- KeywordMetadataEnricherï¼šä½¿ç”¨AIæå–å…³é”®è¯å¹¶æ·»åŠ åˆ°å…ƒæ•°æ®
- SummaryMetadataEnricherï¼šä½¿ç”¨AIç”Ÿæˆæ–‡æ¡£æ‘˜è¦å¹¶æ·»åŠ åˆ°å…ƒæ•°æ®ã€‚ä¸ä»…å¯ä»¥ä¸ºå½“å‰æ–‡æ¡£ç”Ÿæˆæ‘˜è¦ï¼Œè¿˜èƒ½å…³è”å‰ä¸€ä¸ªå’Œåä¸€ä¸ªç›¸é‚»çš„æ–‡æ¡£ï¼Œæ‘˜è¦æ›´åŠ å®Œæ•´ã€‚

å®ä¾‹ä»£ç ï¼š

```java
@Component
class MyDocumentEnricher {

    private final ChatModel chatModel;

    MyDocumentEnricher(ChatModel chatModel) {
        this.chatModel = chatModel;
    }
      
      // å…³é”®è¯å…ƒä¿¡æ¯å¢å¼ºå™¨
    List<Document> enrichDocumentsByKeyword(List<Document> documents) {
        KeywordMetadataEnricher enricher = new KeywordMetadataEnricher(this.chatModel, 5);
        return enricher.apply(documents);
    }
  
    // æ‘˜è¦å…ƒä¿¡æ¯å¢å¼ºå™¨
    List<Document> enrichDocumentsBySummary(List<Document> documents) {
        SummaryMetadataEnricher enricher = new SummaryMetadataEnricher(chatModel, 
            List.of(SummaryType.PREVIOUS, SummaryType.CURRENT, SummaryType.NEXT));
        return enricher.apply(documents);
    }
}

```



###### 3ï¼‰ContentFormatterå†…å®¹æ ¼å¼åŒ–å·¥å…·

ç”¨äºç»Ÿä¸€æ–‡æ¡£å†…å®¹æ ¼å¼ã€‚å®˜æ–¹å¯¹è¿™ä¸ªä»‹ç»å¾ˆå°‘ã€‚

ç›´æ¥å»çœ‹æºç ï¼š`DefaultContentFormatter`

![image-20250613010231131](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250613010231131.png)

ä¸»è¦æä¾›äº†ä¸‰ç§åŠŸèƒ½ï¼š

1. æ–‡æ¡£æ ¼å¼åŒ–ï¼šå°†æ–‡æ¡£å†…å®¹ä¸å…ƒæ•°æ®åˆå¹¶æˆç‰¹å®šæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä¾¿äºåç»­å¤„ç†
2. å…ƒæ•°æ®è¿‡æ»¤ï¼šæ ¹æ®ä¸åŒçš„å…ƒæ•°æ®æ¨¡å¼ï¼ˆMetadataModeï¼‰ç­›é€‰éœ€è¦ä¿ç•™çš„å…ƒæ•°æ®é¡¹
   1. `ALL`ï¼šä¿ç•™æ‰€æœ‰å…ƒæ•°æ®
   2. `NONE`ï¼šç§»é™¤æ‰€æœ‰å…ƒæ•°æ®
   3. `INFRENCE`ï¼šæ¨ç†åœºæ™¯ï¼Œæ’é™¤æŒ‡å®šçš„æ¨ç†å…ƒæ•°æ®
   4. `ENBED`ï¼šç”¨äºåµŒå…¥åœºæ™¯ï¼Œæ’é™¤æŒ‡å®šçš„åµŒå…¥å…ƒæ•°æ®
3. è‡ªå®šä¹‰æ¨¡æ¿ï¼šæ”¯æŒè‡ªå®šä¹‰ä»¥ä¸‹æ ¼å¼ï¼š
   1. å…ƒæ•°æ®æ¨¡æ¿
   2. å…ƒæ•°æ®åˆ†éš”ç¬¦
   3. æ–‡æœ¬æ¨¡æ¿

```java
        // Builderåˆ›å»ºå®ä¾‹
        DefaultContentFormatter formatter = DefaultContentFormatter.builder()
                .withMetadataSeparator("\n")
                .withMetadataTemplate("{key}ï¼š{value}")
                .withTextTemplate("{metadata_string}\n\n{content}")
                .withExcludedInferenceMetadataKeys("embedding", "vector_id")
                .withExcludedEmbedMetadataKeys("source_url", "timestamp")
                .build();

        // ä½¿ç”¨æ ¼å¼åŒ–å™¨å¤„ç†æ–‡æ¡£
        formatter.format(document, MetadataMode.INFERENCE);
```



###### åŠ è½½ï¼ˆLoadï¼‰

Spring AI é€šè¿‡DocumentWriterç»„ä»¶å®ç°æ–‡æ¡£åŠ è½½

`DocumentWriter`æ¥å£å®ç°äº†`Consumer<List<Document>>`æ¥å£ï¼Œè´Ÿè´£å°†å¤„ç†ä¹‹åçš„æ–‡æ¡£å†™å…¥ç›®æ ‡å­˜å‚¨ä¸­ï¼š

```java
public interface DocumentWriter extends Consumer<List<Document>> {
    default void write(List<Document> documents) {
        accept(documents);
    }
}
```

Spring AI æä¾›äº†ä¸¤ç§å†…ç½®çš„Writerå®ç°ç±»ï¼š

1ï¼‰`FileDocumentWriter`ï¼šå°†æ–‡æ¡£å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿ

```java
@Component
class MyDocumentWriter {
    public void writeDocuments(List<Document> documents) {
        FileDocumentWriter writer = new FileDocumentWriter("output.txt", true, MetadataMode.ALL, false);
        writer.accept(documents);
    }
}
```

2ï¼‰`VectorStoreWriter`ï¼šå°†æ–‡æ¡£å†™å…¥åˆ°å‘é‡æ•°æ®åº“ä¸­

```java
@Component
class MyVectorStoreWriter {
    private final VectorStore vectorStore;
    
    MyVectorStoreWriter(VectorStore vectorStore) {
        this.vectorStore = vectorStore;
    }
    
    public void storeDocuments(List<Document> documents) {
        vectorStore.accept(documents);
    }
}
```

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åŒæ—¶å°†æ–‡æ¡£å†™å…¥å¤šä¸ªå­˜å‚¨ï¼Œåªéœ€è¦åˆ›å»ºå¤šä¸ªWriteræˆ–è€…è‡ªå®šä¹‰Writerå³å¯

###### ETLæµç¨‹ç¤ºä¾‹

å°†ä¸Šè¿°çš„ä¸‰å¤§ç»„ä»¶ç»„åˆèµ·æ¥ï¼Œå¯ä»¥å®ç°å®Œæ•´çš„ETLæµç¨‹ï¼š

```java
// æŠ½å–ï¼šä» PDF æ–‡ä»¶è¯»å–æ–‡æ¡£
PDFReader pdfReader = new PagePdfDocumentReader("knowledge_base.pdf");
List<Document> documents = pdfReader.read();

// è½¬æ¢ï¼šåˆ†å‰²æ–‡æœ¬å¹¶æ·»åŠ æ‘˜è¦
TokenTextSplitter splitter = new TokenTextSplitter(500, 50);
List<Document> splitDocuments = splitter.apply(documents);

SummaryMetadataEnricher enricher = new SummaryMetadataEnricher(chatModel, 
    List.of(SummaryType.CURRENT));
List<Document> enrichedDocuments = enricher.apply(splitDocuments);

// åŠ è½½ï¼šå†™å…¥å‘é‡æ•°æ®åº“
vectorStore.write(enrichedDocuments);

// æˆ–è€…ä½¿ç”¨é“¾å¼è°ƒç”¨
vectorStore.write(enricher.apply(splitter.apply(pdfReader.read())));

```

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥å®Œæˆä»åŸå§‹æ–‡æ¡£åˆ°å‘é‡æ•°æ®åº“çš„æ•´ä¸ªETL è¿‡ç¨‹ï¼Œä¸ºåç»­çš„æ£€ç´¢å¢å¼ºç”Ÿæˆäº†æä¾›çš„åŸºç¡€ã€‚

#### å‘é‡è½¬æ¢å’Œå­˜å‚¨

å‘é‡å­˜å‚¨æ˜¯RAGåº”ç”¨ä¸­çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒå°†æ–‡æ¡£è½¬æ¢æˆå‘é‡ï¼ˆåµŒå…¥ï¼‰å¹¶å­˜å‚¨èµ·æ¥ï¼Œä»¥ä¾¿äºåç»­è¿›è¡Œé«˜æ•ˆçš„ç›¸ä¼¼æ€§æœç´¢ã€‚Spring AI å®˜æ–¹æä¾›äº†å‘é‡æ•°æ®åº“æ¥å£`VectorStore`å’Œå‘é‡å­˜å‚¨æ•´åˆåŒ…ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿé›†æˆå„ç§ç¬¬ä¸‰æ–¹å‘é‡å­˜å‚¨ï¼Œæ¯”å¦‚Milvusã€Redisã€PGVectorã€ESç­‰ã€‚

##### VectorStoreæ¥å£ä»‹ç»

VectorStoreæ˜¯Spring AI ä¸­ç”¨äºä¸å‘é‡æ•°æ®åº“äº¤äº’çš„æ ¸å¿ƒæ¥å£ï¼Œå®ƒç»§æ‰¿è‡ªDocumentWriterï¼Œä¸»è¦æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

```java
public interface VectorStore extends DocumentWriter {

    default String getName() {
        return this.getClass().getSimpleName();
    }

    void add(List<Document> documents);

    void delete(List<String> idList);

    void delete(Filter.Expression filterExpression);

    default void delete(String filterExpression) { ... };

    List<Document> similaritySearch(String query);

    List<Document> similaritySearch(SearchRequest request);

    default <T> Optional<T> getNativeClient() {
        return Optional.empty();
    }
}
```

è¿™ä¸ªæ¥å£å®šä¹‰äº†å‘é‡å­˜å‚¨çš„åŸºæœ¬æ“ä½œï¼Œç®€å•æ¥è¯´å°±æ˜¯â€œå¢åˆ æ”¹æŸ¥â€

- æ·»åŠ æ–‡æ¡£åˆ°å‘é‡æ•°æ®åº“
- ä»å‘é‡æ•°æ®åº“åˆ é™¤æ–‡æ¡£
- åŸºäºæŸ¥è¯¢è¿›è¡Œç›¸ä¼¼åº¦è®¡ç®—
- è·å–åŸç”Ÿå®¢æˆ·ç«¯ï¼ˆç”¨äºç‰¹å®šå®ç°çš„é«˜çº§æ“ä½œï¼‰

##### æœç´¢è¯·æ±‚æ„å»º

Spring AI æä¾›äº†searchRequestç±»ï¼Œç”¨äºæ„å»ºç›¸ä¼¼åº¦æœç´¢è¯·æ±‚ï¼š

```java
SearchRequest request = SearchRequest.builder()
					.query("ä»€ä¹ˆæ˜¯æœèŠ±å¤•æ‹¾")
  .topK(5)
  .similarityThreshold(0.7)
  .filterExpression("catgory == 'web' AND date > '2025-05-13'")
  .build();

List<Document> results = vectorStore.similaritySearch(request);
```



æœ‰ç‚¹ç±»ä¼¼äºjavaçš„mybatiså’Œmybatis-plusã€‚SearchRequestæä¾›äº†å¤šç§æŸ¥è¯¢é…ç½®ï¼š

- queryï¼šæœç´¢çš„æŸ¥è¯¢æ–‡æœ¬
- topKï¼šè¿”å›çš„æœ€å¤§ç»“æœæ•°ï¼Œé»˜è®¤æ˜¯4
- similarityThresholdï¼šç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œä½äºæ­¤å€¼çš„ç»“æœä¼šè¢«è¿‡æ»¤æ‰
- filterExpressionï¼šåŸºäºæ–‡æ¡£å…ƒæ•°æ®çš„è¿‡æ»¤è¡¨è¾¾å¼ï¼Œè¯­æ³•æœ‰ç‚¹ç±»ä¼¼äºSQLè¯­å¥ï¼Œéœ€è¦ç”¨åˆ°æ—¶æŸ¥è¯¢[å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-ai/reference/api/vectordbs.html#metadata-filters)

##### å‘é‡å­˜å‚¨çš„å·¥ä½œåŸç†

åœ¨å‘é‡æ•°æ®åº“ä¸­ï¼ŒæŸ¥è¯¢ä¸ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“æœ‰æ‰€ä¸åŒã€‚å‘é‡æ•°æ®åº“æ‰§è¡Œçš„æ˜¯ç›¸ä¼¼æ€§æœç´¢ï¼Œè€Œéç²¾ç¡®åŒ¹é…ï¼Œå…·ä½“æµç¨‹ä¸Šä¸€èŠ‚è¯´è¿‡ã€‚

1. åµŒå…¥è½¬æ¢ï¼šå½“æ–‡æ¡£è¢«æ·»åŠ åˆ°å‘é‡å­˜å‚¨ä¸­ï¼ŒSpring AI ä¼šä½¿ç”¨åµŒå…¥æ¨¡å‹ï¼ˆå¦‚OpenAI çš„text-enbedding-ada-002ï¼‰å°†æ–‡æœ¬è½¬æ¢æˆå‘é‡
2. ç›¸ä¼¼åº¦è®¡ç®—ï¼šæŸ¥è¯¢æ—¶ï¼ŒæŸ¥è¯¢æ–‡æœ¬åŒæ ·è¢«è½¬æˆå‘é‡ï¼Œç„¶åç³»ç»Ÿè®¡ç®—æ­¤å‘é‡ä¸å­˜å‚¨ä¸­æ‰€æœ‰å‘é‡çš„ç›¸ä¼¼åº¦
3. ç›¸ä¼¼åº¦åº¦é‡ï¼šå¸¸ç”¨çš„ç›¸ä¼¼åº¦è®¡ç®—æ–¹æ³•åŒ…æ‹¬ï¼š
   1. ä½™å¼¦ç›¸ä¼¼åº¦ï¼šè®¡ç®—ä¸¤ä¸ªå‘é‡çš„å¤¹è§’ä½™å¼¦å€¼ï¼ŒèŒƒå›´åœ¨1åˆ°-1ä¹‹é—´
   2. æ¬§æ°è·ç¦»ï¼šè®¡ç®—ä¸¤ä¸ªå‘é‡çš„ç›´çº¿è·ç¦»
   3. ç‚¹ç§¯ï¼šä¸¤ä¸ªå‘é‡çš„ç‚¹ç§¯å€¼
4. è¿‡æ»¤ä¸æ’åºï¼šæ ¹æ®ç›¸ä¼¼åº¦è¿‡æ»¤ç»“æœï¼ŒæŒ‰ç…§ç›¸ä¼¼åº¦è¿”å›æœ€ç›¸å…³çš„æ–‡æ¡£

é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°å·²ç»é›†æˆäº†ï¼Œç±»æ˜¯ï¼š`DashScopeCloudStore`,å‚è€ƒæ–‡æ¡£ï¼š[DashScopeCloudStore](https://java2ai.com/docs/1.0.0-M6.1/tutorials/vectorstore/)

![image-20250615213244185](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250615213244185.png)

![image-20250615213614667](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250615213614667.png)

DashScopeCloudStoreç±»å®ç°äº†VectorStoreæ¥å£ï¼Œé€šè¿‡è°ƒç”¨DashScope API æ¥ä½¿ç”¨é˜¿é‡Œäº‘æä¾›çš„è¿œç¨‹å‘é‡å­˜å‚¨ï¼š

##### åŸºäºPGVectorå®ç°å‘é‡å­˜å‚¨

PGVectoræ˜¯ç»å…¸æ•°æ®åº“PGSQLçš„æ‰©å±•ï¼Œä¸ºPGSQLæä¾›äº†å­˜å‚¨å’Œæ£€ç´¢é«˜ç»´å‘é‡æ•°æ®åº“çš„èƒ½åŠ›ã€‚

ä¸ºä»€ä¹ˆé€‰è¿™ä¸ªæ¥åšå‘é‡æ•°æ®åº“å‘¢ï¼Ÿå› ä¸ºå¾ˆå¤šä¼ ç»Ÿä¸šåŠ¡éƒ½ä¼šå°†æ•°æ®å­˜å‚¨åœ¨è¿™ç§å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œç›´æ¥ç»™åŸæœ‰æ•°æ®åº“å®‰è£…æ‰©å±•æ’ä»¶å°±èƒ½å®ç°å‘é‡ç›¸ä¼¼æ€§æœç´¢ï¼Œä¸éœ€è¦é¢å¤–æä¸€å¥—å‘é‡æ•°æ®åº“ï¼ŒäººåŠ›ç‰©åŠ›æˆæœ¬å¾ˆä½ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ¡ˆå¾ˆå—ä¼ä¸šé’çï¼Œä¹Ÿæ˜¯ç›®å‰å®ç°RAGçš„ä¸»æµæ–¹æ¡ˆä¹‹ä¸€ã€‚

1. å®‰è£…PGSQL
2. å®‰è£…pgVector

ä¸ºäº†ç®€åŒ–å­¦ä¹ æˆæœ¬ï¼Œæˆ‘ä»¬é‡‡ç”¨ç®€å•çš„æ–¹å¼-é˜¿é‡Œäº‘è´­ä¹°PGSQLã€‚

æ‰“å¼€[é˜¿é‡Œäº‘PGSQLå®˜ç½‘](https://www.aliyun.com/product/rds/postgresql)ï¼Œå¼€é€šServerlessç‰ˆæœ¬ï¼ŒæŒ‰ç”¨é‡ä»˜è´¹ï¼Œå¯¹äºå­¦ä¹ æ¥è¯´æ€§ä»·æ¯”å¾ˆé«˜ã€‚

1ï¼‰å‚è€ƒ[Spring AI æ–‡æ¡£ä¸­](https://docs.spring.io/spring-ai/reference/api/vectordbs/pgvector.html)çš„æ•´åˆçš„PGVectorï¼Œå…ˆå¼•å…¥ä¾èµ–ï¼Œç‰ˆæœ¬å·å¯ä»¥åœ¨Mavenä»“åº“ä¸­æ‰¾åˆ°ã€‚

ç¼–å†™é…ç½®ï¼Œå»ºç«‹æ•°æ®åº“è¿æ¥ï¼š

```yaml
spring:
  datasource:
    url: jdbc:postgresql://æ”¹ä¸ºä½ çš„å…¬ç½‘åœ°å€/yu_ai_agent
    username: æ”¹ä¸ºä½ çš„ç”¨æˆ·å
    password: æ”¹ä¸ºä½ çš„å¯†ç 
  ai:
    vectorstore:
      pgvector:
        index-type: HNSW
        dimensions: 1536
        distance-type: COSINE_DISTANCE
        max-document-batch-size: 10000 # Optional: Maximum number of documents per batch
```

> åœ¨ä¸ç¡®å®šå‘é‡ç»´åº¦çš„æ¡ä»¶ä¸‹ä¸è¦æŒ‡å®šdimensionsã€‚æœªæ˜ç¡®æŒ‡å®šçš„è¯ï¼ŒPgVectorStoreä¼šä»æä¾›çš„EmbeddingModelä¸­æ£€ç´¢ç»´åº¦ï¼Œç»´åº¦åœ¨è¡¨åˆ›å»ºæ—¶è®¾ç½®æˆåµŒå…¥åˆ—ã€‚å¦‚æœæ›´æ”¹ç»´åº¦ï¼Œå¿…é¡»é‡æ–°åˆ›å»ºvector_storeè¡¨ã€‚

ä½¿ç”¨è‡ªåŠ¨æ³¨å…¥çš„VectorStoreï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºåº“è¡¨ï¼š

```java
@SpringBootTest
public class PgVectorVectorStoreConfigTest {

    @Resource
    VectorStore pgVectorVectorStore;

    @Test
    void test() {
        List<Document> documents = List.of(
                new Document("Spring AI rocks!! Spring AI rocks!! Spring AI rocks!! Spring AI rocks!! Spring AI rocks!!", Map.of("meta1", "meta1")),
                new Document("The World is Big and Salvation Lurks Around the Corner"),
                new Document("You walk forward facing the past and you turn back toward the future.", Map.of("meta2", "meta2")));
        // æ·»åŠ æ–‡æ¡£
        pgVectorVectorStore.add(documents);
        // ç›¸ä¼¼åº¦æŸ¥è¯¢
        List<Document> results = pgVectorVectorStore.similaritySearch(SearchRequest.builder().query("Spring").topK(5).build());
        Assertions.assertNotNull(results);
    }
}
```

ä½†æ˜¯è¿™ç§æ–¹å¼å¹¶ä¸é€‚åˆæˆ‘ä»¬çš„é¡¹ç›®ï¼Œæœ¬è´¨æ˜¯å› ä¸ºVectorStoreä¾èµ–EmbeddingModelå¯¹è±¡ï¼Œä¹‹å‰åŒæ—¶å¼•å…¥äº†Ollamaå’Œé˜¿é‡Œäº‘DashScopeä¾èµ–ï¼Œæœ‰ä¸¤ä¸ªEmbeddingModelçš„Beanï¼ŒSpringä¸çŸ¥é“ä½¿ç”¨å“ªä¸€ä¸ªï¼Ÿå°±ä¼šæŠ¥é”™ã€‚

2ï¼‰æˆ‘ä»¬æ›´æ¢å¦ä¸€ç§æ›´é€‚åˆçš„æ–¹å¼æ¥åˆå§‹åŒ–VectorStoreï¼Œå…ˆå¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-jdbc</artifactId>
</dependency>
<dependency>
    <groupId>org.postgresql</groupId>
    <artifactId>postgresql</artifactId>
    <scope>runtime</scope>
</dependency>
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-pgvector-store</artifactId>
    <version>1.0.0-M6</version>
</dependency>
```



ç¼–å†™è‡ªå·±æ„é€ çš„VectorStoreï¼Œä¸ç”¨Starterè‡ªåŠ¨æ³¨å…¥ã€‚

```java
@Configuration
public class PgVectorVectorStoreConfig {

    @Bean
    public VectorStore pgVectorVectorStore(JdbcTemplate jdbcTemplate, EmbeddingModel dashscopeEmbeddingModel) {
        VectorStore vectorStore = PgVectorStore.builder(jdbcTemplate, dashscopeEmbeddingModel)
                .dimensions(1536)                    // Optional: defaults to model dimensions or 1536
                .distanceType(COSINE_DISTANCE)       // Optional: defaults to COSINE_DISTANCE
                .indexType(HNSW)                     // Optional: defaults to HNSW
                .initializeSchema(true)              // Optional: defaults to false
                .schemaName("public")                // Optional: defaults to "public"
                .vectorTableName("vector_store")     // Optional: defaults to "vector_store"
                .maxDocumentBatchSize(10000)         // Optional: defaults to 10000
                .build();
        return vectorStore;
    }
}
```



å¯åŠ¨ç±»éœ€è¦æ‰‹åŠ¨æ’é™¤æ‰è‡ªåŠ¨åŠ è½½ï¼Œ

```java
@SpringBootApplication(exclude = PgVectorStoreAutoConfiguration.class)
```

3ï¼‰ç¼–å†™å•å…ƒæµ‹è¯•ç±»

```java
@SpringBootTest
public class PgVectorVectorStoreConfigTest {

    @Resource
    VectorStore pgVectorVectorStore;

    @Test
    void test() {
        List<Document> documents = List.of(
                new Document("Spring AI rocks!! Spring AI rocks!! Spring AI rocks!! Spring AI rocks!! Spring AI rocks!!", Map.of("meta1", "meta1")),
                new Document("The World is Big and Salvation Lurks Around the Corner"),
                new Document("You walk forward facing the past and you turn back toward the future.", Map.of("meta2", "meta2")));
        // æ·»åŠ æ–‡æ¡£
        pgVectorVectorStore.add(documents);
        // ç›¸ä¼¼åº¦æŸ¥è¯¢
        List<Document> results = pgVectorVectorStore.similaritySearch(SearchRequest.builder().query("Spring").topK(5).build());
        Assertions.assertNotNull(results);
    }
}
```

Debugæ¨¡å¼å¯åŠ¨ï¼Œçœ‹åˆ°æ–‡æ¡£æ£€ç´¢æˆåŠŸï¼Œå¾—åˆ°äº†ç›¸å…³çš„ç›¸ä¼¼åº¦åˆ†æ•°ï¼š

![image-20250615234243978](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250615234243978.png)

åŒæ—¶æŸ¥çœ‹æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œå‘ç°å­˜åœ¨ä¸‰æ¡æ•°æ®![image-20250615234320877](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250615234320877.png)

æŸ¥çœ‹ä¸€ä¸‹è¡¨ç»“æ„ï¼š

![image-20250615234349190](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250615234349190.png)

è‡³æ­¤ï¼Œæˆ‘ä»¬çš„PGVectorStoreå°±æ•´åˆæˆåŠŸäº†ï¼Œä½ å¯ä»¥ç”¨LoveAppDocumentLoaderæ¥æ›¿æ¢æ–‡æœ¬æ¥æºï¼š

```java
@Configuration
public class PgVectorVectorStoreConfig {

    @Resource
    private LoveAppDocumentLoader loveAppDocumentLoader;

    @Bean
    public VectorStore pgVectorVectorStore(JdbcTemplate jdbcTemplate, EmbeddingModel dashscopeEmbeddingModel) {
        VectorStore vectorStore = PgVectorStore.builder(jdbcTemplate, dashscopeEmbeddingModel)
                .dimensions(1536)
                .distanceType(COSINE_DISTANCE)
                .indexType(HNSW)
                .initializeSchema(true)
                .schemaName("public")
                .vectorTableName("vector_store")
                .maxDocumentBatchSize(10000)
                .build();

        // åŠ è½½æ–‡æ¡£
        List<Document> documents = loveAppDocumentLoader.loadMarkdowns();
        vectorStore.add(documents);
        return vectorStore;
    }
}
```



æµ‹è¯•ä¸€ä¸‹ï¼šï¼ˆå…³é”®è¯æ˜¯â€œç»“å©šâ€ï¼‰

![image-20250615234815723](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250615234815723.png)



###### æ‰©å±•--æ‰¹å¤„ç†ç­–ç•¥

ä½¿ç”¨å‘é‡å­˜å‚¨çš„æ—¶å€™ï¼Œå¯èƒ½è¦åµŒå…¥å¤§é‡æ–‡æ¡£ï¼Œå¦‚æœä¸€æ¬¡æ€§å¤„ç†å¤§é‡æ–‡æ¡£ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚

åµŒå…¥æ¨¡å‹ä¸€èˆ¬æœ‰ä¸€ä¸ªæœ€å¤§æ ‡è®°é™åˆ¶ï¼Œé€šå¸¸ç§°ä¸ºä¸Šä¸‹æ–‡çª—å£å¤§å°ï¼Œé™åˆ¶äº†å•ä¸ªåµŒå…¥è¯·æ±‚ä¸­è¯¾å¯ä»¥å¤„ç†çš„æ–‡æœ¬é‡ã€‚å¦‚æœåœ¨ä¸€æ¬¡è°ƒç”¨ä¸­è½¬æ¢è¿‡å¤šæ–‡æ¡£å¯èƒ½ç›´æ¥å¯¼è‡´æŠ¥é”™ã€‚

ä¸ºæ­¤ï¼ŒSpring AI å®ç°äº†æ‰¹å¤„ç†ç­–ç•¥ï¼ˆBatching Strategyï¼‰,å°†å¤§é‡çš„æ–‡æ¡£åˆ†è§£æˆè¾ƒå°çš„æ‰¹æ¬¡ï¼Œä½¿å…¶é€‚åˆåµŒå…¥æ¨¡å‹æœ€å¤§ä¸Šä¸‹æ–‡çª—å£ï¼Œè¿˜å¯ä»¥æé«˜æ€§èƒ½æœ‰æ•ˆåˆ©ç”¨APIé€Ÿç‡é™åˆ¶ã€‚

```java
public interface BatchingStrategy {
    List<List<Document>> batch(List<Document> documents);
}
```

Spring AI æä¾›äº†ä¸€ä¸ªåä¸ºTokenCountBatchingStrategyçš„é»˜è®¤å®ç°ã€‚è¿™ä¸ªç­–ç•¥ä¸ºæ¯ä¸€ä¸ªæ–‡æ¡£ä¼°ç®—Tokenæ•°é‡ï¼Œå°†æ–‡æ¡£åˆ†ç»„åˆ°ä¸è¶…è¿‡æœ€å¤§è¾“å…¥Tokenæ•°çš„æ‰¹æ¬¡ä¸­ï¼Œå¦‚æœå•ä¸ªæ–‡ä»¶è¶…è¿‡æ­¤é™åˆ¶ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œè¿™æ ·å°±ç¡®ä¿äº†æ¯ä¸€ä¸ªæ‰¹æ¬¡ä¸è¶…è¿‡è®¡ç®—å‡ºçš„æœ€å¤§è¾“å…¥Tokenæ•°ã€‚

```java
@Configuration
public class EmbeddingConfig {
    @Bean
    public BatchingStrategy customTokenCountBatchingStrategy() {
        return new TokenCountBatchingStrategy(
            EncodingType.CL100K_BASE,  // æŒ‡å®šç¼–ç ç±»å‹
            8000,                      // è®¾ç½®æœ€å¤§è¾“å…¥æ ‡è®°è®¡æ•°
            0.1                        // è®¾ç½®ä¿ç•™ç™¾åˆ†æ¯”
        );
    }
}
```

é™¤äº†ä½¿ç”¨é»˜è®¤çš„ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®ç°batchingStrategyï¼š

```java
@Configuration
public class EmbeddingConfig {
    @Bean
    public BatchingStrategy customBatchingStrategy() {
        return new CustomBatchingStrategy();
    }
}
```



å¦‚æœä½ ä½¿ç”¨çš„å‘é‡æ•°æ®åº“æ¯ç§’åªèƒ½æ’å…¥1ä¸‡æ¡æ•°æ®ï¼Œå°±å¯ä»¥é€šè¿‡è‡ªå®šä¹‰BatchingStrategyæ§åˆ¶é€Ÿç‡ï¼Œè¿˜å¯ä»¥è¿›è¡Œé¢å¤–çš„æ—¥å¿—è®°å½•å’Œå¼‚å¸¸å¤„ç†ã€‚

#### æ–‡æ¡£è¿‡æ»¤å’Œæ£€ç´¢



Spring AIæä¾›äº†â€œæ¨¡å—åŒ–â€çš„RAGæ¶æ„ï¼Œç”¨äºä¼˜åŒ–å¤§æ¨¡å‹å›å¤çš„å‡†ç¡®æ€§

ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å°†æ–‡æ¡£è¿‡æ»¤è¿‡ç¨‹åˆ†æˆï¼šæ£€ç´¢å‰ã€æ£€ç´¢æ—¶ã€æ£€ç´¢åã€‚

- é¢„æ£€ç´¢ï¼šç³»ç»Ÿæ¥æ”¶ç”¨æˆ·çš„åŸå§‹æŸ¥è¯¢ï¼Œé€šè¿‡æŸ¥è¯¢è½¬åŒ–å’ŒæŸ¥è¯¢æ‰©å±•å¯¹å…¶è¿›è¡Œä¼˜åŒ–ã€‚
- æ£€ç´¢é˜¶æ®µï¼šä½¿ç”¨å¢å¼ºçš„æŸ¥è¯¢ä»çŸ¥è¯†åº“ä¸­æœç´¢ç›¸å…³çš„æ–‡æ¡£ï¼Œå¯èƒ½æ¶‰åŠåˆ°å¤šä¸ªæ£€ç´¢æºåˆå¹¶ï¼Œæœ€ç»ˆè¾“å‡ºä¸€ç»„ç›¸å…³æ–‡æ¡£
- æ£€ç´¢åï¼šç³»ç»Ÿå¯¹æ£€ç´¢åˆ°çš„æ–‡æ¡£è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼ŒåŒ…æ‹¬æ’åºã€é€‰æ‹©æœ€ç›¸å…³çš„å­é›†ä»¥åŠå‹ç¼©æ–‡æ¡£å†…å®¹ï¼Œè¾“å‡ºç»è¿‡ä¼˜åŒ–çš„æ–‡æ¡£é›†

##### é¢„æ£€ç´¢ï¼šä¼˜åŒ–ç”¨æˆ·æŸ¥è¯¢

###### æŸ¥è¯¢è½¬æ¢ - æŸ¥è¯¢é‡å†™

`RewriteQueryTransformer`ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹å¯¹ç”¨æˆ·çš„åŸå§‹æŸ¥è¯¢è¿›è¡Œæ”¹å†™ï¼Œä½¿å¾—æ›´åŠ è¯¦ç»†å’Œæ¸…æ™°ã€‚

```java
Query query = new Query("ä»€ä¹ˆæ˜¯Transformerå•Šå•Šå•Šå•Šå•Šå•Šå•Š");
QueryTransformer queryTransformer = RewriteQueryTransformer.builder()
  .chatClientBuilder(chatClientBuilder)
  .build();

Query transformedQuery = queryTransformer.transform(query);
```

å¯ä»¥ä»æºç ä¸­çœ‹åˆ°æç¤ºè¯ï¼š

![image-20250616010101086](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250616010101086.png)

ä¹Ÿå¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•çš„`promptTemplate`å‚æ•°è‡ªå®šä¹‰ç»„ä»¶ä½¿ç”¨æç¤ºæ¨¡æ¿ï¼š

![image-20250616010223728](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250616010223728.png)

**æŸ¥è¯¢è½¬æ¢ - æŸ¥è¯¢ç¿»è¯‘**

`TranslationQueryTransformer`å°†æŸ¥è¯¢ç¿»è¯‘æˆåµŒå…¥æ¨¡å‹æ”¯æŒçš„ç›®æ ‡è¯­è¨€ã€‚å¦‚æœæŸ¥è¯¢å·²ç»æ˜¯ç›®æ ‡è¯­è¨€ï¼Œåˆ™ä¿æŒä¸å˜ã€‚å¯¹äºåµŒå…¥æ¨¡å‹æ˜¯é’ˆå¯¹äºè¯­è¨€ç‰¹å®šè®­ç»ƒè€Œç”¨æˆ·ä½¿ç”¨ä¸åŒçš„è¯­è¨€æŸ¥è¯¢éå¸¸é‡è¦ã€‚

å®ä¾‹ä»£ç ï¼š

```java
Query query = new Query("Hi, who is Libai, please answer me!");

QueryTransformer queryTransformer = TranslationQueryTransformer.builder()
  .chatClientBuilder(chatClientBuilder)
  .targetLanguage("ç®€ä½“ä¸­æ–‡")
  .build();

Query transformerQuery = queryTransformer.transform)(query);
```

è¯­è¨€å¯ä»¥éšæ„æŒ‡å®šï¼ŒæŸ¥çœ‹æºç å‘ç°ï¼Œå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªPromptï¼š

![image-20250616010820928](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250616010820928.png)

ä¸è¿‡ä¸å»ºè®®ä½¿ç”¨ï¼Œæ¯•ç«Ÿåªæ˜¯ä¸€ä¸ªç¿»è¯‘ï¼Œå…¶å®ä½¿ç”¨è¿™ä¸ªæŸ¥è¯¢å™¨çš„è¯ä¹Ÿæ˜¯ä¼šå ç”¨Tokenï¼Œå¯¼è‡´æˆæœ¬å¢åŠ ï¼Œä½¿ç”¨ç¿»è¯‘çš„è¯ç›´æ¥ä½¿ç”¨ä¸‰æ–¹çš„ç¿»è¯‘SDKå³å¯ã€‚

ï¼ˆç™¾åº¦ç¿»è¯‘ã€ç«å±±ç¿»è¯‘ã€google Translationç­‰ç­‰ï¼‰



**æŸ¥è¯¢è½¬æ¢ - æŸ¥è¯¢å‹ç¼©**

`CompressionQueryTransformer`ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹å°†å¯¹è¯å†å²å’Œåç»­æŸ¥è¯¢å‹ç¼©æˆä¸€ä¸ªç‹¬ç«‹çš„æŸ¥è¯¢ï¼Œç±»ä¼¼äºæ¦‚æ‹¬æ€»ç»“ã€‚

å®ä¾‹ä»£ç ï¼š

```java
Query query = Query.builder()
  .text("Googleèƒ½å¹²å•¥ï¼Ÿ")
  .history(new UserMessage("è°æ˜¯Trumpï¼Ÿ"), 
          new AssistantMessage("ç¾å›½ä¼Ÿäºº"))
  .build();

QueryTransformer queryTransformer = CompressionQueryTransformer.builder()
  .chatClientBuilder(chatClientBuilder)
  .build();

Query transformQuery = queryTransformer.transform(query);
```



æŸ¥çœ‹æºç ï¼Œ![image-20250616011545141](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250616011545141.png)

**æŸ¥è¯¢æ‰©å±• - å¤šæŸ¥è¯¢æ‰©å±•**

`MultiQueryExpander`ä½¿ç”¨å¤§æ¨¡å‹å°†ä¸€ä¸ªæŸ¥è¯¢æ‰©å±•ä¸ºå¤šä¸ªè¯­ä¹‰ä¸Šä¸åŒçš„å˜ä½“ï¼Œæœ‰åŠ©äºæ£€ç´¢é¢å¤–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å¹¶å¢åŠ æ‰¾åˆ°ç›¸å…³ç»“æœçš„æœºä¼šï¼Œ

å®ä¾‹ä»£ç ï¼š

```java
MultiQueryExpander queryExpander = MultiQueryExpander.builder()
    .chatClientBuilder(chatClientBuilder)
    .numberOfQueries(3)
    .build();
List<Query> queries = queryExpander.expand(new Query("å•¥æ˜¯å°¤é›¨æºªï¼Ÿä»–ä¼šå•¥ï¼Ÿ"));
```



é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šåœ¨æŸ¥è¯¢æ‰©å±•åˆ—è¡¨çš„æ—¶å€™åŒ…å«åŸå§‹æŸ¥è¯¢ï¼Œå¯ä»¥åœ¨æ„é€ æ—¶é€šè¿‡`includeOriginal`æ–¹æ³•æ”¹å˜è¿™ä¸ªè¡Œä¸ºï¼š

```java
MultiQueryExpander queryExpander = MultiQueryExpander.builder()
    .chatClientBuilder(chatClientBuilder)
    .includeOriginal(false)
    .build();
```

æŸ¥çœ‹æºç ï¼š

![image-20250616012105134](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250616012105134.png)

![image-20250616012213488](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250616012213488.png)

å…ˆä½¿ç”¨Promptæé—®AIï¼Œå¾—åˆ°çš„å“åº”ä¼šæ ¹æ®æ¢è¡Œè¿›è¡Œæ‹†åˆ†ã€‚

###### æ£€ç´¢ æé«˜æŸ¥è¯¢ç›¸å…³æ€§

**æ–‡æ¡£æœç´¢**

åˆ©ç”¨çš„æ˜¯`DocumentRetriever`çš„æ¦‚å¿µï¼Œè¿™æ˜¯Spring AIæä¾›çš„æ–‡æ¡£æ£€ç´¢å™¨ï¼Œæ¯ç§ä¸åŒçš„å­˜å‚¨æ–¹æ¡ˆéƒ½æœ‰è‡ªå·±çš„æ–‡æ¡£æ£€ç´¢å™¨å®ç°ç±»ï¼Œæ¯”å¦‚ï¼š`VectorStoreDocumentRetriever`ï¼Œä»å‘é‡å­˜å‚¨ä¸­æ£€ç´¢ä¸è¾“å…¥æŸ¥è¯¢è¯­å¥ç›¸ä¼¼çš„æ–‡æ¡£ã€‚æ”¯æŒåŸºäºå…ƒæ•°æ®çš„è¿‡æ»¤ã€è®¾ç½®ç›¸ä¼¼åº¦é˜ˆå€¼ã€è®¾ç½®è¿”å›çš„ç»“æœæ•°ã€‚



```java
DocumentRetriever retriever = VectorStoreDocumentRetriever.builder()
    .vectorStore(vectorStore)
    .similarityThreshold(0.7)
    .topK(5)
    .filterExpression(new FilterExpressionBuilder()
        .eq("type", "web")
        .build())
    .build();
List<Document> documents = retriever.retrieve(new Query("è°æ˜¯å”æœæç™½"));
```



ä¸Šè¿°çš„filterExpressionå¯ä»¥çµæ´»çš„æŒ‡å®šè¿‡æ»¤æ¡ä»¶ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡æ„é€ Queryå¯¹è±¡çš„`FILTER_EXPRESSION`å‚æ•°åŠ¨æ€æŒ‡å®šè¿‡æ»¤è¡¨è¾¾å¼ï¼š

```java
Query query = Query.builder()
    .text("è°æ˜¯é±¼çš®ï¼Ÿ")
    .context(Map.of(VectorStoreDocumentRetriever.FILTER_EXPRESSION, "type == 'boy'"))
    .build();
List<Document> retrievedDocuments = documentRetriever.retrieve(query);
```

**æ–‡æ¡£åˆå¹¶**

Spring AIå†…ç½®äº†`ConcatenationDocumentJoiner`æ–‡æ¡£åˆå¹¶å™¨ï¼Œé€šè¿‡è¿æ¥æ“ä½œï¼Œå°†åŸºäºå¤šä¸ªæŸ¥è¯¢å’Œæ¥è‡ªå¤šä¸ªæ•°æ®æºæ£€ç´¢åˆ°çš„æ–‡æ¡£åˆå¹¶æˆå•ä¸ªæ–‡æ¡£é›†åˆã€‚åœ¨é‡åˆ°é‡å¤æ–‡æ¡£æ—¶ï¼Œä¼šä¿ç•™é¦–æ¬¡å‡ºç°çš„æ–‡æ¡£ï¼Œæ¯ä¸ªæ–‡æ¡£çš„åˆ†æ•°ä¿æŒä¸å˜ã€‚

ç¤ºä¾‹ä»£ç ï¼š
```java
Map<Query, List<List<Document>>> documentsForQuery = ...
DocumentJoiner documentJoiner = new ConcatenationDocumentJoiner();
List<Document> documents = documentJoiner.join(documentsForQuery);
```

è¿™ä¸ªæºç çš„åŸç†å¾ˆç®€å•ï¼Œå…¶å®å°±æ˜¯å°†Mapå±•å¼€ä¸ºäºŒç»´åˆ—è¡¨ã€å†å°†äºŒç»´åˆ—è¡¨å±•å¼€æˆæ–‡æ¡£åˆ—è¡¨ï¼Œæœ€åè¿›è¡Œå»é‡ã€‚![image-20250616013858902](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250616013858902.png)

**æ£€ç´¢åï¼šä¼˜åŒ–æ–‡æ¡£å¤„ç†**

æš‚æ—¶ç•¥è¿‡ï¼Œç”¨åˆ°çš„æœºä¼šä¸å¤§ã€‚

##### æŸ¥è¯¢å¢å¼ºå’Œå…³è”

ç”Ÿæˆé˜¶æ®µæ˜¯RAGæµç¨‹çš„æœ€åé˜¶æ®µï¼Œè´Ÿè´£å°†æ£€ç´¢åˆ°çš„æ–‡æ¡£å’Œç”¨æˆ·æŸ¥è¯¢ç»“åˆèµ·æ¥ï¼Œä¸ºAIæä¾›å¿…è¦çš„ä¸Šä¸‹æ–‡ï¼Œä»æœªç”Ÿæˆæ›´å‡†ç¡®ã€æ›´ç›¸å…³çš„å›ç­”ã€‚

ä¹‹å‰æˆ‘ä»¬å·²ç»äº†è§£Spring AI æä¾›çš„ä¸¤ç§å®ç°çš„ RAGæŸ¥è¯¢å¢å¼ºAdvisor ï¼Œåˆ†åˆ«æ˜¯`QuestionAnswerAdvisor`å’Œ`RetrievalAugmentation Advisor`ã€‚

###### QuestionAnswerAdvisoræŸ¥è¯¢å¢å¼º

å½“ç”¨æˆ·é—®é¢˜å‘é€åˆ°AIæ¨¡å‹æ—¶ï¼ŒAdvisorä¼šæŸ¥è¯¢å‘é‡æ•°æ®åº“æ¥è·å–ä¸ç”¨æˆ·é—®é¢˜ç›¸å…³çš„æ–‡æ¡£ï¼Œå¹¶å°†è¿™äº›æ–‡æ¡£ä½œä¸ºä¸Šä¸‹æ–‡é™„åŠ åˆ°ç”¨æˆ·æŸ¥è¯¢ä¸­ã€‚

ä½¿ç”¨æ–¹å¼ï¼š

```java
ChatResponse response = ChatClient.builder(chatModel)
        .build()
  			.prompt()
        .advisors(new QuestionAnswerAdvisor(vectorStore))
        .user(userText)
        .call()
        .chatResponse();
```



æˆ‘ä»¬å¯ä»¥é€šè¿‡å»ºé€ è€…æ¨¡å¼é…ç½®æ›´ç²¾ç»†çš„å‚æ•°ï¼Œæ¯”å¦‚æ–‡æ¡£è¿‡æ»¤æ¡ä»¶ã€‚

```java
var qaAdvisor = QuestionAnswerAdvisor.builder(vectorStore)
              // ç›¸ä¼¼åº¦é˜ˆå€¼ä¸º 0.8ï¼Œå¹¶è¿”å›æœ€ç›¸å…³çš„å‰ 6 ä¸ªç»“æœ
        .searchRequest(SearchRequest.builder().similarityThreshold(0.8d).topK(6).build())
        .build();
```

`QuestionAnswerAdvisor`è¿˜æ”¯æŒåŠ¨æ€è¿‡æ»¤è¡¨è¾¾å¼ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æ ¹æ®éœ€è¦è°ƒæ•´è¿‡æ»¤æ¡ä»¶ï¼š

```java
ChatClient chatClient = ChatClient.builder(chatModel)
  .defaultAdvisors(QuestionAnswerAdvisor.builder(vectorStore)
                  .searchRequest(SearchRequest.builder().build())
                  .build())
  .build();

// åœ¨è¿è¡Œæ—¶æ›´æ–°è¿‡æ»¤è¡¨è¾¾å¼
String content = this.chatClient.prompt()
  .user("Super idol çš„ç¬‘å®¹ï¼Œéƒ½æ²¡ä½ çš„ç”œ")
  .advisors(a -> a.param(QuestionAnswerAdvisor.FILTER_EXPRESSION, "type == 'web'"))
  .call()
  .content();
```

`QuestionAnswerAdvisor`çš„å®ç°åŸç†å¾ˆç®€å•ï¼ŒæŠŠç”¨æˆ·æç¤ºè¯å’Œæ£€ç´¢åˆ°çš„æ–‡æ¡£ç­‰ä¸Šä¸‹æ–‡ä¿¡æ¯æ‹¼æˆä¸€ä¸ªæ–°çš„Promptï¼Œå†è°ƒç”¨AIï¼š

![image-20250616015222217](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250616015222217.png)

æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰æç¤ºè¯æ¨¡æ¿ï¼Œæ§åˆ¶å¦‚ä½•å°†æ£€ç´¢åˆ°çš„æ–‡æ¡£ä¸ç”¨æˆ·æŸ¥è¯¢ç»“åˆï¼š

```java
QuestionAnswerAdvisor qaAdvisor = QuestionAnswerAdvisor.builder(vectorStore)
    .promptTemplate(customPromptTemplate)
    .build();
```

###### RetirevalAugmentationAdvisoræŸ¥è¯¢å¢å¼º

Spring AI æä¾›å¦ä¸€ä¸ªRAGçš„å®ç°æ–¹å¼ï¼Œå®ƒåŸºäºRAGæ¨¡å—åŒ–æ¶æ„ï¼Œæä¾›äº†æ›´å¤šçš„çµæ´»æ€§å’Œå®šåˆ¶é€‰é¡¹ã€‚

æœ€ç®€å•çš„RAGæµç¨‹å¯ä»¥é€šè¿‡ä»¥ä¸‹çš„æ–¹å¼å®ç°ï¼š

```java
Advisor retrivalAugmentationAdvisor = RetrievalAugmentationAdvisor.builder()
                .documentRetriever(VectorStoreDocumentRetriever.builder()
                        .similarityThreshold(0.5)
                        .vectorStore(loveAppVectorStore)
                        .build())
                .build();
        String answer = chatClient.prompt()
                .advisors(retrivalAugmentationAdvisor)
                .user(question) // String
                .call()
                .content();
```



ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬é…ç½®äº†`VectorStoreDocumentRetriver`æ–‡æ¡£æ£€ç´¢å™¨ï¼Œç”¨äºä»å‘é‡å­˜å‚¨ä¸­æ£€ç´¢æ–‡æ¡£ã€‚ä¹‹åå°†è¿™ä¸ªAdvisoræ·»åŠ åˆ°ChatClientè¯·æ±‚ä¸­ï¼Œè®©ä»–å¤„ç†ç”¨æˆ·é—®é¢˜ã€‚

`RetrievalAugmentationAdvisor`è¿˜æ”¯æŒæ›´é«˜çº§çš„RAGæµç¨‹ï¼Œæ¯”å¦‚ç»“åˆæŸ¥è¯¢è½¬æ¢å™¨ï¼š

```java
 RetrievalAugmentationAdvisor build = RetrievalAugmentationAdvisor.builder()
                .queryTransformers(RewriteQueryTransformer.builder()
                        .chatClientBuilder(chatClientBuilder.build().mutate())
                        .build())
                .documentRetriever(VectorStoreDocumentRetriever.builder()
                        .similarityThreshold(0.5)
                        .vectorStore(loveAppVectorStore)
                        .build())
                .build();
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ª`RewriteQueryTransformer`ï¼Œå®ƒä¼šåœ¨æ£€ç´¢ä¹‹å‰é‡å†™ç”¨æˆ·çš„åŸå§‹æŸ¥è¯¢ï¼Œä½¿å…¶æ›´åŠ æ˜ç¡®è¯¦ç»†å’Œè¯¦ç»†ï¼Œä»è€Œæ˜¾è‘—æå‡æ£€ç´¢çš„ è´¨é‡ã€‚

###### ContextQueryAugmentç©ºä¸Šä¸‹æ–‡å¤„ç†

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`RetriveAugmentationAdvisor`ä¸å…è®¸æ£€ç´¢ä¸Šä¸‹æ–‡ä¸ºç©ºï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„æ–‡æ¡£ï¼Œä¼šæŒ‡ç¤ºæ¨¡å‹ä¸è¦å›ç­”ç”¨æˆ·æŸ¥è¯¢ã€‚è¿™æ˜¯ä¸€ç§ä¿å®ˆçš„ç­–ç•¥ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¼€å¯å…è®¸ç©ºä¸Šä¸‹æ–‡ï¼š

```java
Advisor retrievalAugmentationAdvisor = RetrievalAugmentationAdvisor.builder()
        .documentRetriever(VectorStoreDocumentRetriever.builder()
                .similarityThreshold(0.50)
                .vectorStore(vectorStore)
                .build())
        .queryAugmenter(ContextualQueryAugmenter.builder()
                .allowEmptyContext(true)
                .build())
        .build();

String answer = chatClient.prompt()
        .advisors(retrievalAugmentationAdvisor)
        .user(question)
        .call()
        .content();
```

`ContextualQueryAugmenter`å…è®¸æˆ‘ä»¬è‡ªå®šä¹‰æç¤ºæ¨¡æ¿ï¼Œ

```java
QueryAugmenter queryAugmenter = ContextualQueryAugmenter.builder()
                        .promptTemplate(customPromptTemplate)
                                .emptyContextPromptTemplate(emptyContextPromptTempldate);
```



### RAGå®è·µå’Œè°ƒä¼˜

#### æ–‡æ¡£æ”¶é›†å’Œåˆ‡å‰²

æ–‡æ¡£çš„è´¨é‡å†³å®šäº†AIå›ç­”èƒ½åŠ›çš„ä¸Šé™ï¼Œå…¶ä»–ä¼˜åŒ–ç­–ç•¥åªæ˜¯è®©AIå›ç­”èƒ½åŠ›ä¸æ–­æ¥è¿‘ä¸Šé™ã€‚

##### 1ã€ä¼˜åŒ–åŸå§‹æ–‡æ¡£

**åªæ˜¯å®Œå¤‡æ€§**æ˜¯æ–‡æ¡£è´¨é‡çš„é¦–è¦æ¡ä»¶ã€‚å¦‚æœçŸ¥è¯†åº“ç¼ºå°‘ç›¸å…³å†…å®¹ï¼Œå¤§æ¨¡å‹å°†æ— æ³•å‡†ç¡®å›ç­”å¯¹åº”é—®é¢˜ã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡æ”¶é›†ç”¨æˆ·åé¦ˆæˆ–ç»Ÿè®¡çŸ¥è¯†åº“å‘½ä¸­ç‡ï¼Œä¸æ–­å®Œå–„ä¼˜åŒ–çŸ¥è¯†åº“å†…å®¹ã€‚

**å†…å®¹ç»“æ„åŒ–**

1ï¼‰åŸå§‹æ–‡æ¡£åº”ä¿æŒæ’ç‰ˆæ¸…æ™°ã€ç»“æ„åˆç†ï¼Œå¦‚æ¡ˆä¾‹ç¼–å·ã€é¡¹ç›®æ¦‚è¿°ã€è®¾è®¡è¦ç‚¹ç­‰

2ï¼‰æ–‡æ¡£çš„å„çº§æ ‡é¢˜å±‚æ¬¡åˆ†æ˜ï¼Œä¸ªæ ‡é¢˜å†…å®¹è¡¨è¾¾æ¸…æ™°

3ï¼‰åˆ—è¡¨ä¸­é—´çš„æŸä¸€æ¡ä¹‹ä¸‹å°½é‡ä¸è¦å†åˆ†çº§ï¼Œå‡å°‘å±‚çº§åµŒå¥—

**å†…å®¹è§„èŒƒåŒ–**

1ï¼‰è¯­è¨€ç»Ÿä¸€ï¼šç¡®ä¿æ–‡æ¡£è¯­è¨€ä¸ç”¨æˆ·æç¤ºè¯ä¸€è‡´ï¼Œä¸“ä¸šæœ¯è¯­è¿›è¡Œå¤šè¯­è¨€æ ‡æ³¨

2ï¼‰è¡¨è¿°ç»Ÿä¸€ï¼šåŒä¸€æ¦‚å¿µä½¿ç”¨ç»Ÿä¸€è¡¨è¾¾å¼

3ï¼‰å‡å°‘å™ªéŸ³ï¼šå°½é‡é¿å…æ°´å°ã€è¡¨æ ¼å’Œå›¾ç‰‡ç­‰å¯èƒ½äº§ç”Ÿå½±å“çš„å› ç´ 



**æ ¼å¼æ ‡å‡†åŒ–**

1ï¼‰ä¼˜å…ˆä½¿ç”¨Markdownã€Doc/Docxç­‰æ–‡æœ¬æ–‡æ¡£ï¼ˆPDFçš„æ•ˆæœå¯èƒ½ä¸å¥½ï¼‰

2ï¼‰å¦‚æœæ–‡æ¡£ä¸­åŒ…å«å›¾ç‰‡ï¼Œéœ€é“¾æ¥åŒ–å¤„ç†ï¼Œç¡®ä¿å›ç­”ä¸­èƒ½æ­£å¸¸å±•ç¤ºæ–‡æ¡£çš„æ’å›¾ï¼Œå¯ä»¥é€šè¿‡åœ¨æ–‡æ¡£ä¸­æ’å…¥å¯å…¬ç½‘è®¿é—®URL é“¾æ¥å®ç°

##### 2ã€æ–‡æ¡£åˆ‡ç‰‡

åˆé€‚çš„æ–‡æ¡£åˆ‡ç‰‡å¤§å°å’Œæ–¹å¼å¯¹æ£€ç´¢æ•ˆæœè‡³å…³é‡è¦ã€‚

æ–‡æ¡£åˆ‡ç‰‡å°ºå¯¸éœ€è¦æ ¹æ®å…·ä½“æƒ…å†µçµæ´»è°ƒæ•´ï¼Œé¿å…ä¸¤ä¸ªæç«¯ï¼šåˆ‡ç‰‡å¤ªçŸ­å¯¼è‡´è¯­ä¹‰ç¼ºå¤±ï¼Œåˆ‡ç‰‡å¤ªé•¿å¯¼è‡´æ— å…³ä¿¡æ¯ã€‚å…·ä½“éœ€ç»“åˆæ–‡æ¡£ç±»å‹å’Œæç¤ºè¯å¤æ‚åº¦ã€‚

æœ€ä½³åˆ†ç‰‡ç­–ç•¥æ˜¯**ç»“åˆåªèƒ½åˆ†å—ç®—æ³•å’Œäººå·¥äºŒæ¬¡æ ¡éªŒ**ã€‚æ™ºèƒ½åˆ†å—ç®—æ³•åŸºäºåˆ†å±€æ ‡è¯†ç¬¦å…ˆåˆ’åˆ†ä¸ºæ®µè½ï¼Œå†æ ¹æ®è¯­ä¹‰ç›¸å…³æ€§åŠ¨æ€é€‰æ‹©åˆ‡åˆ†ç‚¹ï¼Œé¿å…å›ºå®šé•¿åº¦åˆ‡åˆ†å¯¼è‡´çš„è¯­ä¹‰æ–­è£‚ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå°½é‡è®©æ–‡æœ¬åˆ‡ç‰‡åŒ…å«å®Œæ•´ä¿¡æ¯ï¼ŒåŒæ—¶é¿å…åŒ…å«è¿‡å¤šå¹²æ‰°ä¿¡æ¯ã€‚

åœ¨å®ç°ä¸Šæ¥è¯´ï¼Œå¯ä»¥é€šè¿‡Spring AI çš„[ETL Pipeline](https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_tokentextsplitter)æä¾›çš„DocumentTransformeræ¥è°ƒæ•´åˆ‡ç‰‡è§„åˆ™ï¼š

```java
@Component
public class MyTokenTextSplitter {
    public List<Document> splitDocuments(List<Document> documents) {
        TokenTextSplitter splitter = new TokenTextSplitter();
        return splitter.apply(documents);
    }

    public List<Document> splitCustomized(List<Document> documents) {
        TokenTextSplitter splitter = new TokenTextSplitter(1000, 400, 10, 500, true);
        return splitter.apply(documents);
    }
}
```

ä½¿ç”¨åˆ‡åˆ†å™¨

```java
// ä½¿ç”¨åˆ†è¯å™¨
        SimpleVectorStore simpleVectorStore = SimpleVectorStore.builder(dashscopeEmbeddingModel)
                .build();
        // åŠ è½½æ–‡æ¡£
        List<Document> documents = loveAppDocumentLoader.loadMarkdowns();
        // è‡ªä¸»åˆ‡åˆ†
        List<Document> splitDocuments = myTokenTextSplitter.splitCustomized(documents);
        simpleVectorStore.add(splitDocuments);
        return simpleVectorStore;
```



æ‰‹åŠ¨è°ƒæ•´åˆ‡åˆ†å‚æ•°å¾ˆéš¾æŠŠæ¡åˆé€‚å€¼ï¼Œå®¹æ˜“ç ´åè¯­ä¹‰å®Œæ•´æ€§ã€‚

å¦‚è‹¥ä½¿ç”¨äº‘æœåŠ¡çš„è¯ï¼Œæ¨èåœ¨åˆ›å»ºçŸ¥è¯†åº“çš„æ—¶å€™å¼€å¯æ™ºèƒ½åˆ‡åˆ†ï¼Œè¿™æ˜¯å¹³å°ç»è¿‡å¤§é‡è¯„ä¼°ä¹‹åçš„æ¨èç­–ç•¥ã€‚

![image-20250619001849407](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250619001849407.png)

é‡‡ç”¨æ™ºèƒ½åˆ‡åˆ†ç­–ç•¥æ—¶ï¼ŒçŸ¥è¯†åº“å°±ä¼šï¼š

- é¦–å…ˆåˆ©ç”¨ç³»ç»Ÿå†…ç½®çš„åˆ†å±…æ ‡è¯†ç¬¦æ–‡æ¡£åˆ’åˆ†ä¸ºè‹¥å¹²æ®µè½
- åŸºäºåˆ’åˆ†çš„æ®µè½ï¼Œæ ¹æ®è¯­ä¹‰ç›¸å…³æ€§è‡ªé€‚åº”é€‰æ‹©åˆ‡ç‰‡ç‚¹è¿›è¡Œåˆ‡åˆ†ï¼Œå¹¶éå›ºå®šé•¿åº¦åˆ‡åˆ†

##### 3ã€å…ƒæ•°æ®æ ‡æ³¨

å¯ä»¥ä¸ºæ–‡æ¡£æ·»åŠ ä¸°å¯Œçš„ç»“æ„åŒ–ä¿¡æ¯ï¼Œä¿—ç§°å…ƒä¿¡æ¯ï¼Œå½¢æˆå¤šç»´ç´¢å¼•ï¼Œä¾¿äºåç»­å‘é‡åŒ–å¤„ç†å’Œç²¾å‡†æ£€ç´¢ã€‚

åœ¨å®ç°ä¸­ï¼Œå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼ä¸ºæ–‡æ¡£æ·»åŠ å…ƒæ•°æ®ã€‚

**æ‰‹åŠ¨æ·»åŠ å…ƒä¿¡æ¯**

```java
documents.add(new Document("æ¡ˆä¾‹ç¼–å·ï¼š*********"
                          + "é¡¹ç›®æ¦‚è¿°ï¼š180å¹³ç±³å¤§å¹³å±‚ç°ä»£ç®€çº¦é£æ ¼å®¢å…æ”¹é€ ") 
             + "è®¾è®¡è¦ç‚¹ï¼š	\n" + 
"1. é‡‡ç”¨5.2ç±³æŒ‘é«˜çš„è½åœ°çª—ï¼Œæœ€å¤§åŒ–è‡ªç„¶é‡‡å…‰ \n"
             + "2. ä¸»è‰²è°ƒï¼šç™½é‡‘é»‘ï¼ˆæ›å…‰ã€NCS S0500-Né…åˆè“è‰²ï¼‰" 
             + "3. å®¶å…·é€‰æ‹©ï¼šçº¢æœ¨å®¶å…·" 
             + "ç©ºé—´æ•ˆæœï¼šé€šé€å¤§æ°”ï¼Œé€‚åˆå•†åŠ¡æ¥å¾…å’Œå®¶åº­æ—¥å¸¸èšé¤", 
             Map.of(
             	"type": "interior", // æ–‡æ¡£ç±»å‹
               "year": "2025", // å¹´ä»½
               "month": "05", //æœˆä»½
               "style": "modern" // è£…ä¿®é£æ ¼
             )) 
```



**åˆ©ç”¨DocumentReaderæ‰¹é‡æ·»åŠ å…ƒä¿¡æ¯**

æˆ‘ä»¬å¯ä»¥åœ¨åŠ è½½æ–‡æ¡£çš„æ—¶å€™ä¸ºæ¯ä¸€ç¯‡æ–‡ç« æ·»åŠ ç‰¹å®šæ ‡ç­¾ï¼Œæ¯”å¦‚ï¼šâ€œæ‹çˆ±çŠ¶æ€â€

```java
// æå–æ–‡æ¡£å€’æ•°ç¬¬ 3 å’Œç¬¬ 2 ä¸ªå­—ä½œä¸ºæ ‡ç­¾
String status = fileName.substring(fileName.length() - 6, fileName.length() - 4);
MarkdownDocumentReaderConfig config = MarkdownDocumentReaderConfig.builder()
        .withHorizontalRuleCreateDocument(true)
        .withIncludeCodeBlock(false)
        .withIncludeBlockquote(false)
        .withAdditionalMetadata("filename", fileName)
        .withAdditionalMetadata("status", status)
        .build();
```



æ¯”å¦‚ï¼š

![image-20250619003247447](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250619003247447.png)

**è‡ªåŠ¨æ·»åŠ å…ƒä¿¡æ¯**

Spring AI æä¾›äº†ç”Ÿæˆä¿¡æ¯çš„[Transformerç»„ä»¶](https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_keywordmetadataenricher)ï¼Œå¯ä»¥åŸºäºAIè‡ªåŠ¨è§£æå…³é”®è¯å¹¶æ·»åŠ åˆ°å…ƒä¿¡æ¯ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Component
public class MyKeywordEnricher {
    private final ChatModel chatModel;

    public MyKeywordEnricher(ChatModel chatModel) {
        this.chatModel = chatModel;
    }

    List<Document> enrichDocuments(List<Document> documents) {
        KeywordMetadataEnricher enricher = new KeywordMetadataEnricher(this.chatModel, 5);
        return enricher.apply(documents);
    }
}
```

åœ¨äº‘æœåŠ¡å¹³å°ä¸­ï¼Œå¦‚é˜¿é‡Œäº‘ç™¾ç‚¼ï¼ŒåŒæ ·æ”¯æŒå…ƒæ•°æ®å’Œæ ‡ç­¾åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡å¹³å°APIæˆ–ç•Œé¢è®¾ç½®æ ‡ç­¾ï¼Œä»¥åŠé€šè¿‡æ ‡ç­¾å®ç°å¿«é€Ÿè¿‡æ»¤ï¼š

![image-20250619004044675](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250619004044675.png)

#### å‘é‡è½¬æ¢å’Œå­˜å‚¨

##### å‘é‡å­˜å‚¨é…ç½®

éœ€è¦æ ¹æ®è´¹ç”¨æˆæœ¬ã€æ•°æ®è§„æ¨¡ã€æ€§èƒ½ã€å¼€å‘æˆæœ¬æ¥é€‰æ‹©å‘é‡å­˜å‚¨æ–¹æ¡ˆï¼Œæ¯”å¦‚Redisã€MongoDB

å®ç°æ–¹å¼ï¼š

```java
SimpleVectorStore vectorStore = SimpleVectorStore.builder(embeddingModel).build();
```

äº‘å¹³å°ä¸­ï¼Œé€šå¸¸æä¾›äº†å¤šç§å­˜å‚¨é€‰é¡¹ï¼Œæ¯”å¦‚å†…ç½®çš„å‘é‡å­˜å‚¨æˆ–äº‘æ•°æ®åº“ã€‚

![image-20250619005010097](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250619005010097.png)

##### é€‰æ‹©åˆé€‚çš„EmbeddingModel

é€šå¸¸äº‘å¹³å°çš„è¯ä¹Ÿæ˜¯å¯ä»¥é€‰æ‹©æ¨¡å‹çš„ï¼š

![image-20250619005158541](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250619005158541.png)

#### æ–‡æ¡£è¿‡æ»¤å’Œæ£€ç´¢

##### å¤šæŸ¥è¯¢æ‰©å±•

åœ¨å¤šè½®å¯¹è¯çš„åœºæ™¯ä¸‹ï¼Œç”¨æˆ·è¾“å…¥çš„æç¤ºè¯å¯èƒ½ä¸å®Œæ•´ï¼Œå­˜åœ¨æ­§ä¹‰ã€‚å¤šæŸ¥è¯¢æ‰©å±•æŠ€æœ¯å¯ä»¥æ‰©å¤§æ£€ç´¢èŒƒå›´ï¼Œæé«˜ç›¸å…³æ–‡æ¡£çš„å¬å›ç‡ã€‚

ä½¿ç”¨å¤šæŸ¥è¯¢æ‰©å±•æ—¶ï¼Œéœ€è¦æ³¨æ„ï¼š

- è®¾ç½®åˆé€‚çš„æŸ¥è¯¢æ•°é‡ï¼ˆ3-5ä¸ªï¼‰ï¼Œè¿‡å¤šä¼šå½±å“æ€§èƒ½ï¼Œå¢åŠ æˆæœ¬
- ä¿ç•™åŸå§‹æŸ¥è¯¢çš„æ ¸å¿ƒè¯­ä¹‰

åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç å®ç°å¤šæŸ¥è¯¢æ‰©å±•ï¼š

```java
 MultiQueryExpander queryExpander = MultiQueryExpander.builder()
                .chatClientBuilder(chatClientBuilder)
                .numberOfQueries(3)
                .build();
List<Query> queries = queryExpander.expand(new Query("è°æ˜¯å”æœæç™½å•Š?"));
```

è·å¾—æ‰©å±•æŸ¥è¯¢ä¹‹åï¼Œå¯ä»¥ç›´æ¥ç”¨äºæ£€ç´¢æ–‡æ¡£ã€æˆ–è€…æå–æŸ¥è¯¢æ–‡æœ¬æ¥æ”¹å†™æç¤ºè¯ï¼š

```java
DocumentRetriever retriever = VectorStoreDocumentRetriever.builder()
    .vectorStore(vectorStore)
    .similarityThreshold(0.73)
    .topK(5)
    .filterExpression(new FilterExpressionBuilder()
        .eq("genre", "fairytale")
        .build())
    .build();
// ç›´æ¥ç”¨æ‰©å±•åçš„æŸ¥è¯¢æ¥è·å–æ–‡æ¡£
List<Document> retrievedDocuments = documentRetriever.retrieve(query);
// è¾“å‡ºæ‰©å±•åçš„æŸ¥è¯¢æ–‡æœ¬
System.out.println(query.text());
```

å¤šæŸ¥è¯¢æ‰©å±•çš„å®Œæ•´ä½¿ç”¨æµç¨‹ï¼š

1. ä½¿ç”¨æ‰©å±•åçš„æŸ¥è¯¢å¬å›æ–‡æ¡£ï¼šéå†æ‰©å±•åçš„æŸ¥è¯¢åˆ—è¡¨ï¼Œå¯¹æ¯ä¸€ä¸ªæŸ¥è¯¢ä½¿ç”¨`DocumentRetriver`æ¥å¬å›ç›¸å…³æ–‡æ¡£ã€‚
2. æ•´åˆå¬å›æ–‡æ¡£ï¼šå°†æ¯ä¸ªæŸ¥è¯¢å¬å›çš„æ–‡æ¡£è¿›è¡Œæ•´åˆï¼Œå½¢æˆä¸€ä¸ªåŒ…å«æ‰€æœ‰ç›¸å…³ä¿¡æ¯çš„æ–‡æ¡£é›†åˆã€‚
3. ä½¿ç”¨å¬å›çš„æ–‡æ¡£æ”¹å†™`Prompt`ï¼šå°†æ•´åˆåçš„æ–‡æ¡£å†…å®¹æ·»åŠ åˆ°åŸå§‹`Prompt`ä¸­ï¼Œæ‰€ä»¥ä¸ªäººå»ºè®®æ…ç”¨è¿™ç§æ–¹å¼ã€‚

##### æŸ¥è¯¢é‡å†™å’Œç¿»è¯‘

æŸ¥è¯¢é‡å†™å’Œç¿»è¯‘å¯ä»¥ä½¿æŸ¥è¯¢æ›´åŠ å‡†ç¡®å’Œä¸“ä¸šï¼Œä½†æ˜¯è¦æ³¨æ„ä¿æŒæŸ¥è¯¢è¯­ä¹‰çš„å®Œæ•´æ€§ã€‚

ä¸»è¦åº”ç”¨æ˜¯ï¼š

- `RewriteQueryTransformer`ï¼šä¼˜åŒ–æŸ¥è¯¢ç»“æ„
- `TranslationQueryTransformer`ï¼šæ”¯æŒå¤šè¯­è¨€

å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://java2ai.com/docs/1.0.0-M6.1/tutorials/rag/#32-query-rewrite-%E6%9F%A5%E8%AF%A2%E9%87%8D%E5%86%99)å®ç°ä¸€ä¸‹æŸ¥è¯¢é‡å†™ï¼š

```java
@Component
public class MyRewriteQueryTransformer {

    // åˆ›å»ºæŸ¥è¯¢é‡å†™å™¨
    private final QueryTransformer queryTransformer;

    public MyRewriteQueryTransformer(ChatModel dashscopeChatModel) {
        ChatClient.Builder builder = ChatClient.builder(dashscopeChatModel);
        // åˆ›å»ºæŸ¥è¯¢é‡å†™å™¨
        queryTransformer = RewriteQueryTransformer.builder()
                .chatClientBuilder(builder)
                .build();
    }

    public String doQueryRewrite(String prompt) {
        Query query = new Query(prompt);
        // æ‰§è¡ŒæŸ¥è¯¢é‡å†™
        Query transformQuery = queryTransformer.transform(query);
        // è¾“å‡ºé‡å†™ä¹‹åçš„æŸ¥è¯¢
        return transformQuery.text();
    }
}
```

åº”ç”¨ä¸€ä¸‹çœ‹çœ‹æ•ˆæœï¼š

```java
@Resource
private MyRewriteQueryTransformer queryTransformer;    

public String doChatWithRAG(String message, String chatId) {
        // todo  æŸ¥è¯¢é‡å†™å™¨
        String rewriteMessage = queryTransformer.doQueryRewrite(message);
        ChatResponse chatResponse = chatClient.prompt()
                .user(rewriteMessage)
                .call()
                .chatResponse();
        String content = chatResponse.getResult().getOutput().getText();
        return content;
    }
```

è¿è¡Œæµ‹è¯•æ¡ˆä¾‹ï¼Œç»“æœå¦‚ä¸‹ï¼š

![image-20250619150701103](Ai è¶…çº§æ™ºèƒ½ä½“/image-20250619150701103.png)

å¾ˆæ¸…æ¥šçš„çœ‹åˆ°rewriteMessageä¸­çš„å†…å®¹æ˜¯ä¼˜åŒ–ä¹‹åçš„ã€‚åœ¨äº‘æœåŠ¡ä¸­ï¼Œå¯ä»¥å¼€å¯å¤šè½®ä¼šè¯æ”¹å†™åŠŸèƒ½ï¼Œè‡ªåŠ¨å°†ç”¨æˆ·çš„æç¤ºè¯è½¬æ¢æˆæ›´åŠ å®Œæ•´çš„å½¢å¼ï¼š

![image-20250619150859393](Ai è¶…çº§æ™ºèƒ½ä½“/image-20250619150859393.png)

##### æ£€ç´¢å™¨é…ç½®

æ£€ç´¢å™¨é…ç½®æ˜¯å½±å“æ£€ç´¢è´¨é‡çš„å…³é”®å› ç´ ï¼Œä¸»è¦åŒ…å«äº†ä¸‰ä¸ªæ–¹é¢ï¼šç›¸ä¼¼åº¦é˜ˆå€¼ã€è¿”å›æ–‡æ¡£æ•°é‡å’Œè¿‡æ»¤è§„åˆ™ã€‚

###### è®¾ç½®åˆç†çš„ç›¸ä¼¼åº¦é˜ˆå€¼

ç›¸ä¼¼åº¦é˜ˆå€¼æ§åˆ¶æ–‡æ¡£è¢«æ‰¾å›çš„æ ‡å‡†ï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„é—®é¢˜è°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼

| é—®é¢˜                                               | è§£å†³æ–¹æ¡ˆ                                                     |
| -------------------------------------------------- | ------------------------------------------------------------ |
| çŸ¥è¯†åº“çš„å¬å›ç»“æœä¸å®Œæ•´ï¼Œæ²¡æœ‰åŒ…å«å…¨éƒ¨ç›¸å…³çš„æ–‡æœ¬åˆ‡ç‰‡ | é™ä½ç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œæé«˜å¬å›ç‰‡æ®µæ•°ï¼Œä»¥å¬å›ä¸€äº›åŸæœ¬åº”è¢«æ£€ç´¢åˆ°çš„ä¿¡æ¯ |
| çŸ¥è¯†åº“çš„å¬å›ç»“æœä¸­åŒ…å«å¤§é‡æ— ç”¨çš„æ–‡æœ¬åˆ‡ç‰‡           | æé«˜é˜ˆå€¼ï¼Œæ’é™¤ä¸ç”¨æˆ·æç¤ºè¯ç›¸ä¼¼åº¦è¾ƒä½çš„ä¿¡æ¯                   |

```java
DocumentRetriever documentRetriever = VectorStoreDocumentRetriever.builder()
        .vectorStore(loveAppVectorStore)
        .similarityThreshold(0.5) // ç›¸ä¼¼åº¦é˜ˆå€¼
        .build();
```

ä¹Ÿå¯ä»¥åœ¨äº‘å¹³å°å¼€å¯ã€‚

![image-20250619151605394](Ai è¶…çº§æ™ºèƒ½ä½“/image-20250619151605394.png)

###### æ§åˆ¶è¿”å›æ–‡æ¡£æ•°é‡ï¼ˆå¬å›ç‰‡æ®µæ•°ï¼‰

æ§åˆ¶è¿”å›ç»™æ¨¡å‹çš„æ–‡æ¡£æ•°é‡ï¼Œå¹³è¡¡ä¿¡æ¯å®Œæ•´æ€§å’Œå™ªéŸ³æ°´å¹³ã€‚

```java
DocumentRetriever documentRetriever = VectorStoreDocumentRetriever.builder()
        .vectorStore(loveAppVectorStore)
        .similarityThreshold(0.5) // ç›¸ä¼¼åº¦é˜ˆå€¼
        .topK(3) // è¿”å›æ–‡æ¡£æ•°é‡
        .build();
```

é˜¿é‡Œäº‘ç™¾ç‚¼ä¸­ä¹Ÿæ˜¯åŒ…å«å¬å›çš„ç‰‡æ®µæ•°ï¼Œå‚è€ƒæ–‡æ¡£ï¼š[æé«˜å¬å›ç‰‡æ®µæ•°](https://help.aliyun.com/zh/model-studio/rag-optimization#a0086e42d9n12)éƒ¨åˆ†ã€‚

![image-20250619164337568](Ai è¶…çº§æ™ºèƒ½ä½“/image-20250619164337568-17503226189961.png)

æœ€ç»ˆä¼šé€‰å–ç›¸ä¼¼åº¦åˆ†æ•°æœ€é«˜çš„Kä¸ªæ–‡æœ¬åˆ‡ç‰‡ã€‚

åœ¨å¤šè·¯å¬å›çš„åœºæ™¯ä¸‹ï¼Œå¦‚æœåº”ç”¨å…³è”äº†å¤šä¸ªçŸ¥è¯†åº“ï¼Œç³»ç»Ÿä¼šä»è¿™äº›åº“ä¸­æ£€ç´¢ç›¸å…³æ–‡æœ¬åˆ‡ç‰‡ï¼Œé€šè¿‡é‡æ’åºï¼Œé€‰å‡ºæœ€ç›¸å…³çš„å‰Kæ¡æä¾›ç»™å¤§æ¨¡å‹å‚è€ƒã€‚

###### é…ç½®æ–‡æ¡£è¿‡æ»¤è§„åˆ™

é€šè¿‡æ–‡æ¡£è¿‡æ»¤è§„åˆ™å¯ä»¥æ§åˆ¶æŸ¥è¯¢èŒƒå›´ï¼Œæé«˜æ£€ç´¢ç²¾åº¦å’Œæ•ˆç‡ã€‚

| åœºæ™¯                                           | è§£å†³æ–¹æ¡ˆ                                                     |
| ---------------------------------------------- | ------------------------------------------------------------ |
| çŸ¥è¯†åº“ä¸­åŒ…å«äº†å¤šç§ç±»åˆ«çš„æ–‡æ¡£ï¼Œå¸Œæœ›é™å®šæ£€ç´¢èŒƒå›´ | ä¸ºæ–‡æ¡£æ·»åŠ æ ‡ç­¾ï¼ŒçŸ¥è¯†åº“æ£€ç´¢çš„æ—¶å€™ä¼šå…ˆæ ¹æ®æ ‡ç­¾ç­›é€‰ç›¸å…³æ–‡æ¡£     |
| çŸ¥è¯†åº“ä¸­æœ‰å¤šç¯‡ç»“æ„ç›¸ä¼¼çš„æ–‡æ¡£ï¼Œå¸Œæœ›ç²¾ç¡®ç¡®å®šä½   | æå–å…ƒæ•°æ®ï¼ŒçŸ¥è¯†åº“ä¼šå…ˆä½¿ç”¨å…ƒæ•°æ®è¿›è¡Œç»“æ„åŒ–æœç´¢ï¼Œå†è¿›è¡Œå‘é‡æ£€ç´¢ |

åœ¨å®ç°ä¸­ï¼Œä½¿ç”¨Spring AI å†…ç½®çš„æ–‡æ¡£æ£€ç´¢å™¨æä¾›çš„`FilterExpression`é…ç½®è¿‡æ»¤è§„åˆ™ã€‚

```java
@Slf4j
public class LoveAppRagCustomAdvisorFactory {
    public static Advisor createLoveAppRagCustomAdvisor(VectorStore vectorStore, String status) {
        Filter.Expression expression = new FilterExpressionBuilder()
                .eq("status", status)
                .build();
        DocumentRetriever documentRetriever = VectorStoreDocumentRetriever.builder()
                .vectorStore(vectorStore)
                .filterExpression(expression) // è¿‡æ»¤æ¡ä»¶
                .similarityThreshold(0.5) // ç›¸ä¼¼åº¦é˜ˆå€¼
                .topK(3) // è¿”å›æ–‡æ¡£æ•°é‡
                .build();
        return RetrievalAugmentationAdvisor.builder()
                .documentRetriever(documentRetriever)
                .build();
    }
}
```



ç»™æ‹çˆ±å¤§å¸ˆåº”ç”¨LoveAppçš„ChatClientå¯¹è±¡åº”ç”¨è¿™ä¸ªAdvisorã€‚

```java
chatClient.advisors(
    LoveAppRagCustomAdvisorFactory.createLoveAppRagCustomAdvisor(
        loveAppVectorStore, "å·²å©š"
    )
)
```

ä½¿ç”¨äº‘å¹³å°ï¼Œç›®å‰æ”¯æŒä»¥ä¸‹ä¸¤ç§æ–¹å¼ä½¿ç”¨æ ‡ç­¾æ¥å®ç°è¿‡æ»¤ï¼š

1. [é€šè¿‡äº‘ç™¾ç‚¼å¹³å°](https://help.aliyun.com/zh/model-studio/application-calling-guide#4100253b7chc3)æ—¶ï¼Œå¯ä»¥åœ¨è¯·æ±‚å‚æ•°`tag`ä¸­æŒ‡å®šæ ‡ç­¾ã€‚
2. åœ¨æ§åˆ¶å°ç¼–è¾‘åº”ç”¨æ—¶è®¾ç½®æ ‡ç­¾ï¼ˆæœ¬æ–¹å¼åªèƒ½é€‚ç”¨äº[æ™ºèƒ½ä½“åº”ç”¨](https://help.aliyun.com/zh/model-studio/single-agent-application)ï¼‰ã€‚

![image-20250619222137530](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250619222137530.png)

äº‘ç™¾ç‚¼è¿˜æ”¯æŒå…ƒæ•°æ®è¿‡æ»¤ï¼Œå¼€å¯ä¹‹åï¼ŒçŸ¥è¯†åº“ä¼šåœ¨å‘é‡æ£€ç´¢å‰å¢åŠ ä¸€å±‚ç»“æ„åŒ–æœç´¢ï¼š

1. ä»æç¤ºè¯æå–å…ƒæ•°æ®{key: "name", "value": "super idol"}
2. æ ¹æ®æå–çš„å…ƒæ•°æ®ï¼Œæ‰¾åˆ°æ‰€æœ‰åŒ…å«è¿™ä¸ªå…ƒæ•°æ®çš„æ–‡æœ¬åˆ‡ç‰‡
3. å†è¿›è¡Œå‘é‡ï¼ˆè¯­ä¹‰ï¼‰æ£€ç´¢ï¼Œæ‰¾åˆ°æœ€ç›¸å…³çš„æ–‡æœ¬åˆ‡ç‰‡

> æŒ‰ç…§ChatGPTæ¥è¯´çš„ï¼šæ‹¿åˆ°çš„å…ƒæ•°æ®æ˜¯ï¼š{source: product_doc, page = 3}ï¼Œæ‹¿ä¸€æœ¬ä¹¦æ¥è·ç¦»ï¼Œè¿™æœ¬ä¹¦æ˜¯ã€Šç»¿æ¥¼æ¢¦ã€‹sourceå°±æ˜¯è¿™æœ¬ä¹¦çš„å†…å®¹ï¼Œpageå°±æ˜¯å¯¹åº”çš„é¡µç ï¼Œèƒ½å¤Ÿæ‰¾åˆ°å…·ä½“çš„å†…å®¹ã€‚

é€šè¿‡APIè°ƒç”¨åº”ç”¨æ—¶ï¼Œå¯ä»¥åœ¨è¯·æ±‚å‚æ•°`metadata_filter`ä¸­æŒ‡å®šmetaDataï¼Œåº”ç”¨åœ¨æ£€ç´¢çŸ¥è¯†çš„æ—¶å€™ï¼Œä¼šå…ˆæ ¹æ®metaDataç­›é€‰ç›¸å…³æ–‡æ¡£ï¼Œå®ç°ç²¾å‡†è¿‡æ»¤ï¼Œ[å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://help.aliyun.com/zh/model-studio/application-calling-guide#6bd8094de7e1e)ã€‚

#### æŸ¥è¯¢å¢å¼ºå’Œå…³è”

å¤§æ¨¡å‹åœ¨è¿›è¡Œå‰é¢çš„æ–‡æ¡£æ£€ç´¢ï¼Œå¤§æ¨¡å‹éœ€è¦æ ¹æ®ç”¨æˆ·æç¤ºè¯å’Œæ£€ç´¢å†…å®¹ç”Ÿæˆæœ€ç»ˆçš„è¿”å›ç»“æœï¼Œä½†æ˜¯ï¼Œæ­¤æ—¶çš„è¿”å›ç»“æœå¾ˆå¯èƒ½ä»æœªè¾¾åˆ°é¢„æœŸï¼Œéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚

##### é”™è¯¯å¤„ç†æœºåˆ¶

å®é™…åº”ç”¨ä¸­ï¼Œå¯èƒ½å‡ºç°å¤šç§å¼‚å¸¸æƒ…å†µã€‚

å¼‚å¸¸å¤„ç†ä¸»è¦åŒ…æ‹¬ï¼š

1. å…è®¸ç©ºä¸Šä¸‹æ–‡æŸ¥è¯¢
2. æä¾›æœ‰å¥½çš„é”™è¯¯æç¤º
3. å¼•å¯¼ç”¨æˆ·æä¾›å¿…è¦ä¿¡æ¯

è¾¹ç•Œæƒ…å†µå¤„ç†å¯ä»¥ä½¿ç”¨Spring AI çš„ContextualQueryAugmenterä¸Šä¸‹æ–‡æŸ¥è¯¢å¢å¼ºå™¨ï¼š

```java
public class LoveAppContextualQueryAugmenterFactory {
    public static ContextualQueryAugmenter createInstance() {
        PromptTemplate promptTemplate = new PromptTemplate("ä½ åº”è¯¥è¾“å‡ºä»¥ä¸‹å†…å®¹ï¼š" +
                "æŠ±æ­‰ï¼Œæˆ‘åªèƒ½å›ç­”æ‹çˆ±ç›¸å…³çš„é—®é¢˜ï¼Œåˆ«çš„é—®é¢˜æ²¡æœ‰åŠæ³•å¸®åŠ©åˆ°ä½ å‘¢ï¼Ÿ" +
                "æœ‰é—®é¢˜çš„è¯è¯·è”ç³»ï¼šå¼ å¾·å½ª");
        return ContextualQueryAugmenter.builder()
                .allowEmptyContext(false)
                .emptyContextPromptTemplate(promptTemplate)
                .build();
    }
}
```

å¦‚æœä¸ä½¿ç”¨è‡ªå®šä¹‰çš„å¤„ç†å™¨ï¼Œæˆ–è€…æ²¡æœ‰â€œå…è®¸ç©ºä¸Šä¸‹æ–‡â€é€‰é¡¹ï¼Œä¼šé»˜è®¤æ”¹å†™ç”¨æˆ·æŸ¥è¯¢çš„userTextã€‚

```txt
The user query is outside your knowledge base.
Politely inform the user that you can't answer it.
```

å¦‚æœå¼€å¯äº†å…è®¸ç©ºä¸Šä¸‹æ–‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ç©ºPromptï¼Œä¸ä¼šæ”¹å†™ç”¨æˆ·è¾“å…¥ï¼Œä½¿ç”¨çš„æ˜¯åŸæœ¬çš„æŸ¥è¯¢ã€‚

![image-20250619233426019](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250619233426019.png)

ä¸Šé¢æˆ‘ä»¬å·²ç»å®šä¹‰äº†è‡ªå®šä¹‰çš„å¤„ç†ç©ºPromptçš„æƒ…å†µï¼Œç»™æ£€ç´¢å¢å¼ºå™¨æ–°å¢è‡ªå®šä¹‰çš„`ContextualQueryAugment`ã€‚

```java
return RetrievalAugmentationAdvisor.builder()
                .documentRetriever(documentRetriver)
                .queryAugmenter(LoveAppContextualQueryAugmenterFactory.createInstance())
                .build();
```

ç³»ç»Ÿæ‰¾ä¸åˆ°ç›¸å…³æ–‡æ¡£çš„æ—¶å€™ï¼Œå°±ä¼šè¿”å›æˆ‘ä»¬çš„è‡ªå®šä¹‰çš„å‹å¥½æç¤ºï¼š

![image-20250619233647311](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250619233647311.png)

##### å…¶ä»–å»ºè®®

| é—®é¢˜ç±»å‹                                           | æ”¹è¿›ç­–ç•¥                               |
| -------------------------------------------------- | -------------------------------------- |
| å¤§æ¨¡å‹å¹¶æœªç†è§£çŸ¥è¯†å’Œç”¨æˆ·æç¤ºè¯ä¹‹é—´çš„å…³ç³»ï¼Œç­”æ¡ˆç”Ÿç¡¬ | é€‰æ‹©åˆé€‚çš„å¤§æ¨¡å‹ï¼Œæå‡è¯­ä¹‰ç†è§£èƒ½åŠ›     |
| è¿”å›ç»“æœæ²¡æœ‰æŒ‰ç…§è¦æ±‚ï¼Œä¸å¤Ÿå…¨é¢                     | ä¼˜åŒ–æç¤ºè¯æ¨¡æ¿                         |
| è¿”å›ç»“æœä¸ç²¾ç¡®ï¼Œæ··å…¥äº†æ¨¡å‹è‡ªèº«çš„é€šç”¨çŸ¥è¯†           | å¼€å¯æ‹’è¯†åŠŸèƒ½ï¼Œé™åˆ¶æ¨¡å‹ä¹‹åŸºäºçŸ¥è¯†åº“å›ç­” |
| ç›¸ä¼¼æç¤ºè¯ï¼Œå¸Œæœ›æ§åˆ¶å›ç­”çš„ä¸€è‡´æ€§æˆ–å¤šæ ·æ€§           | å»ºè®®è°ƒæ•´å¤§æ¨¡å‹å‚æ•°ï¼Œå¦‚æ¸©åº¦å€¼ç­‰         |

### æ‰©å±•çŸ¥è¯†-RAGé«˜çº§

#### æ··åˆæ£€ç´¢ç­–ç•¥

åœ¨RAGç³»ç»Ÿä¸­ï¼Œæ£€ç´¢è´¨é‡ç›´æ¥å†³å®šäº†æœ€ç»ˆå›ç­”çš„å¥½åã€‚

ä¸åŒçš„æ£€ç´¢æ–¹æ³•åå„æœ‰ä¼˜ç¼ºç‚¹ï¼šå‘é‡æ£€ç´¢è™½ç„¶èƒ½ç†è§£è¯­ä¹‰ï¼Œæ•è·æ–‡æœ¬é—´çš„æ¦‚å¿µå…³è”ï¼Œä½†æ˜¯å¯¹å…³é”®è¯ä¸æ•æ„Ÿã€‚æ¯”å¦‚ï¼Œå½“ç”¨æˆ·æœç´¢ï¼šâ€œæ€ä¹ˆå­¦ç¼–ç¨‹ï¼Ÿâ€œæ—¶ï¼Œå‘é‡æ£€ç´¢å¯èƒ½ä¼šè¿”å›ä¸ç¼–ç¨‹ç›¸å…³æœ¯è¯­è§£é‡Šï¼Œè€Œä¸æ˜¯å‡†ç¡®é”å®šæ€ä¹ˆå­¦ä¹ ç¼–ç¨‹çš„å­¦ä¹ è·¯çº¿ã€‚

ç›¸åï¼ŒåŸºäºå€’æ’ç´¢å¼•çš„å…¨æ–‡æ£€ç´¢åœ¨ç²¾ç¡®åŒ¹é…å…³é”®è¯æ–¹é¢è¡¨ç°å‡ºè‰²ï¼Œä½†æ˜¯ä¸ç†è§£è¯­ä¹‰ï¼Œéš¾ä»¥å¤„ç†åŒä¹‰è¯æˆ–æ¦‚å¿µæ€§æŸ¥è¯¢ã€‚

ç»“æ„åŒ–æ£€ç´¢æ”¯æŒç²¾ç¡®è¿‡æ»¤å’Œå¤æ‚æ¡ä»¶ç»„åˆï¼Œä½†æ˜¯ä¾èµ–è‰¯å¥½çš„å…ƒæ•°æ®ã€‚è€ŒçŸ¥è¯†å›¾è°±èƒ½å‘ç°å®ä½“é—´éšå«å…³ç³»ï¼Œé€‚åˆå›ç­”å¤æ‚é—®é¢˜ï¼Œä½†æ˜¯æ„å»ºæˆæœ¬æ¯”è¾ƒé«˜ã€‚

ä¸»è¦æ£€ç´¢æ–¹æ³•æ¯”è¾ƒï¼š

| æ£€ç´¢æ–¹æ³•     | åŸç†                       | ä¼˜åŠ¿                         | åŠ£åŠ¿                         |
| ------------ | -------------------------- | ---------------------------- | ---------------------------- |
| å‘é‡æ£€ç´¢     | åŸºäºåµŒå…¥å‘é‡ç›¸ä¼¼åº¦æœç´¢     | ç†è§£è¯­ä¹‰å…³è”ï¼Œé€‚åˆæ¦‚å¿µæ€§æŸ¥è¯¢ | å¯¹å…³é”®è¯ä¸æ•æ„Ÿï¼Œå¬å›ä¸å‡†ç¡®   |
| å…¨æ–‡æ£€ç´¢     | åŸºäºå€’æ’ç´¢å¼•ï¼ŒåŒ¹é…å…³é”®è¯   | ç²¾ç¡®åŒ¹é…å…³é”®è¯ï¼Œé«˜å¬å›ç‡     | ä¸ç†è§£è¯­ä¹‰ï¼ŒåŒä¹‰è¯éš¾ä»¥åŒ¹é…   |
| ç»“æ„åŒ–æ£€ç´¢   | åŸºäºå…ƒæ•°æ®æˆ–ç»“æ„åŒ–å­—æ®µæŸ¥è¯¢ | ç²¾ç¡®æŸ¥è¯¢ï¼Œæ”¯æŒå¤æ‚æ¡ä»¶ç»„åˆ   | ä¾èµ–è‰¯å¥½çš„å…ƒæ•°æ®ï¼Œçµæ´»æ€§æœ‰é™ |
| çŸ¥è¯†å›¾è°±æ£€ç´¢ | åˆ©ç”¨å®ä½“é—´å…³ç³»è¿›è¡Œå›¾éå†   | å‘ç°éšå«å…³ç³»ï¼Œå›ç­”å¤æ‚é—®é¢˜   | æ„å»ºæˆæœ¬é«˜ï¼Œéœ€è¦ä¸“ä¸šçŸ¥è¯†     |

å…¨æ–‡æ£€ç´¢éœ€è¦åˆ©ç”¨ESæ¥å®ç°ã€‚

ä½¿ç”¨å•ä¸€çš„æ£€ç´¢æ–¹å¼å¾€å¾€å¾ˆéš¾æ»¡è¶³éœ€æ±‚ï¼Œé‡‡ç”¨**æ··åˆæ£€ç´¢ç­–ç•¥**ã€‚

ä¸»è¦æœ‰ä¸‰ç§å®ç°æ–¹å¼ï¼š

##### 1ã€å¹¶è¡Œæ··åˆæ£€ç´¢

åŒæ—¶ä½¿ç”¨å¤šç§æ£€ç´¢æ–¹æ³•è·å–ç»“æœï¼Œç„¶åä½¿ç”¨é‡æ’æ¨¡å‹èåˆé€‚åˆæ¥æºç»“æœã€‚

![image-20250620002044932](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250620002044932.png)

##### 2ã€çº§è”æ··åˆæ£€ç´¢

å±‚å±‚ç­›é€‰ï¼Œå…ˆä½¿ç”¨ä¸€ç§æ–¹æ³•è¿›è¡Œå¹¿æ³›å¬å›ï¼Œåœ¨ä½¿ç”¨å¦ä¸€ç§æ–¹æ³•è¿›è¡Œç²¾å‡†è¿‡æ»¤ã€‚

æ¯”å¦‚å…ˆç”¨å‘é‡æ£€ç´¢è·å–è¯­ä¹‰ç›¸ä¼¼æ–‡æ¡£ï¼Œå†ç”¨å…³é”®è¯è¿‡æ»¤ï¼Œæœ€åç”¨å…ƒæ•°æ®è¿›ä¸€æ­¥ç­›é€‰ï¼Œé€æ­¥ç¼©å°èŒƒå›´ã€‚

![image-20250620002301787](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250620002301787.png)

##### 3ã€åŠ¨æ€æ··åˆæ£€ç´¢

é€šè¿‡ä¸€ä¸ªâ€è·¯ç”±å™¨â€œï¼Œæ ¹æ®æŸ¥è¯¢ç±»å‹è‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„æ£€ç´¢æ–¹æ³•ï¼Œæ›´åŠ æ™ºèƒ½ã€‚

![image-20250620002422862](images/Ai è¶…çº§æ™ºèƒ½ä½“/image-20250620002422862.png)

æ¯”å¦‚åœ¨AIå¤§æ¨¡å‹å¼€å‘å¹³å°Difyä¸­ï¼Œä¸ºç”¨æˆ·æä¾›äº†â€åŸºäºå…¨æ–‡æ£€ç´¢çš„å…³é”®è¯æœç´  + åŸºäºå‘é‡æ£€ç´¢çš„è¯­ä¹‰æ£€ç´¢â€œ çš„æ··åˆæ£€ç´¢ç­–ç•¥ï¼Œç”¨æˆ·è¿˜å¯ä»¥è‡ªå·±è®¾ç½®ä¸åŒæ£€ç´¢æ–¹å¼çš„æƒé‡ã€‚

#### å¤§æ¨¡å‹å¹»è§‰

å¤§æ¨¡å‹æœ‰æ—¶ä¼šè‡ªä¿¡æ»¡æ»¡çš„èƒ¡è¯´å…«é“ã€‚

å¤§æ¨¡å‹å¹»è§‰æŒ‡çš„æ˜¯æ¨¡å‹ç”Ÿæˆçœ‹ä¼¼åˆç†å®é™…ä¸Šä¸å‡†ç¡®æˆ–è™šæ„çš„å†…å®¹ã€‚ä¸»è¦äº§ç”Ÿçš„ä¸‰ç§è¡¨ç°å½¢å¼ï¼š

1. äº‹å®æ€§å¹»è§‰ï¼šç”Ÿæˆä¸äº‹å®ä¸ç¬¦çš„å†…å®¹ï¼ˆå¦‚é”™è¯¯çš„æ—¥æœŸã€ä»»åŠ¡å…³ç³»ç­‰ï¼‰ã€‚æ¯”å¦‚ï¼šâ€æ¢å¿—è¶…å‘æ˜äº†ç”µç¯æ³¡â€œ
2. é€»è¾‘æ€§å¹»è§‰ï¼šæ¨ç†è¿‡ç¨‹å‡ºç°é—®é¢˜ï¼Œå¾—åˆ°ä¸åˆç†çš„ç»“è®ºã€‚æ¯”å¦‚ï¼š1 + 1  = 3
3. è‡ªæ´½å¼å¹»è§‰ï¼šç”Ÿæˆçš„å†…å®¹æœ¬èº«çŸ›ç›¾ï¼Œæ¯”å¦‚ï¼Œâ€æ¢å¿—è¶…ä»–å¥¶å¥¶æ˜¯ç”·çš„â€œ

ä¸ºä»€ä¹ˆä¼šå‡ºç°å¹»è§‰å‘¢ï¼ŸåŸå› æœ¬èº«å¾ˆå¤æ‚ã€‚ä¸€æ–¹é¢ï¼Œæ¨¡å‹è®­ç»ƒçš„æ—¶å€™å¯èƒ½åŒ…å«é”™è¯¯ä¿¡æ¯æˆ–è¿‡æ—¶ä¿¡æ¯ï¼›å¦ä¸€æ–¹é¢ï¼Œå¤§è¯­è¨€æ¨¡å‹æœ¬è´¨ä¸Šæ˜¯ï¼š**é¢„æµ‹ä¸‹ä¸€ä¸ªè¯çš„æ¦‚ç‡**æ¨¡å‹ï¼Œä»–ä»¬å€¾å‘äºç”Ÿæˆæµç•…è€Œæœªå¿…å‡†ç¡®çš„å†…å®¹ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæ¨¡å‹å¹¶ä¸æ˜¯çœŸæ­£çŸ¥é“ä»€ä¹ˆï¼ŒçŸ¥è¯†å­¦ä¼šäº†æ–‡æœ¬çš„ç»Ÿè®¡æ¨¡å¼ã€‚











